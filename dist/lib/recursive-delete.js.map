{"version":3,"sources":["../../lib/recursive-delete.ts"],"sourcesContent":["import { Dirent, promises } from 'fs'\nimport { join, isAbsolute, dirname } from 'path'\nimport { promisify } from 'util'\nimport isError from './is-error'\n\nconst sleep = promisify(setTimeout)\n\nconst unlinkPath = async (p: string, isDir = false, t = 1): Promise<void> => {\n  try {\n    if (isDir) {\n      await promises.rmdir(p)\n    } else {\n      await promises.unlink(p)\n    }\n  } catch (e) {\n    const code = isError(e) && e.code\n    if (\n      (code === 'EBUSY' ||\n        code === 'ENOTEMPTY' ||\n        code === 'EPERM' ||\n        code === 'EMFILE') &&\n      t < 3\n    ) {\n      await sleep(t * 100)\n      return unlinkPath(p, isDir, t++)\n    }\n\n    if (code === 'ENOENT') {\n      return\n    }\n\n    throw e\n  }\n}\n\n/**\n * Recursively delete directory contents\n * @param  {string} dir Directory to delete the contents of\n * @param  {RegExp} [exclude] Exclude based on relative file path\n * @param  {string} [previousPath] Ensures that parameter dir exists, this is not passed recursively\n * @returns Promise void\n */\nexport async function recursiveDelete(\n  dir: string,\n  exclude?: RegExp,\n  previousPath: string = ''\n): Promise<void> {\n  let result\n  try {\n    result = await promises.readdir(dir, { withFileTypes: true })\n  } catch (e) {\n    if (isError(e) && e.code === 'ENOENT') {\n      return\n    }\n    throw e\n  }\n\n  await Promise.all(\n    result.map(async (part: Dirent) => {\n      const absolutePath = join(dir, part.name)\n\n      // readdir does not follow symbolic links\n      // if part is a symbolic link, follow it using stat\n      let isDirectory = part.isDirectory()\n      const isSymlink = part.isSymbolicLink()\n\n      if (isSymlink) {\n        const linkPath = await promises.readlink(absolutePath)\n\n        try {\n          const stats = await promises.stat(\n            isAbsolute(linkPath)\n              ? linkPath\n              : join(dirname(absolutePath), linkPath)\n          )\n          isDirectory = stats.isDirectory()\n        } catch (_) {}\n      }\n\n      const pp = join(previousPath, part.name)\n      const isNotExcluded = !exclude || !exclude.test(pp)\n\n      if (isNotExcluded) {\n        if (isDirectory) {\n          await recursiveDelete(absolutePath, exclude, pp)\n        }\n        return unlinkPath(absolutePath, !isSymlink && isDirectory)\n      }\n    })\n  )\n}\n"],"names":["recursiveDelete","sleep","setTimeout","unlinkPath","p","isDir","t","rmdir","unlink","e","code","dir","exclude","previousPath","result","readdir","withFileTypes","Promise","all","map","part","absolutePath","name","isDirectory","isSymlink","isSymbolicLink","linkPath","readlink","stats","stat","_","pp","isNotExcluded","test"],"mappings":"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"}