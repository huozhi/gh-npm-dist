{"version":3,"sources":["../../lib/verifyAndLint.ts"],"sourcesContent":["import chalk from 'next/dist/compiled/chalk'\nimport { Worker } from 'next/dist/compiled/jest-worker'\nimport { existsSync } from 'fs'\nimport { join } from 'path'\nimport { ESLINT_DEFAULT_DIRS } from './constants'\nimport { Telemetry } from '../telemetry/storage'\nimport { eventLintCheckCompleted } from '../telemetry/events'\nimport { CompileError } from './compile-error'\nimport isError from './is-error'\n\nexport async function verifyAndLint(\n  dir: string,\n  cacheLocation: string,\n  configLintDirs: string[] | undefined,\n  numWorkers: number | undefined,\n  enableWorkerThreads: boolean | undefined,\n  telemetry: Telemetry\n): Promise<void> {\n  try {\n    const lintWorkers = new Worker(require.resolve('./eslint/runLintCheck'), {\n      numWorkers,\n      enableWorkerThreads,\n    }) as Worker & {\n      runLintCheck: typeof import('./eslint/runLintCheck').runLintCheck\n    }\n\n    lintWorkers.getStdout().pipe(process.stdout)\n    lintWorkers.getStderr().pipe(process.stderr)\n\n    const lintDirs = (configLintDirs ?? ESLINT_DEFAULT_DIRS).reduce(\n      (res: string[], d: string) => {\n        const currDir = join(dir, d)\n        if (!existsSync(currDir)) return res\n        res.push(currDir)\n        return res\n      },\n      []\n    )\n\n    const lintResults = await lintWorkers.runLintCheck(dir, lintDirs, true, {\n      cacheLocation,\n    })\n    const lintOutput =\n      typeof lintResults === 'string' ? lintResults : lintResults?.output\n\n    if (typeof lintResults !== 'string' && lintResults?.eventInfo) {\n      telemetry.record(\n        eventLintCheckCompleted({\n          ...lintResults.eventInfo,\n          buildLint: true,\n        })\n      )\n    }\n\n    if (typeof lintResults !== 'string' && lintResults?.isError && lintOutput) {\n      await telemetry.flush()\n      throw new CompileError(lintOutput)\n    }\n\n    if (lintOutput) {\n      console.log(lintOutput)\n    }\n\n    lintWorkers.end()\n  } catch (err) {\n    if (isError(err)) {\n      if (err.type === 'CompileError' || err instanceof CompileError) {\n        console.error(chalk.red('\\nFailed to compile.'))\n        console.error(err.message)\n        process.exit(1)\n      } else if (err.type === 'FatalError') {\n        console.error(err.message)\n        process.exit(1)\n      }\n    }\n    throw err\n  }\n}\n"],"names":["verifyAndLint","dir","cacheLocation","configLintDirs","numWorkers","enableWorkerThreads","telemetry","lintWorkers","require","resolve","getStdout","pipe","process","stdout","getStderr","stderr","lintDirs","reduce","res","d","currDir","push","lintResults","runLintCheck","lintOutput","output","eventInfo","record","buildLint","isError","flush","console","log","end","err","type","error","red","message","exit"],"mappings":"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"}