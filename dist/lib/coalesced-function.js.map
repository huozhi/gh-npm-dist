{"version":3,"sources":["../../lib/coalesced-function.ts"],"sourcesContent":["type CoalescedInvoke<T> = {\n  isOrigin: boolean\n  value: T\n}\n\nexport type UnwrapPromise<T> = T extends Promise<infer U> ? U : T\n\nconst globalInvokeCache = new Map<string, Promise<CoalescedInvoke<unknown>>>()\n\nexport function withCoalescedInvoke<F extends (...args: any) => any>(\n  func: F\n): (\n  key: string,\n  args: Parameters<F>\n) => Promise<CoalescedInvoke<UnwrapPromise<ReturnType<F>>>> {\n  return async function (key: string, args: Parameters<F>) {\n    const entry = globalInvokeCache.get(key)\n    if (entry) {\n      return entry.then((res) => ({\n        isOrigin: false,\n        value: res.value as UnwrapPromise<ReturnType<F>>,\n      }))\n    }\n\n    async function __wrapper() {\n      return await func.apply(undefined, args)\n    }\n\n    const future = __wrapper()\n      .then((res) => {\n        globalInvokeCache.delete(key)\n        return { isOrigin: true, value: res as UnwrapPromise<ReturnType<F>> }\n      })\n      .catch((err) => {\n        globalInvokeCache.delete(key)\n        return Promise.reject(err)\n      })\n    globalInvokeCache.set(key, future)\n    return future\n  }\n}\n"],"names":["withCoalescedInvoke","globalInvokeCache","Map","func","key","args","entry","get","then","res","isOrigin","value","__wrapper","apply","undefined","future","delete","catch","err","Promise","reject","set"],"mappings":";;;;QASgBA,mBAAmB,GAAnBA,mBAAmB;AAFnC,KAAK,CAACC,iBAAiB,GAAG,GAAG,CAACC,GAAG;SAEjBF,mBAAmB,CACjCG,IAAO,EAImD,CAAC;IAC3D,MAAM,gBAAiBC,GAAW,EAAEC,IAAmB,EAAE,CAAC;QACxD,KAAK,CAACC,KAAK,GAAGL,iBAAiB,CAACM,GAAG,CAACH,GAAG;QACvC,EAAE,EAAEE,KAAK,EAAE,CAAC;YACV,MAAM,CAACA,KAAK,CAACE,IAAI,EAAEC,GAAG,IAAM,CAAC;oBAC3BC,QAAQ,EAAE,KAAK;oBACfC,KAAK,EAAEF,GAAG,CAACE,KAAK;gBAClB,CAAC;;QACH,CAAC;uBAEcC,SAAS,GAAG,CAAC;YAC1B,MAAM,CAAC,KAAK,CAACT,IAAI,CAACU,KAAK,CAACC,SAAS,EAAET,IAAI;QACzC,CAAC;QAED,KAAK,CAACU,MAAM,GAAGH,SAAS,GACrBJ,IAAI,EAAEC,GAAG,GAAK,CAAC;YACdR,iBAAiB,CAACe,MAAM,CAACZ,GAAG;YAC5B,MAAM,CAAC,CAAC;gBAACM,QAAQ,EAAE,IAAI;gBAAEC,KAAK,EAAEF,GAAG;YAAiC,CAAC;QACvE,CAAC,EACAQ,KAAK,EAAEC,GAAG,GAAK,CAAC;YACfjB,iBAAiB,CAACe,MAAM,CAACZ,GAAG;YAC5B,MAAM,CAACe,OAAO,CAACC,MAAM,CAACF,GAAG;QAC3B,CAAC;QACHjB,iBAAiB,CAACoB,GAAG,CAACjB,GAAG,EAAEW,MAAM;QACjC,MAAM,CAACA,MAAM;IACf,CAAC;AACH,CAAC"}