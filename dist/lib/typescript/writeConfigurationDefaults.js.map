{"version":3,"sources":["../../../lib/typescript/writeConfigurationDefaults.ts"],"sourcesContent":["import { promises as fs } from 'fs'\nimport chalk from 'next/dist/compiled/chalk'\nimport * as CommentJson from 'next/dist/compiled/comment-json'\nimport semver from 'next/dist/compiled/semver'\nimport os from 'os'\nimport { getTypeScriptConfiguration } from './getTypeScriptConfiguration'\n\ntype DesiredCompilerOptionsShape = {\n  [key: string]:\n    | { suggested: any }\n    | {\n        parsedValue?: any\n        parsedValues?: Array<any>\n        value: any\n        reason: string\n      }\n}\n\nfunction getDesiredCompilerOptions(\n  ts: typeof import('typescript')\n): DesiredCompilerOptionsShape {\n  const o: DesiredCompilerOptionsShape = {\n    // These are suggested values and will be set when not present in the\n    // tsconfig.json\n    target: { suggested: 'es5' },\n    lib: { suggested: ['dom', 'dom.iterable', 'esnext'] },\n    allowJs: { suggested: true },\n    skipLibCheck: { suggested: true },\n    strict: { suggested: false },\n    forceConsistentCasingInFileNames: { suggested: true },\n    noEmit: { suggested: true },\n    ...(semver.gte(ts.version, '4.4.2')\n      ? { incremental: { suggested: true } }\n      : undefined),\n\n    // These values are required and cannot be changed by the user\n    // Keep this in sync with the webpack config\n    // 'parsedValue' matches the output value from ts.parseJsonConfigFileContent()\n    esModuleInterop: {\n      value: true,\n      reason: 'requirement for SWC / babel',\n    },\n    module: {\n      parsedValue: ts.ModuleKind.ESNext,\n      // All of these values work:\n      parsedValues: [\n        ts.ModuleKind.ES2020,\n        ts.ModuleKind.ESNext,\n        ts.ModuleKind.CommonJS,\n        ts.ModuleKind.AMD,\n      ],\n      value: 'esnext',\n      reason: 'for dynamic import() support',\n    },\n    moduleResolution: {\n      parsedValue: ts.ModuleResolutionKind.NodeJs,\n      value: 'node',\n      reason: 'to match webpack resolution',\n    },\n    resolveJsonModule: { value: true, reason: 'to match webpack resolution' },\n    isolatedModules: {\n      value: true,\n      reason: 'requirement for SWC / Babel',\n    },\n    jsx: {\n      parsedValue: ts.JsxEmit.Preserve,\n      value: 'preserve',\n      reason: 'next.js implements its own optimized jsx transform',\n    },\n  }\n\n  return o\n}\n\nexport function getRequiredConfiguration(\n  ts: typeof import('typescript')\n): Partial<import('typescript').CompilerOptions> {\n  const res: Partial<import('typescript').CompilerOptions> = {}\n\n  const desiredCompilerOptions = getDesiredCompilerOptions(ts)\n  for (const optionKey of Object.keys(desiredCompilerOptions)) {\n    const ev = desiredCompilerOptions[optionKey]\n    if (!('value' in ev)) {\n      continue\n    }\n    res[optionKey] = ev.parsedValue ?? ev.value\n  }\n\n  return res\n}\n\nexport async function writeConfigurationDefaults(\n  ts: typeof import('typescript'),\n  tsConfigPath: string,\n  isFirstTimeSetup: boolean\n): Promise<void> {\n  if (isFirstTimeSetup) {\n    await fs.writeFile(tsConfigPath, '{}' + os.EOL)\n  }\n\n  const desiredCompilerOptions = getDesiredCompilerOptions(ts)\n  const { options: tsOptions, raw: rawConfig } =\n    await getTypeScriptConfiguration(ts, tsConfigPath, true)\n\n  const userTsConfigContent = await fs.readFile(tsConfigPath, {\n    encoding: 'utf8',\n  })\n  const userTsConfig = CommentJson.parse(userTsConfigContent)\n  if (userTsConfig.compilerOptions == null && !('extends' in rawConfig)) {\n    userTsConfig.compilerOptions = {}\n    isFirstTimeSetup = true\n  }\n\n  const suggestedActions: string[] = []\n  const requiredActions: string[] = []\n  for (const optionKey of Object.keys(desiredCompilerOptions)) {\n    const check = desiredCompilerOptions[optionKey]\n    if ('suggested' in check) {\n      if (!(optionKey in tsOptions)) {\n        if (!userTsConfig.compilerOptions) {\n          userTsConfig.compilerOptions = {}\n        }\n        userTsConfig.compilerOptions[optionKey] = check.suggested\n        suggestedActions.push(\n          chalk.cyan(optionKey) + ' was set to ' + chalk.bold(check.suggested)\n        )\n      }\n    } else if ('value' in check) {\n      const ev = tsOptions[optionKey]\n      if (\n        !('parsedValues' in check\n          ? check.parsedValues?.includes(ev)\n          : 'parsedValue' in check\n          ? check.parsedValue === ev\n          : check.value === ev)\n      ) {\n        if (!userTsConfig.compilerOptions) {\n          userTsConfig.compilerOptions = {}\n        }\n        userTsConfig.compilerOptions[optionKey] = check.value\n        requiredActions.push(\n          chalk.cyan(optionKey) +\n            ' was set to ' +\n            chalk.bold(check.value) +\n            ` (${check.reason})`\n        )\n      }\n    } else {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const _: never = check\n    }\n  }\n\n  if (!('include' in rawConfig)) {\n    userTsConfig.include = ['next-env.d.ts', '**/*.ts', '**/*.tsx']\n    suggestedActions.push(\n      chalk.cyan('include') +\n        ' was set to ' +\n        chalk.bold(`['next-env.d.ts', '**/*.ts', '**/*.tsx']`)\n    )\n  }\n\n  if (!('exclude' in rawConfig)) {\n    userTsConfig.exclude = ['node_modules']\n    suggestedActions.push(\n      chalk.cyan('exclude') + ' was set to ' + chalk.bold(`['node_modules']`)\n    )\n  }\n\n  if (suggestedActions.length < 1 && requiredActions.length < 1) {\n    return\n  }\n\n  await fs.writeFile(\n    tsConfigPath,\n    CommentJson.stringify(userTsConfig, null, 2) + os.EOL\n  )\n\n  if (isFirstTimeSetup) {\n    console.log(\n      chalk.green(\n        `We detected TypeScript in your project and created a ${chalk.bold(\n          'tsconfig.json'\n        )} file for you.`\n      ) + '\\n'\n    )\n    return\n  }\n\n  console.log(\n    chalk.green(\n      `We detected TypeScript in your project and reconfigured your ${chalk.bold(\n        'tsconfig.json'\n      )} file for you. Strict-mode is set to ${chalk.bold('false')} by default.`\n    ) + '\\n'\n  )\n  if (suggestedActions.length) {\n    console.log(\n      `The following suggested values were added to your ${chalk.cyan(\n        'tsconfig.json'\n      )}. These values ${chalk.bold(\n        'can be changed'\n      )} to fit your project's needs:\\n`\n    )\n\n    suggestedActions.forEach((action) => console.log(`\\t- ${action}`))\n\n    console.log('')\n  }\n\n  if (requiredActions.length) {\n    console.log(\n      `The following ${chalk.bold(\n        'mandatory changes'\n      )} were made to your ${chalk.cyan('tsconfig.json')}:\\n`\n    )\n\n    requiredActions.forEach((action) => console.log(`\\t- ${action}`))\n\n    console.log('')\n  }\n}\n"],"names":["getRequiredConfiguration","writeConfigurationDefaults","CommentJson","getDesiredCompilerOptions","ts","o","target","suggested","lib","allowJs","skipLibCheck","strict","forceConsistentCasingInFileNames","noEmit","gte","version","incremental","undefined","esModuleInterop","value","reason","module","parsedValue","ModuleKind","ESNext","parsedValues","ES2020","CommonJS","AMD","moduleResolution","ModuleResolutionKind","NodeJs","resolveJsonModule","isolatedModules","jsx","JsxEmit","Preserve","res","desiredCompilerOptions","optionKey","Object","keys","ev","tsConfigPath","isFirstTimeSetup","writeFile","EOL","options","tsOptions","raw","rawConfig","userTsConfigContent","readFile","encoding","userTsConfig","parse","compilerOptions","suggestedActions","requiredActions","check","push","cyan","bold","includes","_","include","exclude","length","stringify","console","log","green","forEach","action"],"mappings":"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"}