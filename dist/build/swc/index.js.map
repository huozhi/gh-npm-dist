{"version":3,"sources":["../../../build/swc/index.js"],"sourcesContent":["import { platform, arch } from 'os'\nimport { platformArchTriples } from 'next/dist/compiled/@napi-rs/triples'\nimport * as Log from '../output/log'\n\nconst ArchName = arch()\nconst PlatformName = platform()\nconst triples = platformArchTriples[PlatformName][ArchName] || []\n\nlet nativeBindings\nlet wasmBindings\n\nasync function loadBindings() {\n  let attempts = []\n  try {\n    return loadNative()\n  } catch (a) {\n    attempts = attempts.concat(a)\n  }\n\n  try {\n    let bindings = await loadWasm()\n    return bindings\n  } catch (a) {\n    attempts = attempts.concat(a)\n  }\n\n  logLoadFailure(attempts)\n}\n\nfunction loadBindingsSync() {\n  let attempts = []\n  try {\n    return loadNative()\n  } catch (a) {\n    attempts = attempts.concat(a)\n  }\n\n  logLoadFailure(attempts)\n}\n\nfunction logLoadFailure(attempts) {\n  for (let attempt of attempts) {\n    Log.info(attempt)\n  }\n\n  Log.error(\n    `Failed to load SWC binary for ${PlatformName}/${ArchName}, see more info here: https://nextjs.org/docs/messages/failed-loading-swc`\n  )\n  process.exit(1)\n}\n\nasync function loadWasm() {\n  if (wasmBindings) {\n    return wasmBindings\n  }\n\n  let attempts = []\n  for (let pkg of ['@next/swc-wasm-nodejs', '@next/swc-wasm-web']) {\n    try {\n      let bindings = await import(pkg)\n      if (pkg === '@next/swc-wasm-web') {\n        bindings = await bindings.default()\n      }\n      Log.info('Using experimental wasm build of next-swc')\n      wasmBindings = {\n        isWasm: true,\n        transform(src, options) {\n          return Promise.resolve(\n            bindings.transformSync(src.toString(), options)\n          )\n        },\n        minify(src, options) {\n          return Promise.resolve(bindings.minifySync(src.toString(), options))\n        },\n        parse(src, options) {\n          return Promise.resolve(bindings.parse(src.toString(), options))\n        },\n      }\n      return wasmBindings\n    } catch (e) {\n      // Do not report attempts to load wasm when it is still experimental\n      // if (e?.code === 'ERR_MODULE_NOT_FOUND') {\n      //   attempts.push(`Attempted to load ${pkg}, but it was not installed`)\n      // } else {\n      //   attempts.push(\n      //     `Attempted to load ${pkg}, but an error occurred: ${e.message ?? e}`\n      //   )\n      // }\n    }\n  }\n\n  throw attempts\n}\n\nfunction loadNative() {\n  if (nativeBindings) {\n    return nativeBindings\n  }\n\n  let bindings\n  let attempts = []\n\n  for (const triple of triples) {\n    try {\n      bindings = require(`@next/swc/native/next-swc.${triple.platformArchABI}.node`)\n      Log.info('Using locally built binary of @next/swc')\n      break\n    } catch (e) {}\n  }\n\n  if (!bindings) {\n    for (const triple of triples) {\n      let pkg = `@next/swc-${triple.platformArchABI}`\n      try {\n        bindings = require(pkg)\n        break\n      } catch (e) {\n        if (e?.code === 'MODULE_NOT_FOUND') {\n          attempts.push(`Attempted to load ${pkg}, but it was not installed`)\n        } else {\n          attempts.push(\n            `Attempted to load ${pkg}, but an error occurred: ${e.message ?? e}`\n          )\n        }\n      }\n    }\n  }\n\n  if (bindings) {\n    nativeBindings = {\n      isWasm: false,\n      transform(src, options) {\n        const isModule =\n          typeof src !== undefined &&\n          typeof src !== 'string' &&\n          !Buffer.isBuffer(src)\n        options = options || {}\n\n        if (options?.jsc?.parser) {\n          options.jsc.parser.syntax = options.jsc.parser.syntax ?? 'ecmascript'\n        }\n\n        return bindings.transform(\n          isModule ? JSON.stringify(src) : src,\n          isModule,\n          toBuffer(options)\n        )\n      },\n\n      transformSync(src, options) {\n        if (typeof src === undefined) {\n          throw new Error(\n            \"transformSync doesn't implement reading the file from filesystem\"\n          )\n        } else if (Buffer.isBuffer(src)) {\n          throw new Error(\n            \"transformSync doesn't implement taking the source code as Buffer\"\n          )\n        }\n        const isModule = typeof src !== 'string'\n        options = options || {}\n\n        if (options?.jsc?.parser) {\n          options.jsc.parser.syntax = options.jsc.parser.syntax ?? 'ecmascript'\n        }\n\n        return bindings.transformSync(\n          isModule ? JSON.stringify(src) : src,\n          isModule,\n          toBuffer(options)\n        )\n      },\n\n      minify(src, options) {\n        return bindings.minify(toBuffer(src), toBuffer(options ?? {}))\n      },\n\n      minifySync(src, options) {\n        return bindings.minifySync(toBuffer(src), toBuffer(options ?? {}))\n      },\n\n      bundle(options) {\n        return bindings.bundle(toBuffer(options))\n      },\n\n      parse(src, options) {\n        return bindings.parse(src, toBuffer(options ?? {}))\n      },\n    }\n    return nativeBindings\n  }\n\n  throw attempts\n}\n\nfunction toBuffer(t) {\n  return Buffer.from(JSON.stringify(t))\n}\n\nexport async function isWasm() {\n  let bindings = await loadBindings()\n  return bindings.isWasm\n}\n\nexport async function transform(src, options) {\n  let bindings = await loadBindings()\n  return bindings.transform(src, options)\n}\n\nexport function transformSync(src, options) {\n  let bindings = loadBindingsSync()\n  return bindings.transformSync(src, options)\n}\n\nexport async function minify(src, options) {\n  let bindings = await loadBindings()\n  return bindings.minify(src, options)\n}\n\nexport function minifySync(src, options) {\n  let bindings = loadBindingsSync()\n  return bindings.minifySync(src, options)\n}\n\nexport async function bundle(options) {\n  let bindings = loadBindingsSync()\n  return bindings.bundle(toBuffer(options))\n}\n\nexport async function parse(src, options) {\n  let bindings = loadBindingsSync()\n  return bindings.parse(src, options).then((astStr) => JSON.parse(astStr))\n}\n"],"names":["isWasm","transform","transformSync","minify","minifySync","bundle","parse","Log","ArchName","PlatformName","triples","nativeBindings","wasmBindings","loadBindings","attempts","loadNative","a","concat","bindings","loadWasm","logLoadFailure","loadBindingsSync","attempt","info","error","process","exit","pkg","default","src","options","Promise","resolve","toString","e","triple","require","platformArchABI","code","push","message","isModule","undefined","Buffer","isBuffer","jsc","parser","syntax","JSON","stringify","toBuffer","Error","t","from","then","astStr"],"mappings":"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"}