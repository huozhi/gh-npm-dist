{"version":3,"sources":["../../../build/output/store.ts"],"sourcesContent":["import createStore from 'next/dist/compiled/unistore'\nimport stripAnsi from 'next/dist/compiled/strip-ansi'\nimport { flushAllTraces } from '../../trace'\nimport { getUnresolvedModuleFromError } from '../utils'\n\nimport * as Log from './log'\n\nexport type OutputState =\n  | { bootstrap: true; appUrl: string | null; bindAddr: string | null }\n  | ({ bootstrap: false; appUrl: string | null; bindAddr: string | null } & (\n      | {\n          loading: true\n          trigger: string | undefined\n        }\n      | {\n          loading: false\n          typeChecking: boolean\n          partial: 'client and server' | undefined\n          modules: number\n          errors: string[] | null\n          warnings: string[] | null\n          hasServerWeb: boolean\n        }\n    ))\n\nexport const store = createStore<OutputState>({\n  appUrl: null,\n  bindAddr: null,\n  bootstrap: true,\n})\n\nlet lastStore: OutputState = { appUrl: null, bindAddr: null, bootstrap: true }\nfunction hasStoreChanged(nextStore: OutputState) {\n  if (\n    (\n      [\n        ...new Set([...Object.keys(lastStore), ...Object.keys(nextStore)]),\n      ] as Array<keyof OutputState>\n    ).every((key) => Object.is(lastStore[key], nextStore[key]))\n  ) {\n    return false\n  }\n\n  lastStore = nextStore\n  return true\n}\n\nlet startTime = 0\n\nstore.subscribe((state) => {\n  if (!hasStoreChanged(state)) {\n    return\n  }\n\n  if (state.bootstrap) {\n    if (state.appUrl) {\n      Log.ready(`started server on ${state.bindAddr}, url: ${state.appUrl}`)\n    }\n    return\n  }\n\n  if (state.loading) {\n    if (state.trigger) {\n      if (state.trigger !== 'initial') {\n        Log.wait(`compiling ${state.trigger}...`)\n      }\n    } else {\n      Log.wait('compiling...')\n    }\n    if (startTime === 0) {\n      startTime = Date.now()\n    }\n    return\n  }\n\n  if (state.errors) {\n    Log.error(state.errors[0])\n\n    const cleanError = stripAnsi(state.errors[0])\n    if (cleanError.indexOf('SyntaxError') > -1) {\n      const matches = cleanError.match(/\\[.*\\]=/)\n      if (matches) {\n        for (const match of matches) {\n          const prop = (match.split(']').shift() || '').substr(1)\n          console.log(\n            `AMP bind syntax [${prop}]='' is not supported in JSX, use 'data-amp-bind-${prop}' instead. https://nextjs.org/docs/messages/amp-bind-jsx-alt`\n          )\n        }\n        return\n      }\n    }\n\n    const moduleName = getUnresolvedModuleFromError(cleanError)\n    if (state.hasServerWeb && moduleName) {\n      console.error(\n        `Native Node.js APIs are not supported in the Edge Runtime with \\`concurrentFeatures\\` enabled. Found \\`${moduleName}\\` imported.\\n`\n      )\n      return\n    }\n\n    // Ensure traces are flushed after each compile in development mode\n    flushAllTraces()\n    return\n  }\n\n  let timeMessage = ''\n  if (startTime) {\n    const time = Date.now() - startTime\n    startTime = 0\n\n    timeMessage =\n      time > 2000 ? ` in ${Math.round(time / 100) / 10}s` : ` in ${time} ms`\n  }\n\n  let modulesMessage = ''\n  if (state.modules) {\n    modulesMessage = ` (${state.modules} modules)`\n  }\n\n  let partialMessage = ''\n  if (state.partial) {\n    partialMessage = ` ${state.partial}`\n  }\n\n  if (state.warnings) {\n    Log.warn(state.warnings.join('\\n\\n'))\n    // Ensure traces are flushed after each compile in development mode\n    flushAllTraces()\n    return\n  }\n\n  if (state.typeChecking) {\n    Log.info(\n      `bundled${partialMessage} successfully${timeMessage}${modulesMessage}, waiting for typecheck results...`\n    )\n    return\n  }\n\n  Log.event(\n    `compiled${partialMessage} successfully${timeMessage}${modulesMessage}`\n  )\n  // Ensure traces are flushed after each compile in development mode\n  flushAllTraces()\n})\n"],"names":["Log","store","appUrl","bindAddr","bootstrap","lastStore","hasStoreChanged","nextStore","Set","Object","keys","every","key","is","startTime","subscribe","state","ready","loading","trigger","wait","Date","now","errors","error","cleanError","indexOf","matches","match","prop","split","shift","substr","console","log","moduleName","hasServerWeb","timeMessage","time","Math","round","modulesMessage","modules","partialMessage","partial","warnings","warn","join","typeChecking","info","event"],"mappings":"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"}