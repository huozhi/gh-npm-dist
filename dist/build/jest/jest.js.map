{"version":3,"sources":["../../../build/jest/jest.ts"],"sourcesContent":["import { loadEnvConfig } from '@next/env'\nimport { resolve, join } from 'path'\nimport loadConfig from '../../server/config'\nimport { PHASE_TEST } from '../../shared/lib/constants'\nimport loadJsConfig from '../load-jsconfig'\nimport * as Log from '../output/log'\n\nasync function getConfig(dir: string) {\n  const conf = await loadConfig(PHASE_TEST, dir)\n  return conf\n}\n\n/**\n * Loads closest package.json in the directory hierarchy\n */\nfunction loadClosestPackageJson(dir: string, attempts = 1): any {\n  if (attempts > 5) {\n    throw new Error(\"Can't resolve main package.json file\")\n  }\n  var mainPath = attempts === 1 ? './' : Array(attempts).join('../')\n  try {\n    return require(join(dir, mainPath + 'package.json'))\n  } catch (e) {\n    return loadClosestPackageJson(dir, attempts + 1)\n  }\n}\n\nconsole.warn(\n  '\"next/jest\" is currently experimental. https://nextjs.org/docs/messages/experimental-jest-transformer'\n)\n\n/*\n// Usage in jest.config.js\nconst nextJest = require('next/jest');\n\n// Optionally provide path to Next.js app which will enable loading next.config.js and .env files\nconst createJestConfig = nextJest({ dir })\n\n// Any custom config you want to pass to Jest\nconst customJestConfig = {\n    setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],\n}\n\n// createJestConfig is exported in this way to ensure that next/jest can load the Next.js config which is async\nmodule.exports = createJestConfig(customJestConfig)\n*/\nexport default function nextJest(options: { dir?: string } = {}) {\n  // createJestConfig\n  return (customJestConfig?: any) => {\n    // Function that is provided as the module.exports of jest.config.js\n    // Will be called and awaited by Jest\n    return async () => {\n      let nextConfig\n      let jsConfig\n      let resolvedBaseUrl\n      let isEsmProject = false\n      if (options.dir) {\n        const resolvedDir = resolve(options.dir)\n        const packageConfig = loadClosestPackageJson(resolvedDir)\n        isEsmProject = packageConfig.type === 'module'\n\n        nextConfig = await getConfig(resolvedDir)\n        loadEnvConfig(resolvedDir, false, Log)\n        // TODO: revisit when bug in SWC is fixed that strips `.css`\n        const result = await loadJsConfig(resolvedDir, nextConfig)\n        jsConfig = result.jsConfig\n        resolvedBaseUrl = result.resolvedBaseUrl\n      }\n      // Ensure provided async config is supported\n      const resolvedJestConfig =\n        (typeof customJestConfig === 'function'\n          ? await customJestConfig()\n          : customJestConfig) ?? {}\n\n      return {\n        ...resolvedJestConfig,\n\n        moduleNameMapper: {\n          // Handle CSS imports (with CSS modules)\n          // https://jestjs.io/docs/webpack#mocking-css-modules\n          '^.+\\\\.module\\\\.(css|sass|scss)$':\n            require.resolve('./object-proxy.js'),\n\n          // Handle CSS imports (without CSS modules)\n          '^.+\\\\.(css|sass|scss)$': require.resolve('./__mocks__/styleMock.js'),\n\n          // Handle image imports\n          '^.+\\\\.(jpg|jpeg|png|gif|webp|avif|svg)$': require.resolve(\n            `./__mocks__/fileMock.js`\n          ),\n\n          // Custom config will be able to override the default mappings\n          ...(resolvedJestConfig.moduleNameMapper || {}),\n        },\n        testPathIgnorePatterns: [\n          // Don't look for tests in node_modules\n          '/node_modules/',\n          // Don't look for tests in the Next.js build output\n          '/.next/',\n          // Custom config can append to testPathIgnorePatterns but not modify it\n          // This is to ensure `.next` and `node_modules` are always excluded\n          ...(resolvedJestConfig.testPathIgnorePatterns || []),\n        ],\n\n        transform: {\n          // Use SWC to compile tests\n          '^.+\\\\.(js|jsx|ts|tsx)$': [\n            require.resolve('../swc/jest-transformer'),\n            {\n              nextConfig,\n              jsConfig,\n              resolvedBaseUrl,\n              isEsmProject,\n            },\n          ],\n          // Allow for appending/overriding the default transforms\n          ...(resolvedJestConfig.transform || {}),\n        },\n\n        transformIgnorePatterns: [\n          // To match Next.js behavior node_modules is not transformed\n          '/node_modules/',\n          // CSS modules are mocked so they don't need to be transformed\n          '^.+\\\\.module\\\\.(css|sass|scss)$',\n\n          // Custom config can append to transformIgnorePatterns but not modify it\n          // This is to ensure `node_modules` and .module.css/sass/scss are always excluded\n          ...(resolvedJestConfig.transformIgnorePatterns || []),\n        ],\n        watchPathIgnorePatterns: [\n          // Don't re-run tests when the Next.js build output changes\n          '/.next/',\n          ...(resolvedJestConfig.watchPathIgnorePatterns || []),\n        ],\n      }\n    }\n  }\n}\n"],"names":["nextJest","Log","getConfig","dir","conf","loadClosestPackageJson","attempts","Error","mainPath","Array","join","require","e","console","warn","options","customJestConfig","nextConfig","jsConfig","resolvedBaseUrl","isEsmProject","resolvedDir","packageConfig","type","result","resolvedJestConfig","moduleNameMapper","resolve","testPathIgnorePatterns","transform","transformIgnorePatterns","watchPathIgnorePatterns"],"mappings":"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"}