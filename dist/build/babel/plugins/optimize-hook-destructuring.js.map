{"version":3,"sources":["../../../../build/babel/plugins/optimize-hook-destructuring.ts"],"sourcesContent":["import {\n  NodePath,\n  PluginObj,\n  types as BabelTypes,\n} from 'next/dist/compiled/babel/core'\n\n// matches any hook-like (the default)\nconst isHook = /^use[A-Z]/\n\n// matches only built-in hooks provided by React et al\nconst isBuiltInHook =\n  /^use(Callback|Context|DebugValue|Effect|ImperativeHandle|LayoutEffect|Memo|Reducer|Ref|State)$/\n\nexport default function ({\n  types: t,\n}: {\n  types: typeof BabelTypes\n}): PluginObj<any> {\n  const visitor = {\n    CallExpression(path: NodePath<BabelTypes.CallExpression>, state: any) {\n      const onlyBuiltIns = state.opts.onlyBuiltIns\n\n      // if specified, options.lib is a list of libraries that provide hook functions\n      const libs =\n        state.opts.lib &&\n        (state.opts.lib === true\n          ? ['react', 'preact/hooks']\n          : [].concat(state.opts.lib))\n\n      // skip function calls that are not the init of a variable declaration:\n      if (!t.isVariableDeclarator(path.parent)) return\n\n      // skip function calls where the return value is not Array-destructured:\n      if (!t.isArrayPattern(path.parent.id)) return\n\n      // name of the (hook) function being called:\n      const hookName = (path.node.callee as BabelTypes.Identifier).name\n\n      if (libs) {\n        const binding = path.scope.getBinding(hookName)\n        // not an import\n        if (!binding || binding.kind !== 'module') return\n\n        const specifier = (binding.path.parent as BabelTypes.ImportDeclaration)\n          .source.value\n        // not a match\n        if (!libs.some((lib: any) => lib === specifier)) return\n      }\n\n      // only match function calls with names that look like a hook\n      if (!(onlyBuiltIns ? isBuiltInHook : isHook).test(hookName)) return\n\n      path.parent.id = t.objectPattern(\n        path.parent.id.elements.reduce<Array<BabelTypes.ObjectProperty>>(\n          (patterns, element, i) => {\n            if (element === null) {\n              return patterns\n            }\n\n            return patterns.concat(\n              t.objectProperty(t.numericLiteral(i), element)\n            )\n          },\n          []\n        )\n      )\n    },\n  }\n\n  return {\n    name: 'optimize-hook-destructuring',\n    visitor: {\n      // this is a workaround to run before preset-env destroys destructured assignments\n      Program(path, state) {\n        path.traverse(visitor, state)\n      },\n    },\n  }\n}\n"],"names":["isHook","isBuiltInHook","types","t","visitor","CallExpression","path","state","onlyBuiltIns","opts","libs","lib","concat","isVariableDeclarator","parent","isArrayPattern","id","hookName","node","callee","name","binding","scope","getBinding","kind","specifier","source","value","some","test","objectPattern","elements","reduce","patterns","element","i","objectProperty","numericLiteral","Program","traverse"],"mappings":";;;;;AAMA,EAAsC,AAAtC,oCAAsC;AACtC,KAAK,CAACA,MAAM;AAEZ,EAAsD,AAAtD,oDAAsD;AACtD,KAAK,CAACC,aAAa;kBAGM,CAAC,CACxBC,KAAK,EAAEC,CAAC,EAGV,CAAC,EAAkB,CAAC;IAClB,KAAK,CAACC,OAAO,GAAG,CAAC;QACfC,cAAc,EAACC,IAAyC,EAAEC,KAAU,EAAE,CAAC;YACrE,KAAK,CAACC,YAAY,GAAGD,KAAK,CAACE,IAAI,CAACD,YAAY;YAE5C,EAA+E,AAA/E,6EAA+E;YAC/E,KAAK,CAACE,IAAI,GACRH,KAAK,CAACE,IAAI,CAACE,GAAG,KACbJ,KAAK,CAACE,IAAI,CAACE,GAAG,KAAK,IAAI,GACpB,CAAC;gBAAA,CAAO;gBAAE,CAAc;YAAA,CAAC,GACzB,CAAC,CAAC,CAACC,MAAM,CAACL,KAAK,CAACE,IAAI,CAACE,GAAG;YAE9B,EAAuE,AAAvE,qEAAuE;YACvE,EAAE,GAAGR,CAAC,CAACU,oBAAoB,CAACP,IAAI,CAACQ,MAAM,GAAG,MAAM;YAEhD,EAAwE,AAAxE,sEAAwE;YACxE,EAAE,GAAGX,CAAC,CAACY,cAAc,CAACT,IAAI,CAACQ,MAAM,CAACE,EAAE,GAAG,MAAM;YAE7C,EAA4C,AAA5C,0CAA4C;YAC5C,KAAK,CAACC,QAAQ,GAAIX,IAAI,CAACY,IAAI,CAACC,MAAM,CAA2BC,IAAI;YAEjE,EAAE,EAAEV,IAAI,EAAE,CAAC;gBACT,KAAK,CAACW,OAAO,GAAGf,IAAI,CAACgB,KAAK,CAACC,UAAU,CAACN,QAAQ;gBAC9C,EAAgB,AAAhB,cAAgB;gBAChB,EAAE,GAAGI,OAAO,IAAIA,OAAO,CAACG,IAAI,KAAK,CAAQ,SAAE,MAAM;gBAEjD,KAAK,CAACC,SAAS,GAAIJ,OAAO,CAACf,IAAI,CAACQ,MAAM,CACnCY,MAAM,CAACC,KAAK;gBACf,EAAc,AAAd,YAAc;gBACd,EAAE,GAAGjB,IAAI,CAACkB,IAAI,EAAEjB,GAAQ,GAAKA,GAAG,KAAKc,SAAS;mBAAG,MAAM;YACzD,CAAC;YAED,EAA6D,AAA7D,2DAA6D;YAC7D,EAAE,IAAIjB,YAAY,GAAGP,aAAa,GAAGD,MAAM,EAAE6B,IAAI,CAACZ,QAAQ,GAAG,MAAM;YAEnEX,IAAI,CAACQ,MAAM,CAACE,EAAE,GAAGb,CAAC,CAAC2B,aAAa,CAC9BxB,IAAI,CAACQ,MAAM,CAACE,EAAE,CAACe,QAAQ,CAACC,MAAM,EAC3BC,QAAQ,EAAEC,OAAO,EAAEC,CAAC,GAAK,CAAC;gBACzB,EAAE,EAAED,OAAO,KAAK,IAAI,EAAE,CAAC;oBACrB,MAAM,CAACD,QAAQ;gBACjB,CAAC;gBAED,MAAM,CAACA,QAAQ,CAACrB,MAAM,CACpBT,CAAC,CAACiC,cAAc,CAACjC,CAAC,CAACkC,cAAc,CAACF,CAAC,GAAGD,OAAO;YAEjD,CAAC,EACD,CAAC,CAAC;QAGR,CAAC;IACH,CAAC;IAED,MAAM,CAAC,CAAC;QACNd,IAAI,EAAE,CAA6B;QACnChB,OAAO,EAAE,CAAC;YACR,EAAkF,AAAlF,gFAAkF;YAClFkC,OAAO,EAAChC,IAAI,EAAEC,KAAK,EAAE,CAAC;gBACpBD,IAAI,CAACiC,QAAQ,CAACnC,OAAO,EAAEG,KAAK;YAC9B,CAAC;QACH,CAAC;IACH,CAAC;AACH,CAAC"}