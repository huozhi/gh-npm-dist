{"version":3,"sources":["../../../../../../build/webpack/config/blocks/css/plugins.ts"],"sourcesContent":["import chalk from 'next/dist/compiled/chalk'\nimport { findConfig } from '../../../../../lib/find-config'\n\ntype CssPluginCollection_Array = (string | [string, boolean | object])[]\n\ntype CssPluginCollection_Object = { [key: string]: object | boolean }\n\ntype CssPluginCollection =\n  | CssPluginCollection_Array\n  | CssPluginCollection_Object\n\ntype CssPluginShape = [string, object | boolean]\n\nconst genericErrorText = 'Malformed PostCSS Configuration'\n\nfunction getError_NullConfig(pluginName: string) {\n  return `${chalk.red.bold(\n    'Error'\n  )}: Your PostCSS configuration for '${pluginName}' cannot have ${chalk.bold(\n    'null'\n  )} configuration.\\nTo disable '${pluginName}', pass ${chalk.bold(\n    'false'\n  )}, otherwise, pass ${chalk.bold('true')} or a configuration object.`\n}\n\nfunction isIgnoredPlugin(pluginPath: string): boolean {\n  const ignoredRegex =\n    /(?:^|[\\\\/])(postcss-modules-values|postcss-modules-scope|postcss-modules-extract-imports|postcss-modules-local-by-default|postcss-modules)(?:[\\\\/]|$)/i\n  const match = ignoredRegex.exec(pluginPath)\n  if (match == null) {\n    return false\n  }\n\n  const plugin = match.pop()!\n  console.warn(\n    `${chalk.yellow.bold('Warning')}: Please remove the ${chalk.underline(\n      plugin\n    )} plugin from your PostCSS configuration. ` +\n      `This plugin is automatically configured by Next.js.\\n` +\n      'Read more: https://nextjs.org/docs/messages/postcss-ignored-plugin'\n  )\n  return true\n}\n\nconst createLazyPostCssPlugin = (\n  fn: () => import('postcss').AcceptedPlugin\n): import('postcss').AcceptedPlugin => {\n  let result: any = undefined\n  const plugin = (...args: any[]) => {\n    if (result === undefined) result = fn() as any\n    if (result.postcss === true) {\n      return result(...args)\n    } else if (result.postcss) {\n      return result.postcss\n    }\n    return result\n  }\n  plugin.postcss = true\n  return plugin\n}\n\nasync function loadPlugin(\n  dir: string,\n  pluginName: string,\n  options: boolean | object\n): Promise<import('postcss').AcceptedPlugin | false> {\n  if (options === false || isIgnoredPlugin(pluginName)) {\n    return false\n  }\n\n  if (options == null) {\n    console.error(getError_NullConfig(pluginName))\n    throw new Error(genericErrorText)\n  }\n\n  const pluginPath = require.resolve(pluginName, { paths: [dir] })\n  if (isIgnoredPlugin(pluginPath)) {\n    return false\n  } else if (options === true) {\n    return createLazyPostCssPlugin(() => require(pluginPath))\n  } else {\n    const keys = Object.keys(options)\n    if (keys.length === 0) {\n      return createLazyPostCssPlugin(() => require(pluginPath))\n    }\n    return createLazyPostCssPlugin(() => require(pluginPath)(options))\n  }\n}\n\nfunction getDefaultPlugins(\n  supportedBrowsers: string[] | undefined,\n  disablePostcssPresetEnv: boolean\n): any[] {\n  return [\n    require.resolve('next/dist/compiled/postcss-flexbugs-fixes'),\n    disablePostcssPresetEnv\n      ? false\n      : [\n          require.resolve('next/dist/compiled/postcss-preset-env'),\n          {\n            browsers: supportedBrowsers ?? ['defaults'],\n            autoprefixer: {\n              // Disable legacy flexbox support\n              flexbox: 'no-2009',\n            },\n            // Enable CSS features that have shipped to the\n            // web platform, i.e. in 2+ browsers unflagged.\n            stage: 3,\n            features: {\n              'custom-properties': false,\n            },\n          },\n        ],\n  ].filter(Boolean)\n}\n\nexport async function getPostCssPlugins(\n  dir: string,\n  supportedBrowsers: string[] | undefined,\n  disablePostcssPresetEnv: boolean = false\n): Promise<import('postcss').AcceptedPlugin[]> {\n  let config = await findConfig<{ plugins: CssPluginCollection }>(\n    dir,\n    'postcss'\n  )\n\n  if (config == null) {\n    config = {\n      plugins: getDefaultPlugins(supportedBrowsers, disablePostcssPresetEnv),\n    }\n  }\n\n  if (typeof config === 'function') {\n    throw new Error(\n      `Your custom PostCSS configuration may not export a function. Please export a plain object instead.\\n` +\n        'Read more: https://nextjs.org/docs/messages/postcss-function'\n    )\n  }\n\n  // Warn user about configuration keys which are not respected\n  const invalidKey = Object.keys(config).find((key) => key !== 'plugins')\n  if (invalidKey) {\n    console.warn(\n      `${chalk.yellow.bold(\n        'Warning'\n      )}: Your PostCSS configuration defines a field which is not supported (\\`${invalidKey}\\`). ` +\n        `Please remove this configuration value.`\n    )\n  }\n\n  // Enforce the user provided plugins if the configuration file is present\n  let plugins = config.plugins\n  if (plugins == null || typeof plugins !== 'object') {\n    throw new Error(\n      `Your custom PostCSS configuration must export a \\`plugins\\` key.`\n    )\n  }\n\n  if (!Array.isArray(plugins)) {\n    // Capture variable so TypeScript is happy\n    const pc = plugins\n\n    plugins = Object.keys(plugins).reduce((acc, curr) => {\n      const p = pc[curr]\n      if (typeof p === 'undefined') {\n        console.error(getError_NullConfig(curr))\n        throw new Error(genericErrorText)\n      }\n\n      acc.push([curr, p])\n      return acc\n    }, [] as CssPluginCollection_Array)\n  }\n\n  const parsed: CssPluginShape[] = []\n  plugins.forEach((plugin) => {\n    if (plugin == null) {\n      console.warn(\n        `${chalk.yellow.bold('Warning')}: A ${chalk.bold(\n          'null'\n        )} PostCSS plugin was provided. This entry will be ignored.`\n      )\n    } else if (typeof plugin === 'string') {\n      parsed.push([plugin, true])\n    } else if (Array.isArray(plugin)) {\n      const pluginName = plugin[0]\n      const pluginConfig = plugin[1]\n      if (\n        typeof pluginName === 'string' &&\n        (typeof pluginConfig === 'boolean' || typeof pluginConfig === 'object')\n      ) {\n        parsed.push([pluginName, pluginConfig])\n      } else {\n        if (typeof pluginName !== 'string') {\n          console.error(\n            `${chalk.red.bold(\n              'Error'\n            )}: A PostCSS Plugin must be provided as a ${chalk.bold(\n              'string'\n            )}. Instead, we got: '${pluginName}'.\\n` +\n              'Read more: https://nextjs.org/docs/messages/postcss-shape'\n          )\n        } else {\n          console.error(\n            `${chalk.red.bold(\n              'Error'\n            )}: A PostCSS Plugin was passed as an array but did not provide its configuration ('${pluginName}').\\n` +\n              'Read more: https://nextjs.org/docs/messages/postcss-shape'\n          )\n        }\n        throw new Error(genericErrorText)\n      }\n    } else if (typeof plugin === 'function') {\n      console.error(\n        `${chalk.red.bold(\n          'Error'\n        )}: A PostCSS Plugin was passed as a function using require(), but it must be provided as a ${chalk.bold(\n          'string'\n        )}.\\nRead more: https://nextjs.org/docs/messages/postcss-shape`\n      )\n      throw new Error(genericErrorText)\n    } else {\n      console.error(\n        `${chalk.red.bold(\n          'Error'\n        )}: An unknown PostCSS plugin was provided (${plugin}).\\n` +\n          'Read more: https://nextjs.org/docs/messages/postcss-shape'\n      )\n      throw new Error(genericErrorText)\n    }\n  })\n\n  const resolved = await Promise.all(\n    parsed.map((p) => loadPlugin(dir, p[0], p[1]))\n  )\n  const filtered: import('postcss').AcceptedPlugin[] = resolved.filter(\n    Boolean\n  ) as import('postcss').AcceptedPlugin[]\n\n  return filtered\n}\n"],"names":["getPostCssPlugins","genericErrorText","getError_NullConfig","pluginName","red","bold","isIgnoredPlugin","pluginPath","ignoredRegex","match","exec","plugin","pop","console","warn","yellow","underline","createLazyPostCssPlugin","fn","result","undefined","args","postcss","loadPlugin","dir","options","error","Error","require","resolve","paths","keys","Object","length","getDefaultPlugins","supportedBrowsers","disablePostcssPresetEnv","browsers","autoprefixer","flexbox","stage","features","filter","Boolean","config","plugins","invalidKey","find","key","Array","isArray","pc","reduce","acc","curr","p","push","parsed","forEach","pluginConfig","resolved","Promise","all","map","filtered"],"mappings":";;;;QAoHsBA,iBAAiB,GAAjBA,iBAAiB;AApHrB,GAA0B,CAA1B,MAA0B;AACjB,GAAgC,CAAhC,WAAgC;;;;;;AAY3D,KAAK,CAACC,gBAAgB,GAAG,CAAiC;SAEjDC,mBAAmB,CAACC,UAAkB,EAAE,CAAC;IAChD,MAAM,IAhBU,MAA0B,SAgB1BC,GAAG,CAACC,IAAI,CACtB,CAAO,QACP,kCAAkC,EAAEF,UAAU,CAAC,cAAc,EAlB/C,MAA0B,SAkB6BE,IAAI,CACzE,CAAM,OACN,6BAA6B,EAAEF,UAAU,CAAC,QAAQ,EApBpC,MAA0B,SAoBkBE,IAAI,CAC9D,CAAO,QACP,kBAAkB,EAtBJ,MAA0B,SAsBdA,IAAI,CAAC,CAAM,OAAE,2BAA2B;AACtE,CAAC;SAEQC,eAAe,CAACC,UAAkB,EAAW,CAAC;IACrD,KAAK,CAACC,YAAY;IAElB,KAAK,CAACC,KAAK,GAAGD,YAAY,CAACE,IAAI,CAACH,UAAU;IAC1C,EAAE,EAAEE,KAAK,IAAI,IAAI,EAAE,CAAC;QAClB,MAAM,CAAC,KAAK;IACd,CAAC;IAED,KAAK,CAACE,MAAM,GAAGF,KAAK,CAACG,GAAG;IACxBC,OAAO,CAACC,IAAI,IAlCI,MAA0B,SAmC/BC,MAAM,CAACV,IAAI,CAAC,CAAS,UAAE,oBAAoB,EAnCtC,MAA0B,SAmCoBW,SAAS,CACnEL,MAAM,EACN,yCAAyC,KACxC,qDAAqD,IACtD,CAAoE;IAExE,MAAM,CAAC,IAAI;AACb,CAAC;AAED,KAAK,CAACM,uBAAuB,IAC3BC,EAA0C,GACL,CAAC;IACtC,GAAG,CAACC,MAAM,GAAQC,SAAS;IAC3B,KAAK,CAACT,MAAM,OAAOU,IAAI,GAAY,CAAC;QAClC,EAAE,EAAEF,MAAM,KAAKC,SAAS,EAAED,MAAM,GAAGD,EAAE;QACrC,EAAE,EAAEC,MAAM,CAACG,OAAO,KAAK,IAAI,EAAE,CAAC;YAC5B,MAAM,CAACH,MAAM,IAAIE,IAAI;QACvB,CAAC,MAAM,EAAE,EAAEF,MAAM,CAACG,OAAO,EAAE,CAAC;YAC1B,MAAM,CAACH,MAAM,CAACG,OAAO;QACvB,CAAC;QACD,MAAM,CAACH,MAAM;IACf,CAAC;IACDR,MAAM,CAACW,OAAO,GAAG,IAAI;IACrB,MAAM,CAACX,MAAM;AACf,CAAC;eAEcY,UAAU,CACvBC,GAAW,EACXrB,UAAkB,EAClBsB,OAAyB,EAC0B,CAAC;IACpD,EAAE,EAAEA,OAAO,KAAK,KAAK,IAAInB,eAAe,CAACH,UAAU,GAAG,CAAC;QACrD,MAAM,CAAC,KAAK;IACd,CAAC;IAED,EAAE,EAAEsB,OAAO,IAAI,IAAI,EAAE,CAAC;QACpBZ,OAAO,CAACa,KAAK,CAACxB,mBAAmB,CAACC,UAAU;QAC5C,KAAK,CAAC,GAAG,CAACwB,KAAK,CAAC1B,gBAAgB;IAClC,CAAC;IAED,KAAK,CAACM,UAAU,GAAGqB,OAAO,CAACC,OAAO,CAAC1B,UAAU,EAAE,CAAC;QAAC2B,KAAK,EAAE,CAACN;YAAAA,GAAG;QAAA,CAAC;IAAC,CAAC;IAC/D,EAAE,EAAElB,eAAe,CAACC,UAAU,GAAG,CAAC;QAChC,MAAM,CAAC,KAAK;IACd,CAAC,MAAM,EAAE,EAAEkB,OAAO,KAAK,IAAI,EAAE,CAAC;QAC5B,MAAM,CAACR,uBAAuB,KAAOW,OAAO,CAACrB,UAAU;;IACzD,CAAC,MAAM,CAAC;QACN,KAAK,CAACwB,IAAI,GAAGC,MAAM,CAACD,IAAI,CAACN,OAAO;QAChC,EAAE,EAAEM,IAAI,CAACE,MAAM,KAAK,CAAC,EAAE,CAAC;YACtB,MAAM,CAAChB,uBAAuB,KAAOW,OAAO,CAACrB,UAAU;;QACzD,CAAC;QACD,MAAM,CAACU,uBAAuB,KAAOW,OAAO,CAACrB,UAAU,EAAEkB,OAAO;;IAClE,CAAC;AACH,CAAC;SAEQS,iBAAiB,CACxBC,iBAAuC,EACvCC,uBAAgC,EACzB,CAAC;IACR,MAAM,CAAC,CAAC;QACNR,OAAO,CAACC,OAAO,CAAC,CAA2C;QAC3DO,uBAAuB,GACnB,KAAK,GACL,CAAC;YACCR,OAAO,CAACC,OAAO,CAAC,CAAuC;YACvD,CAAC;gBACCQ,QAAQ,EAAEF,iBAAiB,aAAjBA,iBAAiB,cAAjBA,iBAAiB,GAAI,CAAC;oBAAA,CAAU;gBAAA,CAAC;gBAC3CG,YAAY,EAAE,CAAC;oBACb,EAAiC,AAAjC,+BAAiC;oBACjCC,OAAO,EAAE,CAAS;gBACpB,CAAC;gBACD,EAA+C,AAA/C,6CAA+C;gBAC/C,EAA+C,AAA/C,6CAA+C;gBAC/CC,KAAK,EAAE,CAAC;gBACRC,QAAQ,EAAE,CAAC;oBACT,CAAmB,oBAAE,KAAK;gBAC5B,CAAC;YACH,CAAC;QACH,CAAC;IACP,CAAC,CAACC,MAAM,CAACC,OAAO;AAClB,CAAC;eAEqB3C,iBAAiB,CACrCwB,GAAW,EACXW,iBAAuC,EACvCC,uBAAgC,GAAG,KAAK,EACK,CAAC;IAC9C,GAAG,CAACQ,MAAM,GAAG,KAAK,KAxHO,WAAgC,aAyHvDpB,GAAG,EACH,CAAS;IAGX,EAAE,EAAEoB,MAAM,IAAI,IAAI,EAAE,CAAC;QACnBA,MAAM,GAAG,CAAC;YACRC,OAAO,EAAEX,iBAAiB,CAACC,iBAAiB,EAAEC,uBAAuB;QACvE,CAAC;IACH,CAAC;IAED,EAAE,EAAE,MAAM,CAACQ,MAAM,KAAK,CAAU,WAAE,CAAC;QACjC,KAAK,CAAC,GAAG,CAACjB,KAAK,EACZ,oGAAoG,IACnG,CAA8D;IAEpE,CAAC;IAED,EAA6D,AAA7D,2DAA6D;IAC7D,KAAK,CAACmB,UAAU,GAAGd,MAAM,CAACD,IAAI,CAACa,MAAM,EAAEG,IAAI,EAAEC,GAAG,GAAKA,GAAG,KAAK,CAAS;;IACtE,EAAE,EAAEF,UAAU,EAAE,CAAC;QACfjC,OAAO,CAACC,IAAI,IA9IE,MAA0B,SA+I7BC,MAAM,CAACV,IAAI,CAClB,CAAS,UACT,uEAAuE,EAAEyC,UAAU,CAAC,KAAK,KACxF,uCAAuC;IAE9C,CAAC;IAED,EAAyE,AAAzE,uEAAyE;IACzE,GAAG,CAACD,OAAO,GAAGD,MAAM,CAACC,OAAO;IAC5B,EAAE,EAAEA,OAAO,IAAI,IAAI,IAAI,MAAM,CAACA,OAAO,KAAK,CAAQ,SAAE,CAAC;QACnD,KAAK,CAAC,GAAG,CAAClB,KAAK,EACZ,gEAAgE;IAErE,CAAC;IAED,EAAE,GAAGsB,KAAK,CAACC,OAAO,CAACL,OAAO,GAAG,CAAC;QAC5B,EAA0C,AAA1C,wCAA0C;QAC1C,KAAK,CAACM,EAAE,GAAGN,OAAO;QAElBA,OAAO,GAAGb,MAAM,CAACD,IAAI,CAACc,OAAO,EAAEO,MAAM,EAAEC,GAAG,EAAEC,IAAI,GAAK,CAAC;YACpD,KAAK,CAACC,CAAC,GAAGJ,EAAE,CAACG,IAAI;YACjB,EAAE,EAAE,MAAM,CAACC,CAAC,KAAK,CAAW,YAAE,CAAC;gBAC7B1C,OAAO,CAACa,KAAK,CAACxB,mBAAmB,CAACoD,IAAI;gBACtC,KAAK,CAAC,GAAG,CAAC3B,KAAK,CAAC1B,gBAAgB;YAClC,CAAC;YAEDoD,GAAG,CAACG,IAAI,CAAC,CAACF;gBAAAA,IAAI;gBAAEC,CAAC;YAAA,CAAC;YAClB,MAAM,CAACF,GAAG;QACZ,CAAC,EAAE,CAAC,CAAC;IACP,CAAC;IAED,KAAK,CAACI,MAAM,GAAqB,CAAC,CAAC;IACnCZ,OAAO,CAACa,OAAO,EAAE/C,MAAM,GAAK,CAAC;QAC3B,EAAE,EAAEA,MAAM,IAAI,IAAI,EAAE,CAAC;YACnBE,OAAO,CAACC,IAAI,IAjLA,MAA0B,SAkL3BC,MAAM,CAACV,IAAI,CAAC,CAAS,UAAE,IAAI,EAlL1B,MAA0B,SAkLQA,IAAI,CAC9C,CAAM,OACN,yDAAyD;QAE/D,CAAC,MAAM,EAAE,EAAE,MAAM,CAACM,MAAM,KAAK,CAAQ,SAAE,CAAC;YACtC8C,MAAM,CAACD,IAAI,CAAC,CAAC7C;gBAAAA,MAAM;gBAAE,IAAI;YAAA,CAAC;QAC5B,CAAC,MAAM,EAAE,EAAEsC,KAAK,CAACC,OAAO,CAACvC,MAAM,GAAG,CAAC;YACjC,KAAK,CAACR,UAAU,GAAGQ,MAAM,CAAC,CAAC;YAC3B,KAAK,CAACgD,YAAY,GAAGhD,MAAM,CAAC,CAAC;YAC7B,EAAE,EACA,MAAM,CAACR,UAAU,KAAK,CAAQ,YAC7B,MAAM,CAACwD,YAAY,KAAK,CAAS,YAAI,MAAM,CAACA,YAAY,KAAK,CAAQ,UACtE,CAAC;gBACDF,MAAM,CAACD,IAAI,CAAC,CAACrD;oBAAAA,UAAU;oBAAEwD,YAAY;gBAAA,CAAC;YACxC,CAAC,MAAM,CAAC;gBACN,EAAE,EAAE,MAAM,CAACxD,UAAU,KAAK,CAAQ,SAAE,CAAC;oBACnCU,OAAO,CAACa,KAAK,IAlML,MAA0B,SAmMvBtB,GAAG,CAACC,IAAI,CACf,CAAO,QACP,yCAAyC,EArMrC,MAA0B,SAqMmBA,IAAI,CACrD,CAAQ,SACR,oBAAoB,EAAEF,UAAU,CAAC,IAAI,IACrC,CAA2D;gBAEjE,CAAC,MAAM,CAAC;oBACNU,OAAO,CAACa,KAAK,IA3ML,MAA0B,SA4MvBtB,GAAG,CAACC,IAAI,CACf,CAAO,QACP,kFAAkF,EAAEF,UAAU,CAAC,KAAK,IACpG,CAA2D;gBAEjE,CAAC;gBACD,KAAK,CAAC,GAAG,CAACwB,KAAK,CAAC1B,gBAAgB;YAClC,CAAC;QACH,CAAC,MAAM,EAAE,EAAE,MAAM,CAACU,MAAM,KAAK,CAAU,WAAE,CAAC;YACxCE,OAAO,CAACa,KAAK,IArND,MAA0B,SAsN3BtB,GAAG,CAACC,IAAI,CACf,CAAO,QACP,0FAA0F,EAxNlF,MAA0B,SAwNgEA,IAAI,CACtG,CAAQ,SACR,4DAA4D;YAEhE,KAAK,CAAC,GAAG,CAACsB,KAAK,CAAC1B,gBAAgB;QAClC,CAAC,MAAM,CAAC;YACNY,OAAO,CAACa,KAAK,IA9ND,MAA0B,SA+N3BtB,GAAG,CAACC,IAAI,CACf,CAAO,QACP,0CAA0C,EAAEM,MAAM,CAAC,IAAI,IACvD,CAA2D;YAE/D,KAAK,CAAC,GAAG,CAACgB,KAAK,CAAC1B,gBAAgB;QAClC,CAAC;IACH,CAAC;IAED,KAAK,CAAC2D,QAAQ,GAAG,KAAK,CAACC,OAAO,CAACC,GAAG,CAChCL,MAAM,CAACM,GAAG,EAAER,CAAC,GAAKhC,UAAU,CAACC,GAAG,EAAE+B,CAAC,CAAC,CAAC,GAAGA,CAAC,CAAC,CAAC;;IAE7C,KAAK,CAACS,QAAQ,GAAuCJ,QAAQ,CAAClB,MAAM,CAClEC,OAAO;IAGT,MAAM,CAACqB,QAAQ;AACjB,CAAC"}