{"version":3,"sources":["../../../../../../../build/webpack/loaders/css-loader/src/plugins/postcss-icss-parser.js"],"sourcesContent":["import {\n  extractICSS,\n  replaceValueSymbols,\n  replaceSymbols,\n} from 'next/dist/compiled/icss-utils'\n\nimport { normalizeUrl, resolveRequests, requestify } from '../utils'\n\nconst plugin = (options = {}) => {\n  return {\n    postcssPlugin: 'postcss-icss-parser',\n    async OnceExit(root) {\n      const importReplacements = Object.create(null)\n      const { icssImports, icssExports } = extractICSS(root)\n      const imports = new Map()\n      const tasks = []\n\n      // eslint-disable-next-line guard-for-in\n      for (const url in icssImports) {\n        const tokens = icssImports[url]\n\n        if (Object.keys(tokens).length === 0) {\n          // eslint-disable-next-line no-continue\n          continue\n        }\n\n        let normalizedUrl = url\n        let prefix = ''\n\n        const queryParts = normalizedUrl.split('!')\n\n        if (queryParts.length > 1) {\n          normalizedUrl = queryParts.pop()\n          prefix = queryParts.join('!')\n        }\n\n        const request = requestify(\n          normalizeUrl(normalizedUrl, true),\n          options.rootContext\n        )\n        const doResolve = async () => {\n          const { resolver, context } = options\n          const resolvedUrl = await resolveRequests(resolver, context, [\n            ...new Set([normalizedUrl, request]),\n          ])\n\n          if (!resolvedUrl) {\n            return\n          }\n\n          // eslint-disable-next-line consistent-return\n          return { url: resolvedUrl, prefix, tokens }\n        }\n\n        tasks.push(doResolve())\n      }\n\n      const results = await Promise.all(tasks)\n\n      for (let index = 0; index <= results.length - 1; index++) {\n        const item = results[index]\n\n        if (!item) {\n          // eslint-disable-next-line no-continue\n          continue\n        }\n\n        const newUrl = item.prefix ? `${item.prefix}!${item.url}` : item.url\n        const importKey = newUrl\n        let importName = imports.get(importKey)\n\n        if (!importName) {\n          importName = `___CSS_LOADER_ICSS_IMPORT_${imports.size}___`\n          imports.set(importKey, importName)\n\n          options.imports.push({\n            type: 'icss_import',\n            importName,\n            url: options.urlHandler(newUrl),\n            icss: true,\n            index,\n          })\n\n          options.api.push({ importName, dedupe: true, index })\n        }\n\n        for (const [replacementIndex, token] of Object.keys(\n          item.tokens\n        ).entries()) {\n          const replacementName = `___CSS_LOADER_ICSS_IMPORT_${index}_REPLACEMENT_${replacementIndex}___`\n          const localName = item.tokens[token]\n\n          importReplacements[token] = replacementName\n\n          options.replacements.push({ replacementName, importName, localName })\n        }\n      }\n\n      if (Object.keys(importReplacements).length > 0) {\n        replaceSymbols(root, importReplacements)\n      }\n\n      for (const name of Object.keys(icssExports)) {\n        const value = replaceValueSymbols(icssExports[name], importReplacements)\n\n        options.exports.push({ name, value })\n      }\n    },\n  }\n}\n\nplugin.postcss = true\n\nexport default plugin\n"],"names":["plugin","options","postcssPlugin","OnceExit","root","importReplacements","Object","create","icssImports","icssExports","imports","Map","tasks","url","tokens","keys","length","normalizedUrl","prefix","queryParts","split","pop","join","request","rootContext","doResolve","resolver","context","resolvedUrl","Set","push","results","Promise","all","index","item","newUrl","importKey","importName","get","size","set","type","urlHandler","icss","api","dedupe","replacementIndex","token","entries","replacementName","localName","replacements","name","value","exports","postcss"],"mappings":"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"}