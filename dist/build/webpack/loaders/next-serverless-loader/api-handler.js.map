{"version":3,"sources":["../../../../../build/webpack/loaders/next-serverless-loader/api-handler.ts"],"sourcesContent":["import { parse as parseUrl } from 'url'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { apiResolver } from '../../../../server/api-utils'\nimport { getUtils, vercelHeader, ServerlessHandlerCtx } from './utils'\nimport { DecodeError } from '../../../../shared/lib/utils'\nimport { NodeNextResponse, NodeNextRequest } from '../../../../server/base-http'\n\nexport function getApiHandler(ctx: ServerlessHandlerCtx) {\n  const { pageModule, encodedPreviewProps, pageIsDynamic } = ctx\n  const {\n    handleRewrites,\n    handleBasePath,\n    dynamicRouteMatcher,\n    normalizeDynamicRouteParams,\n  } = getUtils(ctx)\n\n  return async (\n    rawReq: NodeNextRequest | IncomingMessage,\n    rawRes: NodeNextResponse | ServerResponse\n  ) => {\n    const req =\n      rawReq instanceof IncomingMessage ? new NodeNextRequest(rawReq) : rawReq\n    const res =\n      rawRes instanceof ServerResponse ? new NodeNextResponse(rawRes) : rawRes\n\n    try {\n      // We need to trust the dynamic route params from the proxy\n      // to ensure we are using the correct values\n      const trustQuery = req.headers[vercelHeader]\n      const parsedUrl = handleRewrites(req, parseUrl(req.url!, true))\n\n      if (parsedUrl.query.nextInternalLocale) {\n        delete parsedUrl.query.nextInternalLocale\n      }\n      handleBasePath(req, parsedUrl)\n\n      let params = {}\n\n      if (pageIsDynamic) {\n        const result = normalizeDynamicRouteParams(\n          trustQuery\n            ? parsedUrl.query\n            : (dynamicRouteMatcher!(parsedUrl.pathname) as Record<\n                string,\n                string | string[]\n              >)\n        )\n\n        params = result.params\n      }\n\n      await apiResolver(\n        req.originalRequest,\n        res.originalResponse,\n        Object.assign({}, parsedUrl.query, params),\n        await pageModule,\n        encodedPreviewProps,\n        true\n      )\n    } catch (err) {\n      console.error(err)\n\n      if (err instanceof DecodeError) {\n        res.statusCode = 400\n        res.body('Bad Request').send()\n      } else {\n        // Throw the error to crash the serverless function\n        throw err\n      }\n    }\n  }\n}\n"],"names":["getApiHandler","ctx","pageModule","encodedPreviewProps","pageIsDynamic","handleRewrites","handleBasePath","dynamicRouteMatcher","normalizeDynamicRouteParams","rawReq","rawRes","req","res","trustQuery","headers","parsedUrl","url","query","nextInternalLocale","params","result","pathname","originalRequest","originalResponse","Object","assign","err","console","error","statusCode","body","send"],"mappings":";;;;QAOgBA,aAAa,GAAbA,aAAa;AAPK,GAAK,CAAL,IAAK;AACS,GAAM,CAAN,KAAM;AAC1B,GAA8B,CAA9B,SAA8B;AACG,GAAS,CAAT,MAAS;AAC1C,GAA8B,CAA9B,OAA8B;AACR,GAA8B,CAA9B,SAA8B;SAEhEA,aAAa,CAACC,GAAyB,EAAE,CAAC;IACxD,KAAK,CAAC,CAAC,CAACC,UAAU,GAAEC,mBAAmB,GAAEC,aAAa,EAAC,CAAC,GAAGH,GAAG;IAC9D,KAAK,CAAC,CAAC,CACLI,cAAc,GACdC,cAAc,GACdC,mBAAmB,GACnBC,2BAA2B,IAC7B,CAAC,OAX0D,MAAS,WAWvDP,GAAG;IAEhB,MAAM,QACJQ,MAAyC,EACzCC,MAAyC,GACtC,CAAC;QACJ,KAAK,CAACC,GAAG,GACPF,MAAM,YApBoC,KAAM,mBAoBZ,GAAG,CAhBK,SAA8B,iBAgBlBA,MAAM,IAAIA,MAAM;QAC1E,KAAK,CAACG,GAAG,GACPF,MAAM,YAtBoC,KAAM,kBAsBb,GAAG,CAlBM,SAA8B,kBAkBlBA,MAAM,IAAIA,MAAM;QAE1E,GAAG,CAAC,CAAC;YACH,EAA2D,AAA3D,yDAA2D;YAC3D,EAA4C,AAA5C,0CAA4C;YAC5C,KAAK,CAACG,UAAU,GAAGF,GAAG,CAACG,OAAO,CAzByB,MAAS;YA0BhE,KAAK,CAACC,SAAS,GAAGV,cAAc,CAACM,GAAG,MA7BR,IAAK,QA6BcA,GAAG,CAACK,GAAG,EAAG,IAAI;YAE7D,EAAE,EAAED,SAAS,CAACE,KAAK,CAACC,kBAAkB,EAAE,CAAC;gBACvC,MAAM,CAACH,SAAS,CAACE,KAAK,CAACC,kBAAkB;YAC3C,CAAC;YACDZ,cAAc,CAACK,GAAG,EAAEI,SAAS;YAE7B,GAAG,CAACI,MAAM,GAAG,CAAC,CAAC;YAEf,EAAE,EAAEf,aAAa,EAAE,CAAC;gBAClB,KAAK,CAACgB,MAAM,GAAGZ,2BAA2B,CACxCK,UAAU,GACNE,SAAS,CAACE,KAAK,GACdV,mBAAmB,CAAEQ,SAAS,CAACM,QAAQ;gBAM9CF,MAAM,GAAGC,MAAM,CAACD,MAAM;YACxB,CAAC;YAED,KAAK,KAjDiB,SAA8B,cAkDlDR,GAAG,CAACW,eAAe,EACnBV,GAAG,CAACW,gBAAgB,EACpBC,MAAM,CAACC,MAAM,CAAC,CAAC,CAAC,EAAEV,SAAS,CAACE,KAAK,EAAEE,MAAM,GACzC,KAAK,CAACjB,UAAU,EAChBC,mBAAmB,EACnB,IAAI;QAER,CAAC,CAAC,KAAK,EAAEuB,GAAG,EAAE,CAAC;YACbC,OAAO,CAACC,KAAK,CAACF,GAAG;YAEjB,EAAE,EAAEA,GAAG,YA1De,OAA8B,cA0DpB,CAAC;gBAC/Bd,GAAG,CAACiB,UAAU,GAAG,GAAG;gBACpBjB,GAAG,CAACkB,IAAI,CAAC,CAAa,cAAEC,IAAI;YAC9B,CAAC,MAAM,CAAC;gBACN,EAAmD,AAAnD,iDAAmD;gBACnD,KAAK,CAACL,GAAG;YACX,CAAC;QACH,CAAC;IACH,CAAC;AACH,CAAC"}