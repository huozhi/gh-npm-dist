{"version":3,"sources":["../../../../../build/webpack/loaders/next-middleware-ssr-loader/render.ts"],"sourcesContent":["import type { NextConfig } from '../../../../server/config-shared'\nimport type { DocumentType, AppType } from '../../../../shared/lib/utils'\nimport type { BuildManifest } from '../../../../server/get-page-files'\nimport type { ReactLoadableManifest } from '../../../../server/load-components'\n\nimport { NextRequest } from '../../../../server/web/spec-extension/request'\nimport { toNodeHeaders } from '../../../../server/web/utils'\n\nimport WebServer from '../../../../server/web-server'\nimport { WebNextRequest, WebNextResponse } from '../../../../server/base-http'\n\nconst createHeaders = (args?: any) => ({\n  ...args,\n  'x-middleware-ssr': '1',\n  'Cache-Control': 'no-cache, no-store, max-age=0, must-revalidate',\n})\n\nfunction sendError(req: any, error: Error) {\n  const defaultMessage = 'An error occurred while rendering ' + req.url + '.'\n  return new Response((error && error.message) || defaultMessage, {\n    status: 500,\n    headers: createHeaders(),\n  })\n}\n\n// Polyfilled for `path-browserify` inside the Web Server.\nprocess.cwd = () => ''\n\nexport function getRender({\n  dev,\n  page,\n  pageMod,\n  errorMod,\n  error500Mod,\n  Document,\n  App,\n  buildManifest,\n  reactLoadableManifest,\n  serverComponentManifest,\n  isServerComponent,\n  config,\n  buildId,\n}: {\n  dev: boolean\n  page: string\n  pageMod: any\n  errorMod: any\n  error500Mod: any\n  Document: DocumentType\n  App: AppType\n  buildManifest: BuildManifest\n  reactLoadableManifest: ReactLoadableManifest\n  serverComponentManifest: any | null\n  isServerComponent: boolean\n  config: NextConfig\n  buildId: string\n}) {\n  const baseLoadComponentResult = {\n    dev,\n    buildManifest,\n    reactLoadableManifest,\n    Document,\n    App,\n  }\n\n  const server = new WebServer({\n    conf: config,\n    minimalMode: true,\n    webServerConfig: {\n      extendRenderOpts: {\n        buildId,\n        supportsDynamicHTML: true,\n        concurrentFeatures: true,\n        disableOptimizedLoading: true,\n        serverComponentManifest,\n      },\n      loadComponent: async (pathname) => {\n        if (pathname === page) {\n          return {\n            ...baseLoadComponentResult,\n            Component: pageMod.default,\n            pageConfig: pageMod.config || {},\n            getStaticProps: pageMod.getStaticProps,\n            getServerSideProps: pageMod.getServerSideProps,\n            getStaticPaths: pageMod.getStaticPaths,\n            ComponentMod: pageMod,\n          }\n        }\n\n        // If there is a custom 500 page, we need to handle it separately.\n        if (pathname === '/500' && error500Mod) {\n          return {\n            ...baseLoadComponentResult,\n            Component: error500Mod.default,\n            pageConfig: error500Mod.config || {},\n            getStaticProps: error500Mod.getStaticProps,\n            getServerSideProps: error500Mod.getServerSideProps,\n            getStaticPaths: error500Mod.getStaticPaths,\n            ComponentMod: error500Mod,\n          }\n        }\n\n        if (pathname === '/_error') {\n          return {\n            ...baseLoadComponentResult,\n            Component: errorMod.default,\n            pageConfig: errorMod.config || {},\n            getStaticProps: errorMod.getStaticProps,\n            getServerSideProps: errorMod.getServerSideProps,\n            getStaticPaths: errorMod.getStaticPaths,\n            ComponentMod: errorMod,\n          }\n        }\n\n        return null\n      },\n    },\n  })\n  const requestHandler = server.getRequestHandler()\n\n  return async function render(request: NextRequest) {\n    const { nextUrl: url, cookies, headers } = request\n    const { pathname, searchParams } = url\n\n    const query = Object.fromEntries(searchParams)\n    const req = {\n      url: pathname,\n      cookies,\n      headers: toNodeHeaders(headers),\n    }\n\n    // Preflight request\n    if (request.method === 'HEAD') {\n      return new Response(null, {\n        headers: createHeaders(),\n      })\n    }\n\n    // @TODO: We should move this into server/render.\n    if (Document.getInitialProps) {\n      const err = new Error(\n        '`getInitialProps` in Document component is not supported with `concurrentFeatures` enabled.'\n      )\n      return sendError(req, err)\n    }\n\n    const renderServerComponentData = isServerComponent\n      ? query.__flight__ !== undefined\n      : false\n\n    const serverComponentProps =\n      isServerComponent && query.__props__\n        ? JSON.parse(query.__props__)\n        : undefined\n\n    // Extend the render options.\n    server.updateRenderOpts({\n      renderServerComponentData,\n      serverComponentProps,\n    })\n\n    const extendedReq = new WebNextRequest(request)\n    const extendedRes = new WebNextResponse()\n    requestHandler(extendedReq, extendedRes)\n    return await extendedRes.toResponse()\n  }\n}\n"],"names":["getRender","createHeaders","args","sendError","req","error","defaultMessage","url","Response","message","status","headers","process","cwd","dev","page","pageMod","errorMod","error500Mod","Document","App","buildManifest","reactLoadableManifest","serverComponentManifest","isServerComponent","config","buildId","baseLoadComponentResult","server","conf","minimalMode","webServerConfig","extendRenderOpts","supportsDynamicHTML","concurrentFeatures","disableOptimizedLoading","loadComponent","pathname","Component","default","pageConfig","getStaticProps","getServerSideProps","getStaticPaths","ComponentMod","requestHandler","getRequestHandler","render","request","nextUrl","cookies","searchParams","query","Object","fromEntries","method","getInitialProps","err","Error","renderServerComponentData","__flight__","undefined","serverComponentProps","__props__","JSON","parse","updateRenderOpts","extendedReq","extendedRes","toResponse"],"mappings":"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"}