{"version":3,"sources":["../../../../build/webpack/loaders/next-image-loader.js"],"sourcesContent":["import loaderUtils from 'next/dist/compiled/loader-utils3'\nimport { resizeImage, getImageSize } from '../../../server/image-optimizer'\n\nconst BLUR_IMG_SIZE = 8\nconst BLUR_QUALITY = 70\nconst VALID_BLUR_EXT = ['jpeg', 'png', 'webp', 'avif'] // should match next/client/image.tsx\n\nfunction nextImageLoader(content) {\n  const imageLoaderSpan = this.currentTraceSpan.traceChild('next-image-loader')\n  return imageLoaderSpan.traceAsyncFn(async () => {\n    const { isServer, isDev, assetPrefix, basePath } = this.getOptions()\n    const context = this.rootContext\n    const opts = { context, content }\n    const interpolatedName = loaderUtils.interpolateName(\n      this,\n      '/static/media/[name].[hash:8].[ext]',\n      opts\n    )\n    const outputPath = assetPrefix + '/_next' + interpolatedName\n\n    let extension = loaderUtils.interpolateName(this, '[ext]', opts)\n    if (extension === 'jpg') {\n      extension = 'jpeg'\n    }\n\n    const imageSizeSpan = imageLoaderSpan.traceChild('image-size-calculation')\n    const imageSize = await imageSizeSpan.traceAsyncFn(() =>\n      getImageSize(content, extension)\n    )\n    let blurDataURL\n\n    if (VALID_BLUR_EXT.includes(extension)) {\n      if (isDev) {\n        const prefix = 'http://localhost'\n        const url = new URL(`${basePath || ''}/_next/image`, prefix)\n        url.searchParams.set('url', outputPath)\n        url.searchParams.set('w', BLUR_IMG_SIZE)\n        url.searchParams.set('q', BLUR_QUALITY)\n        blurDataURL = url.href.slice(prefix.length)\n      } else {\n        // Shrink the image's largest dimension\n        const dimension =\n          imageSize.width >= imageSize.height ? 'width' : 'height'\n\n        const resizeImageSpan = imageLoaderSpan.traceChild('image-resize')\n        const resizedImage = await resizeImageSpan.traceAsyncFn(() =>\n          resizeImage(\n            content,\n            dimension,\n            BLUR_IMG_SIZE,\n            extension,\n            BLUR_QUALITY\n          )\n        )\n        const blurDataURLSpan = imageLoaderSpan.traceChild(\n          'image-base64-tostring'\n        )\n        blurDataURL = blurDataURLSpan.traceFn(\n          () =>\n            `data:image/${extension};base64,${resizedImage.toString('base64')}`\n        )\n      }\n    }\n\n    const stringifiedData = imageLoaderSpan\n      .traceChild('image-data-stringify')\n      .traceFn(() =>\n        JSON.stringify({\n          src: outputPath,\n          height: imageSize.height,\n          width: imageSize.width,\n          blurDataURL,\n        })\n      )\n\n    if (!isServer) {\n      this.emitFile(interpolatedName, content, null)\n    }\n\n    return `export default ${stringifiedData};`\n  })\n}\nexport const raw = true\nexport default nextImageLoader\n"],"names":["BLUR_IMG_SIZE","BLUR_QUALITY","VALID_BLUR_EXT","nextImageLoader","content","imageLoaderSpan","currentTraceSpan","traceChild","traceAsyncFn","isServer","isDev","assetPrefix","basePath","getOptions","context","rootContext","opts","interpolatedName","interpolateName","outputPath","extension","imageSizeSpan","imageSize","blurDataURL","includes","prefix","url","URL","searchParams","set","href","slice","length","dimension","width","height","resizeImageSpan","resizedImage","blurDataURLSpan","traceFn","toString","stringifiedData","JSON","stringify","src","emitFile","raw"],"mappings":"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"}