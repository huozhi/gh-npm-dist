{"version":3,"sources":["../../../../build/webpack/loaders/next-flight-client-loader.ts"],"sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n// TODO: add ts support for next-swc api\n// @ts-ignore\nimport { parse } from '../../swc'\n// @ts-ignore\nimport { getBaseSWCOptions } from '../../swc/options'\n\nfunction addExportNames(names: string[], node: any) {\n  switch (node.type) {\n    case 'Identifier':\n      names.push(node.value)\n      return\n    case 'ObjectPattern':\n      for (let i = 0; i < node.properties.length; i++)\n        addExportNames(names, node.properties[i])\n      return\n    case 'ArrayPattern':\n      for (let i = 0; i < node.elements.length; i++) {\n        const element = node.elements[i]\n        if (element) addExportNames(names, element)\n      }\n      return\n    case 'Property':\n      addExportNames(names, node.value)\n      return\n    case 'AssignmentPattern':\n      addExportNames(names, node.left)\n      return\n    case 'RestElement':\n      addExportNames(names, node.argument)\n      return\n    case 'ParenthesizedExpression':\n      addExportNames(names, node.expression)\n      return\n    default:\n      return\n  }\n}\n\nasync function parseExportNamesInto(\n  resourcePath: string,\n  transformedSource: string,\n  names: Array<string>\n): Promise<void> {\n  const opts = getBaseSWCOptions({\n    filename: resourcePath,\n    globalWindow: true,\n  })\n\n  const { body } = await parse(transformedSource, {\n    ...opts.jsc.parser,\n    isModule: true,\n  })\n  for (let i = 0; i < body.length; i++) {\n    const node = body[i]\n    switch (node.type) {\n      // TODO: support export * from module path\n      // case 'ExportAllDeclaration':\n      case 'ExportDefaultDeclaration':\n        names.push('default')\n        continue\n      case 'ExportNamedDeclaration':\n        if (node.declaration) {\n          if (node.declaration.type === 'VariableDeclaration') {\n            const declarations = node.declaration.declarations\n            for (let j = 0; j < declarations.length; j++) {\n              addExportNames(names, declarations[j].id)\n            }\n          } else {\n            addExportNames(names, node.declaration.id)\n          }\n        }\n        if (node.specificers) {\n          const specificers = node.specificers\n          for (let j = 0; j < specificers.length; j++) {\n            addExportNames(names, specificers[j].exported)\n          }\n        }\n        continue\n      default:\n        break\n    }\n  }\n}\n\nexport default async function transformSource(\n  this: any,\n  source: string\n): Promise<string> {\n  const { resourcePath, resourceQuery } = this\n\n  if (resourceQuery !== '?flight') return source\n\n  let url = resourcePath\n  const transformedSource = source\n  if (typeof transformedSource !== 'string') {\n    throw new Error('Expected source to have been transformed to a string.')\n  }\n\n  const names: string[] = []\n  await parseExportNamesInto(resourcePath, transformedSource, names)\n\n  // next.js/packages/next/<component>.js\n  if (/[\\\\/]next[\\\\/](link|image)\\.js$/.test(url)) {\n    names.push('default')\n  }\n\n  let newSrc =\n    \"const MODULE_REFERENCE = Symbol.for('react.module.reference');\\n\"\n  for (let i = 0; i < names.length; i++) {\n    const name = names[i]\n    if (name === 'default') {\n      newSrc += 'export default '\n    } else {\n      newSrc += 'export const ' + name + ' = '\n    }\n    newSrc += '{ $$typeof: MODULE_REFERENCE, filepath: '\n    newSrc += JSON.stringify(url)\n    newSrc += ', name: '\n    newSrc += JSON.stringify(name)\n    newSrc += '};\\n'\n  }\n\n  return newSrc\n}\n"],"names":["transformSource","addExportNames","names","node","type","push","value","i","properties","length","elements","element","left","argument","expression","parseExportNamesInto","resourcePath","transformedSource","opts","filename","globalWindow","body","jsc","parser","isModule","declaration","declarations","j","id","specificers","exported","source","resourceQuery","url","Error","test","newSrc","name","JSON","stringify"],"mappings":";;;;kBA2F8BA,eAAe;AAlFvB,GAAW,CAAX,IAAW;AAEC,GAAmB,CAAnB,QAAmB;SAE5CC,cAAc,CAACC,KAAe,EAAEC,IAAS,EAAE,CAAC;IACnD,MAAM,CAAEA,IAAI,CAACC,IAAI;QACf,IAAI,CAAC,CAAY;YACfF,KAAK,CAACG,IAAI,CAACF,IAAI,CAACG,KAAK;YACrB,MAAM;QACR,IAAI,CAAC,CAAe;YAClB,GAAG,CAAE,GAAG,CAACC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGJ,IAAI,CAACK,UAAU,CAACC,MAAM,EAAEF,CAAC,GAC3CN,cAAc,CAACC,KAAK,EAAEC,IAAI,CAACK,UAAU,CAACD,CAAC;YACzC,MAAM;QACR,IAAI,CAAC,CAAc;YACjB,GAAG,CAAE,GAAG,CAACA,EAAC,GAAG,CAAC,EAAEA,EAAC,GAAGJ,IAAI,CAACO,QAAQ,CAACD,MAAM,EAAEF,EAAC,GAAI,CAAC;gBAC9C,KAAK,CAACI,OAAO,GAAGR,IAAI,CAACO,QAAQ,CAACH,EAAC;gBAC/B,EAAE,EAAEI,OAAO,EAAEV,cAAc,CAACC,KAAK,EAAES,OAAO;YAC5C,CAAC;YACD,MAAM;QACR,IAAI,CAAC,CAAU;YACbV,cAAc,CAACC,KAAK,EAAEC,IAAI,CAACG,KAAK;YAChC,MAAM;QACR,IAAI,CAAC,CAAmB;YACtBL,cAAc,CAACC,KAAK,EAAEC,IAAI,CAACS,IAAI;YAC/B,MAAM;QACR,IAAI,CAAC,CAAa;YAChBX,cAAc,CAACC,KAAK,EAAEC,IAAI,CAACU,QAAQ;YACnC,MAAM;QACR,IAAI,CAAC,CAAyB;YAC5BZ,cAAc,CAACC,KAAK,EAAEC,IAAI,CAACW,UAAU;YACrC,MAAM;;YAEN,MAAM;;AAEZ,CAAC;eAEcC,oBAAoB,CACjCC,YAAoB,EACpBC,iBAAyB,EACzBf,KAAoB,EACL,CAAC;IAChB,KAAK,CAACgB,IAAI,OAvCsB,QAAmB,oBAuCpB,CAAC;QAC9BC,QAAQ,EAAEH,YAAY;QACtBI,YAAY,EAAE,IAAI;IACpB,CAAC;IAED,KAAK,CAAC,CAAC,CAACC,IAAI,EAAC,CAAC,GAAG,KAAK,KA9CF,IAAW,QA8CFJ,iBAAiB,EAAE,CAAC;WAC5CC,IAAI,CAACI,GAAG,CAACC,MAAM;QAClBC,QAAQ,EAAE,IAAI;IAChB,CAAC;IACD,GAAG,CAAE,GAAG,CAACjB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGc,IAAI,CAACZ,MAAM,EAAEF,CAAC,GAAI,CAAC;QACrC,KAAK,CAACJ,IAAI,GAAGkB,IAAI,CAACd,CAAC;QACnB,MAAM,CAAEJ,IAAI,CAACC,IAAI;YACf,EAA0C,AAA1C,wCAA0C;YAC1C,EAA+B,AAA/B,6BAA+B;YAC/B,IAAI,CAAC,CAA0B;gBAC7BF,KAAK,CAACG,IAAI,CAAC,CAAS;gBACpB,QAAQ;YACV,IAAI,CAAC,CAAwB;gBAC3B,EAAE,EAAEF,IAAI,CAACsB,WAAW,EAAE,CAAC;oBACrB,EAAE,EAAEtB,IAAI,CAACsB,WAAW,CAACrB,IAAI,KAAK,CAAqB,sBAAE,CAAC;wBACpD,KAAK,CAACsB,YAAY,GAAGvB,IAAI,CAACsB,WAAW,CAACC,YAAY;wBAClD,GAAG,CAAE,GAAG,CAACC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGD,YAAY,CAACjB,MAAM,EAAEkB,CAAC,GAAI,CAAC;4BAC7C1B,cAAc,CAACC,KAAK,EAAEwB,YAAY,CAACC,CAAC,EAAEC,EAAE;wBAC1C,CAAC;oBACH,CAAC,MAAM,CAAC;wBACN3B,cAAc,CAACC,KAAK,EAAEC,IAAI,CAACsB,WAAW,CAACG,EAAE;oBAC3C,CAAC;gBACH,CAAC;gBACD,EAAE,EAAEzB,IAAI,CAAC0B,WAAW,EAAE,CAAC;oBACrB,KAAK,CAACA,WAAW,GAAG1B,IAAI,CAAC0B,WAAW;oBACpC,GAAG,CAAE,GAAG,CAACF,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGE,WAAW,CAACpB,MAAM,EAAEkB,CAAC,GAAI,CAAC;wBAC5C1B,cAAc,CAACC,KAAK,EAAE2B,WAAW,CAACF,CAAC,EAAEG,QAAQ;oBAC/C,CAAC;gBACH,CAAC;gBACD,QAAQ;;gBAER,KAAK;;IAEX,CAAC;AACH,CAAC;eAE6B9B,eAAe,CAE3C+B,MAAc,EACG,CAAC;IAClB,KAAK,CAAC,CAAC,CAACf,YAAY,GAAEgB,aAAa,EAAC,CAAC,GAAG,IAAI;IAE5C,EAAE,EAAEA,aAAa,KAAK,CAAS,UAAE,MAAM,CAACD,MAAM;IAE9C,GAAG,CAACE,GAAG,GAAGjB,YAAY;IACtB,KAAK,CAACC,iBAAiB,GAAGc,MAAM;IAChC,EAAE,EAAE,MAAM,CAACd,iBAAiB,KAAK,CAAQ,SAAE,CAAC;QAC1C,KAAK,CAAC,GAAG,CAACiB,KAAK,CAAC,CAAuD;IACzE,CAAC;IAED,KAAK,CAAChC,KAAK,GAAa,CAAC,CAAC;IAC1B,KAAK,CAACa,oBAAoB,CAACC,YAAY,EAAEC,iBAAiB,EAAEf,KAAK;IAEjE,EAAuC,AAAvC,qCAAuC;IACvC,EAAE,oCAAoCiC,IAAI,CAACF,GAAG,GAAG,CAAC;QAChD/B,KAAK,CAACG,IAAI,CAAC,CAAS;IACtB,CAAC;IAED,GAAG,CAAC+B,MAAM,GACR,CAAkE;IACpE,GAAG,CAAE,GAAG,CAAC7B,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGL,KAAK,CAACO,MAAM,EAAEF,CAAC,GAAI,CAAC;QACtC,KAAK,CAAC8B,IAAI,GAAGnC,KAAK,CAACK,CAAC;QACpB,EAAE,EAAE8B,IAAI,KAAK,CAAS,UAAE,CAAC;YACvBD,MAAM,IAAI,CAAiB;QAC7B,CAAC,MAAM,CAAC;YACNA,MAAM,IAAI,CAAe,iBAAGC,IAAI,GAAG,CAAK;QAC1C,CAAC;QACDD,MAAM,IAAI,CAA0C;QACpDA,MAAM,IAAIE,IAAI,CAACC,SAAS,CAACN,GAAG;QAC5BG,MAAM,IAAI,CAAU;QACpBA,MAAM,IAAIE,IAAI,CAACC,SAAS,CAACF,IAAI;QAC7BD,MAAM,IAAI,CAAM;IAClB,CAAC;IAED,MAAM,CAACA,MAAM;AACf,CAAC"}