{"version":3,"sources":["../../../../build/webpack/loaders/next-flight-server-loader.ts"],"sourcesContent":["// TODO: add ts support for next-swc api\n// @ts-ignore\nimport { parse } from '../../swc'\n// @ts-ignore\nimport { getBaseSWCOptions } from '../../swc/options'\nimport { getRawPageExtensions } from '../../utils'\n\nfunction isClientComponent(importSource: string, pageExtensions: string[]) {\n  return new RegExp(`\\\\.client(\\\\.(${pageExtensions.join('|')}))?`).test(\n    importSource\n  )\n}\n\nfunction isServerComponent(importSource: string, pageExtensions: string[]) {\n  return new RegExp(`\\\\.server(\\\\.(${pageExtensions.join('|')}))?`).test(\n    importSource\n  )\n}\n\nfunction isNextComponent(importSource: string) {\n  return (\n    importSource.includes('next/link') || importSource.includes('next/image')\n  )\n}\n\nexport function isImageImport(importSource: string) {\n  // TODO: share extension with next/image\n  // TODO: add other static assets, jpeg -> jpg\n  return ['jpg', 'jpeg', 'png', 'webp', 'avif'].some((imageExt) =>\n    importSource.endsWith('.' + imageExt)\n  )\n}\n\nasync function parseImportsInfo(\n  resourcePath: string,\n  source: string,\n  imports: Array<string>,\n  isClientCompilation: boolean,\n  pageExtensions: string[]\n): Promise<{\n  source: string\n  defaultExportName: string\n}> {\n  const opts = getBaseSWCOptions({\n    filename: resourcePath,\n    globalWindow: isClientCompilation,\n  })\n\n  const ast = await parse(source, { ...opts.jsc.parser, isModule: true })\n  const { body } = ast\n  const beginPos = ast.span.start\n  let transformedSource = ''\n  let lastIndex = 0\n  let defaultExportName\n  for (let i = 0; i < body.length; i++) {\n    const node = body[i]\n    switch (node.type) {\n      case 'ImportDeclaration': {\n        const importSource = node.source.value\n        if (!isClientCompilation) {\n          if (\n            !(\n              isClientComponent(importSource, pageExtensions) ||\n              isNextComponent(importSource) ||\n              isImageImport(importSource)\n            )\n          ) {\n            continue\n          }\n          const importDeclarations = source.substring(\n            lastIndex,\n            node.source.span.start - beginPos\n          )\n          transformedSource += importDeclarations\n          transformedSource += JSON.stringify(`${node.source.value}?flight`)\n        } else {\n          // For the client compilation, we skip all modules imports but\n          // always keep client components in the bundle. All client components\n          // have to be imported from either server or client components.\n          if (\n            !(\n              isClientComponent(importSource, pageExtensions) ||\n              isServerComponent(importSource, pageExtensions) ||\n              // Special cases for Next.js APIs that are considered as client\n              // components:\n              isNextComponent(importSource) ||\n              isImageImport(importSource)\n            )\n          ) {\n            continue\n          }\n        }\n\n        lastIndex = node.source.span.end - beginPos\n        imports.push(`require(${JSON.stringify(importSource)})`)\n        continue\n      }\n      case 'ExportDefaultDeclaration': {\n        const def = node.decl\n        if (def.type === 'Identifier') {\n          defaultExportName = def.name\n        } else if (def.type === 'FunctionExpression') {\n          defaultExportName = def.identifier.value\n        }\n        break\n      }\n      default:\n        break\n    }\n  }\n\n  if (!isClientCompilation) {\n    transformedSource += source.substring(lastIndex)\n  }\n\n  return { source: transformedSource, defaultExportName }\n}\n\nexport default async function transformSource(\n  this: any,\n  source: string\n): Promise<string> {\n  const { client: isClientCompilation, pageExtensions: pageExtensionsJson } =\n    this.getOptions()\n  const { resourcePath } = this\n  const pageExtensions = JSON.parse(pageExtensionsJson)\n\n  if (typeof source !== 'string') {\n    throw new Error('Expected source to have been transformed to a string.')\n  }\n\n  if (resourcePath.includes('/node_modules/')) {\n    return source\n  }\n\n  const imports: string[] = []\n  const { source: transformedSource, defaultExportName } =\n    await parseImportsInfo(\n      resourcePath,\n      source,\n      imports,\n      isClientCompilation,\n      getRawPageExtensions(pageExtensions)\n    )\n\n  /**\n   * Server side component module output:\n   *\n   * export default function ServerComponent() { ... }\n   * + export const __rsc_noop__=()=>{ ... }\n   * + ServerComponent.__next_rsc__=1;\n   *\n   * Client side component module output:\n   *\n   * The function body of ServerComponent will be removed\n   */\n\n  const noop = `export const __rsc_noop__=()=>{${imports.join(';')}}`\n  const defaultExportNoop = isClientCompilation\n    ? `export default function ${defaultExportName}(){}\\n${defaultExportName}.__next_rsc__=1;`\n    : defaultExportName\n    ? `${defaultExportName}.__next_rsc__=1;`\n    : ''\n\n  const transformed = transformedSource + '\\n' + noop + '\\n' + defaultExportNoop\n\n  return transformed\n}\n"],"names":["isImageImport","transformSource","isClientComponent","importSource","pageExtensions","RegExp","join","test","isServerComponent","isNextComponent","includes","some","imageExt","endsWith","parseImportsInfo","resourcePath","source","imports","isClientCompilation","opts","filename","globalWindow","ast","jsc","parser","isModule","body","beginPos","span","start","transformedSource","lastIndex","defaultExportName","i","length","node","type","value","importDeclarations","substring","JSON","stringify","end","push","def","decl","name","identifier","client","pageExtensionsJson","getOptions","parse","Error","noop","defaultExportNoop","transformed"],"mappings":"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"}