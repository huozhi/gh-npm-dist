{"version":3,"sources":["../../../../build/webpack/plugins/serverless-plugin.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\n\n/**\n * Makes sure there are no dynamic chunks when the target is serverless\n * The dynamic chunks are integrated back into their parent chunk\n * This is to make sure there is a single render bundle instead of that bundle importing dynamic chunks\n */\n\nexport class ServerlessPlugin {\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.compilation.tap('ServerlessPlugin', (compilation) => {\n      const hook = compilation.hooks.optimizeChunks\n\n      hook.tap('ServerlessPlugin', (chunks) => {\n        for (const chunk of chunks) {\n          // If chunk is not an entry point skip them\n          // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n          if (compilation.chunkGraph.getNumberOfEntryModules(chunk) === 0) {\n            continue\n          }\n\n          // Async chunks are usages of import() for example\n          const dynamicChunks = chunk.getAllAsyncChunks()\n          for (const dynamicChunk of dynamicChunks) {\n            // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n            for (const module of compilation.chunkGraph.getChunkModulesIterable(\n              dynamicChunk\n            )) {\n              // Add module back into the entry chunk\n              // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n              if (!compilation.chunkGraph.isModuleInChunk(module, chunk)) {\n                // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n                compilation.chunkGraph.connectChunkAndModule(chunk, module)\n              }\n            }\n          }\n        }\n      })\n    })\n  }\n}\n"],"names":["ServerlessPlugin","apply","compiler","hooks","compilation","tap","hook","optimizeChunks","chunks","chunk","chunkGraph","getNumberOfEntryModules","dynamicChunks","getAllAsyncChunks","dynamicChunk","module","getChunkModulesIterable","isModuleInChunk","connectChunkAndModule"],"mappings":";;;;MAQaA,gBAAgB;IAC3BC,KAAK,CAACC,QAA0B,EAAE,CAAC;QACjCA,QAAQ,CAACC,KAAK,CAACC,WAAW,CAACC,GAAG,CAAC,CAAkB,oBAAGD,WAAW,GAAK,CAAC;YACnE,KAAK,CAACE,IAAI,GAAGF,WAAW,CAACD,KAAK,CAACI,cAAc;YAE7CD,IAAI,CAACD,GAAG,CAAC,CAAkB,oBAAGG,MAAM,GAAK,CAAC;gBACxC,GAAG,EAAE,KAAK,CAACC,KAAK,IAAID,MAAM,CAAE,CAAC;oBAC3B,EAA2C,AAA3C,yCAA2C;oBAC3C,EAA0D,AAA1D,wDAA0D;oBAC1D,EAAE,EAAEJ,WAAW,CAACM,UAAU,CAACC,uBAAuB,CAACF,KAAK,MAAM,CAAC,EAAE,CAAC;wBAChE,QAAQ;oBACV,CAAC;oBAED,EAAkD,AAAlD,gDAAkD;oBAClD,KAAK,CAACG,aAAa,GAAGH,KAAK,CAACI,iBAAiB;oBAC7C,GAAG,EAAE,KAAK,CAACC,YAAY,IAAIF,aAAa,CAAE,CAAC;wBACzC,EAA0D,AAA1D,wDAA0D;wBAC1D,GAAG,EAAE,KAAK,CAACG,MAAM,IAAIX,WAAW,CAACM,UAAU,CAACM,uBAAuB,CACjEF,YAAY,EACX,CAAC;4BACF,EAAuC,AAAvC,qCAAuC;4BACvC,EAA0D,AAA1D,wDAA0D;4BAC1D,EAAE,GAAGV,WAAW,CAACM,UAAU,CAACO,eAAe,CAACF,MAAM,EAAEN,KAAK,GAAG,CAAC;gCAC3D,EAA0D,AAA1D,wDAA0D;gCAC1DL,WAAW,CAACM,UAAU,CAACQ,qBAAqB,CAACT,KAAK,EAAEM,MAAM;4BAC5D,CAAC;wBACH,CAAC;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;;QA/BUf,gBAAgB,GAAhBA,gBAAgB"}