{"version":3,"sources":["../../../../build/webpack/plugins/pages-manifest-plugin.ts"],"sourcesContent":["import { webpack, sources } from 'next/dist/compiled/webpack/webpack'\nimport { PAGES_MANIFEST } from '../../../shared/lib/constants'\nimport getRouteFromEntrypoint from '../../../server/get-route-from-entrypoint'\n\nexport type PagesManifest = { [page: string]: string }\n\n// This plugin creates a pages-manifest.json from page entrypoints.\n// This is used for mapping paths like `/` to `.next/server/static/<buildid>/pages/index.js` when doing SSR\n// It's also used by next export to provide defaultPathMap\nexport default class PagesManifestPlugin implements webpack.Plugin {\n  serverless: boolean\n  dev: boolean\n\n  constructor({ serverless, dev }: { serverless: boolean; dev: boolean }) {\n    this.serverless = serverless\n    this.dev = dev\n  }\n\n  createAssets(compilation: any, assets: any) {\n    const entrypoints = compilation.entrypoints\n    const pages: PagesManifest = {}\n\n    for (const entrypoint of entrypoints.values()) {\n      const pagePath = getRouteFromEntrypoint(entrypoint.name)\n\n      if (!pagePath) {\n        continue\n      }\n\n      const files = entrypoint\n        .getFiles()\n        .filter(\n          (file: string) =>\n            !file.includes('webpack-runtime') &&\n            !file.includes('webpack-api-runtime') &&\n            file.endsWith('.js')\n        )\n\n      // Write filename, replace any backslashes in path (on windows) with forwardslashes for cross-platform consistency.\n      pages[pagePath] = files[files.length - 1]\n\n      if (!this.dev) {\n        pages[pagePath] = pages[pagePath].slice(3)\n      }\n      pages[pagePath] = pages[pagePath].replace(/\\\\/g, '/')\n    }\n\n    assets[`${!this.dev ? '../' : ''}` + PAGES_MANIFEST] =\n      new sources.RawSource(JSON.stringify(pages, null, 2))\n  }\n\n  apply(compiler: webpack.Compiler): void {\n    compiler.hooks.make.tap('NextJsPagesManifest', (compilation) => {\n      // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n      compilation.hooks.processAssets.tap(\n        {\n          name: 'NextJsPagesManifest',\n          // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n          stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n        },\n        (assets: any) => {\n          this.createAssets(compilation, assets)\n        }\n      )\n    })\n  }\n}\n"],"names":["PagesManifestPlugin","serverless","dev","createAssets","compilation","assets","entrypoints","pages","entrypoint","values","pagePath","name","files","getFiles","filter","file","includes","endsWith","length","slice","replace","RawSource","JSON","stringify","apply","compiler","hooks","make","tap","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS"],"mappings":";;;;;AAAiC,GAAoC,CAApC,QAAoC;AACtC,GAA+B,CAA/B,UAA+B;AAC3B,GAA2C,CAA3C,uBAA2C;;;;;;MAOzDA,mBAAmB;gBAI1B,CAAC,CAACC,UAAU,GAAEC,GAAG,EAAwC,CAAC,CAAE,CAAC;QACvE,IAAI,CAACD,UAAU,GAAGA,UAAU;QAC5B,IAAI,CAACC,GAAG,GAAGA,GAAG;IAChB,CAAC;IAEDC,YAAY,CAACC,WAAgB,EAAEC,MAAW,EAAE,CAAC;QAC3C,KAAK,CAACC,WAAW,GAAGF,WAAW,CAACE,WAAW;QAC3C,KAAK,CAACC,KAAK,GAAkB,CAAC,CAAC;QAE/B,GAAG,EAAE,KAAK,CAACC,UAAU,IAAIF,WAAW,CAACG,MAAM,GAAI,CAAC;YAC9C,KAAK,CAACC,QAAQ,OArBe,uBAA2C,UAqBhCF,UAAU,CAACG,IAAI;YAEvD,EAAE,GAAGD,QAAQ,EAAE,CAAC;gBACd,QAAQ;YACV,CAAC;YAED,KAAK,CAACE,KAAK,GAAGJ,UAAU,CACrBK,QAAQ,GACRC,MAAM,EACJC,IAAY,IACVA,IAAI,CAACC,QAAQ,CAAC,CAAiB,sBAC/BD,IAAI,CAACC,QAAQ,CAAC,CAAqB,yBACpCD,IAAI,CAACE,QAAQ,CAAC,CAAK;;YAGzB,EAAmH,AAAnH,iHAAmH;YACnHV,KAAK,CAACG,QAAQ,IAAIE,KAAK,CAACA,KAAK,CAACM,MAAM,GAAG,CAAC;YAExC,EAAE,GAAG,IAAI,CAAChB,GAAG,EAAE,CAAC;gBACdK,KAAK,CAACG,QAAQ,IAAIH,KAAK,CAACG,QAAQ,EAAES,KAAK,CAAC,CAAC;YAC3C,CAAC;YACDZ,KAAK,CAACG,QAAQ,IAAIH,KAAK,CAACG,QAAQ,EAAEU,OAAO,QAAQ,CAAG;QACtD,CAAC;QAEDf,MAAM,KAAK,IAAI,CAACH,GAAG,GAAG,CAAK,OAAG,CAAE,MA9CL,UAA+B,mBA+CxD,GAAG,CAhDwB,QAAoC,SAgDnDmB,SAAS,CAACC,IAAI,CAACC,SAAS,CAAChB,KAAK,EAAE,IAAI,EAAE,CAAC;IACvD,CAAC;IAEDiB,KAAK,CAACC,QAA0B,EAAQ,CAAC;QACvCA,QAAQ,CAACC,KAAK,CAACC,IAAI,CAACC,GAAG,CAAC,CAAqB,uBAAGxB,WAAW,GAAK,CAAC;YAC/D,EAA0D,AAA1D,wDAA0D;YAC1DA,WAAW,CAACsB,KAAK,CAACG,aAAa,CAACD,GAAG,CACjC,CAAC;gBACCjB,IAAI,EAAE,CAAqB;gBAC3B,EAA0D,AAA1D,wDAA0D;gBAC1DmB,KAAK,EA1DkB,QAAoC,SA0D5CC,WAAW,CAACC,8BAA8B;YAC3D,CAAC,GACA3B,MAAW,GAAK,CAAC;gBAChB,IAAI,CAACF,YAAY,CAACC,WAAW,EAAEC,MAAM;YACvC,CAAC;QAEL,CAAC;IACH,CAAC;;kBAxDkBL,mBAAmB"}