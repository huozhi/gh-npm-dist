{"version":3,"sources":["../../../../build/webpack/plugins/functions-manifest-plugin.ts"],"sourcesContent":["import { relative } from 'path'\nimport { sources, webpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { normalizePagePath } from '../../../server/normalize-page-path'\nimport { FUNCTIONS_MANIFEST } from '../../../shared/lib/constants'\nimport { getPageFromPath } from '../../entries'\nimport { collectAssets, getEntrypointInfo } from './middleware-plugin'\n\nconst PLUGIN_NAME = 'FunctionsManifestPlugin'\nexport interface FunctionsManifest {\n  version: 1\n  pages: {\n    [page: string]: {\n      runtime?: string\n      env: string[]\n      files: string[]\n      name: string\n      page: string\n      regexp: string\n    }\n  }\n}\n\nfunction containsPath(outer: string, inner: string) {\n  const rel = relative(outer, inner)\n  return !rel.startsWith('../') && rel !== '..'\n}\nexport default class FunctionsManifestPlugin {\n  dev: boolean\n  pagesDir: string\n  pageExtensions: string[]\n  webServerRuntime: boolean\n  pagesRuntime: Map<string, string>\n\n  constructor({\n    dev,\n    pagesDir,\n    pageExtensions,\n    webServerRuntime,\n  }: {\n    dev: boolean\n    pagesDir: string\n    pageExtensions: string[]\n    webServerRuntime: boolean\n  }) {\n    this.dev = dev\n    this.pagesDir = pagesDir\n    this.webServerRuntime = webServerRuntime\n    this.pageExtensions = pageExtensions\n    this.pagesRuntime = new Map()\n  }\n\n  createAssets(\n    compilation: webpack5.Compilation,\n    assets: any,\n    envPerRoute: Map<string, string[]>,\n    webServerRuntime: boolean\n  ) {\n    const functionsManifest: FunctionsManifest = {\n      version: 1,\n      pages: {},\n    }\n\n    const infos = getEntrypointInfo(compilation, envPerRoute, webServerRuntime)\n    infos.forEach((info) => {\n      const { page } = info\n      // TODO: use global default runtime instead of 'web'\n      const pageRuntime = this.pagesRuntime.get(page)\n      const isWebRuntime =\n        pageRuntime === 'edge' || (this.webServerRuntime && !pageRuntime)\n      functionsManifest.pages[page] = {\n        // Not assign if it's nodejs runtime, project configured node version is used instead\n        ...(isWebRuntime && { runtime: 'web' }),\n        ...info,\n      }\n    })\n\n    const assetPath =\n      (this.webServerRuntime ? '' : 'server/') + FUNCTIONS_MANIFEST\n    assets[assetPath] = new sources.RawSource(\n      JSON.stringify(functionsManifest, null, 2)\n    )\n  }\n\n  apply(compiler: webpack5.Compiler) {\n    const handler = (parser: webpack5.javascript.JavascriptParser) => {\n      parser.hooks.exportSpecifier.tap(\n        PLUGIN_NAME,\n        (statement: any, _identifierName: string, exportName: string) => {\n          const { resource } = parser.state.module\n          const isPagePath = containsPath(this.pagesDir, resource)\n          // Only parse exported config in pages\n          if (!isPagePath) {\n            return\n          }\n          const { declaration } = statement\n          if (exportName === 'config') {\n            const varDecl = declaration.declarations[0]\n            const { properties } = varDecl.init\n            const prop = properties.find((p: any) => p.key.name === 'runtime')\n            if (!prop) return\n            const runtime = prop.value.value\n            if (!['nodejs', 'edge'].includes(runtime))\n              throw new Error(\n                `The runtime option can only be 'nodejs' or 'edge'`\n              )\n\n            // @ts-ignore buildInfo exists on Module\n            parser.state.module.buildInfo.NEXT_runtime = runtime\n          }\n        }\n      )\n    }\n\n    compiler.hooks.compilation.tap(\n      PLUGIN_NAME,\n      (\n        compilation: webpack5.Compilation,\n        { normalModuleFactory: factory }: any\n      ) => {\n        factory.hooks.parser.for('javascript/auto').tap(PLUGIN_NAME, handler)\n        factory.hooks.parser.for('javascript/esm').tap(PLUGIN_NAME, handler)\n\n        compilation.hooks.seal.tap(PLUGIN_NAME, () => {\n          for (const entryData of compilation.entries.values()) {\n            for (const dependency of entryData.dependencies) {\n              // @ts-ignore TODO: webpack 5 types\n              const module = compilation.moduleGraph.getModule(dependency)\n              const outgoingConnections =\n                compilation.moduleGraph.getOutgoingConnectionsByModule(module)\n              if (!outgoingConnections) return\n              const entryModules = outgoingConnections.keys()\n              for (const mod of entryModules) {\n                const runtime = mod?.buildInfo?.NEXT_runtime\n                if (runtime) {\n                  // @ts-ignore: TODO: webpack 5 types\n                  const normalizedPagePath = normalizePagePath(mod.userRequest)\n                  const pagePath = normalizedPagePath.replace(this.pagesDir, '')\n                  const page = getPageFromPath(pagePath, this.pageExtensions)\n                  this.pagesRuntime.set(page, runtime)\n                  break\n                }\n              }\n            }\n          }\n        })\n      }\n    )\n\n    collectAssets(compiler, this.createAssets.bind(this), {\n      dev: this.dev,\n      pluginName: PLUGIN_NAME,\n      webServerRuntime: this.webServerRuntime,\n    })\n  }\n}\n"],"names":["PLUGIN_NAME","containsPath","outer","inner","rel","startsWith","FunctionsManifestPlugin","dev","pagesDir","pageExtensions","webServerRuntime","pagesRuntime","Map","createAssets","compilation","assets","envPerRoute","functionsManifest","version","pages","infos","forEach","info","page","pageRuntime","get","isWebRuntime","runtime","assetPath","RawSource","JSON","stringify","apply","compiler","handler","parser","hooks","exportSpecifier","tap","statement","_identifierName","exportName","resource","state","module","isPagePath","declaration","varDecl","declarations","properties","init","prop","find","p","key","name","value","includes","Error","buildInfo","NEXT_runtime","normalModuleFactory","factory","for","seal","entryData","entries","values","dependency","dependencies","moduleGraph","getModule","outgoingConnections","getOutgoingConnectionsByModule","entryModules","keys","mod","normalizedPagePath","userRequest","pagePath","replace","set","bind","pluginName"],"mappings":"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"}