{"version":3,"sources":["../../../../build/webpack/plugins/next-drop-client-page-plugin.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { STRING_LITERAL_DROP_BUNDLE } from '../../../shared/lib/constants'\n\nexport const ampFirstEntryNamesMap: WeakMap<\n  webpack.compilation.Compilation,\n  string[]\n> = new WeakMap()\n\nconst PLUGIN_NAME = 'DropAmpFirstPagesPlugin'\n\n// Prevents outputting client pages when they are not needed\nexport class DropClientPage implements webpack.Plugin {\n  ampPages = new Set()\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.compilation.tap(\n      PLUGIN_NAME,\n      (compilation: any, { normalModuleFactory }: any) => {\n        // Recursively look up the issuer till it ends up at the root\n        function findEntryModule(mod: any): webpack.compilation.Module | null {\n          const queue = new Set([mod])\n          for (const module of queue) {\n            // @ts-ignore TODO: webpack 5 types\n            const incomingConnections =\n              compilation.moduleGraph.getIncomingConnections(module)\n\n            for (const incomingConnection of incomingConnections) {\n              if (!incomingConnection.originModule) return module\n              queue.add(incomingConnection.originModule)\n            }\n          }\n\n          return null\n        }\n\n        function handler(parser: any) {\n          function markAsAmpFirst() {\n            const entryModule = findEntryModule(parser.state.module)\n\n            if (!entryModule) {\n              return\n            }\n\n            // @ts-ignore buildInfo exists on Module\n            entryModule.buildInfo.NEXT_ampFirst = true\n          }\n\n          parser.hooks.preDeclarator.tap(PLUGIN_NAME, (declarator: any) => {\n            if (declarator?.id?.name === STRING_LITERAL_DROP_BUNDLE) {\n              markAsAmpFirst()\n            }\n          })\n        }\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/auto')\n          .tap(PLUGIN_NAME, handler)\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/esm')\n          .tap(PLUGIN_NAME, handler)\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/dynamic')\n          .tap(PLUGIN_NAME, handler)\n\n        if (!ampFirstEntryNamesMap.has(compilation)) {\n          ampFirstEntryNamesMap.set(compilation, [])\n        }\n\n        const ampFirstEntryNamesItem = ampFirstEntryNamesMap.get(\n          compilation\n        ) as string[]\n\n        compilation.hooks.seal.tap(PLUGIN_NAME, () => {\n          for (const [name, entryData] of compilation.entries) {\n            for (const dependency of entryData.dependencies) {\n              // @ts-ignore TODO: webpack 5 types\n              const module = compilation.moduleGraph.getModule(dependency)\n              if (module?.buildInfo?.NEXT_ampFirst) {\n                ampFirstEntryNamesItem.push(name)\n                // @ts-ignore @types/webpack has outdated types for webpack 5\n                compilation.entries.delete(name)\n              }\n            }\n          }\n        })\n      }\n    )\n  }\n}\n"],"names":["ampFirstEntryNamesMap","WeakMap","PLUGIN_NAME","DropClientPage","apply","compiler","hooks","compilation","tap","normalModuleFactory","findEntryModule","mod","queue","Set","module","incomingConnections","moduleGraph","getIncomingConnections","incomingConnection","originModule","add","handler","parser","markAsAmpFirst","entryModule","state","buildInfo","NEXT_ampFirst","preDeclarator","declarator","id","name","for","has","set","ampFirstEntryNamesItem","get","seal","entryData","entries","dependency","dependencies","getModule","push","delete","ampPages"],"mappings":"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"}