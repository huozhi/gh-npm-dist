{"version":3,"sources":["../../../../build/webpack/plugins/copy-file-plugin.ts"],"sourcesContent":["import { promises as fs } from 'fs'\nimport loaderUtils from 'next/dist/compiled/loader-utils3'\nimport { sources, webpack } from 'next/dist/compiled/webpack/webpack'\n\nconst PLUGIN_NAME = 'CopyFilePlugin'\n\nexport class CopyFilePlugin {\n  private filePath: string\n  private name: string\n  private cacheKey: string\n  private info?: object\n\n  constructor({\n    filePath,\n    cacheKey,\n    name,\n    info,\n  }: {\n    filePath: string\n    cacheKey: string\n    name: string\n    minimize: boolean\n    info?: object\n  }) {\n    this.filePath = filePath\n    this.cacheKey = cacheKey\n    this.name = name\n    this.info = info\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.thisCompilation.tap(PLUGIN_NAME, (compilation: any) => {\n      const cache = compilation.getCache('CopyFilePlugin')\n      const hook = compilation.hooks.processAssets\n      hook.tapPromise(\n        {\n          name: PLUGIN_NAME,\n          // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n          stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n        },\n        async () => {\n          if (cache) {\n            const cachedResult = await cache.getPromise(\n              this.filePath,\n              this.cacheKey\n            )\n            if (cachedResult) {\n              const { file, source } = cachedResult\n              compilation.emitAsset(file, source, {\n                ...this.info,\n              })\n              return\n            }\n          }\n          const content = await fs.readFile(this.filePath, 'utf8')\n\n          const file = loaderUtils.interpolateName(\n            { resourcePath: this.filePath },\n            this.name,\n            { content, context: compiler.context }\n          )\n\n          const source = new sources.RawSource(content)\n\n          if (cache) {\n            await cache.storePromise(this.filePath, this.cacheKey, {\n              file,\n              source,\n            })\n          }\n\n          // @ts-ignore\n          compilation.emitAsset(file, source, {\n            ...this.info,\n          })\n        }\n      )\n    })\n  }\n}\n"],"names":["PLUGIN_NAME","CopyFilePlugin","filePath","cacheKey","name","info","apply","compiler","hooks","thisCompilation","tap","compilation","cache","getCache","hook","processAssets","tapPromise","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS","cachedResult","getPromise","file","source","emitAsset","content","readFile","interpolateName","resourcePath","context","RawSource","storePromise"],"mappings":";;;;AAA+B,GAAI,CAAJ,GAAI;AACX,GAAkC,CAAlC,aAAkC;AACzB,GAAoC,CAApC,QAAoC;;;;;;AAErE,KAAK,CAACA,WAAW,GAAG,CAAgB;MAEvBC,cAAc;gBAMb,CAAC,CACXC,QAAQ,GACRC,QAAQ,GACRC,IAAI,GACJC,IAAI,EAON,CAAC,CAAE,CAAC;QACF,IAAI,CAACH,QAAQ,GAAGA,QAAQ;QACxB,IAAI,CAACC,QAAQ,GAAGA,QAAQ;QACxB,IAAI,CAACC,IAAI,GAAGA,IAAI;QAChB,IAAI,CAACC,IAAI,GAAGA,IAAI;IAClB,CAAC;IAEDC,KAAK,CAACC,QAA0B,EAAE,CAAC;QACjCA,QAAQ,CAACC,KAAK,CAACC,eAAe,CAACC,GAAG,CAACV,WAAW,GAAGW,WAAgB,GAAK,CAAC;YACrE,KAAK,CAACC,KAAK,GAAGD,WAAW,CAACE,QAAQ,CAAC,CAAgB;YACnD,KAAK,CAACC,IAAI,GAAGH,WAAW,CAACH,KAAK,CAACO,aAAa;YAC5CD,IAAI,CAACE,UAAU,CACb,CAAC;gBACCZ,IAAI,EAAEJ,WAAW;gBACjB,EAA0D,AAA1D,wDAA0D;gBAC1DiB,KAAK,EApCkB,QAAoC,SAoC5CC,WAAW,CAACC,8BAA8B;YAC3D,CAAC,YACW,CAAC;gBACX,EAAE,EAAEP,KAAK,EAAE,CAAC;oBACV,KAAK,CAACQ,YAAY,GAAG,KAAK,CAACR,KAAK,CAACS,UAAU,CACzC,IAAI,CAACnB,QAAQ,EACb,IAAI,CAACC,QAAQ;oBAEf,EAAE,EAAEiB,YAAY,EAAE,CAAC;wBACjB,KAAK,CAAC,CAAC,CAACE,IAAI,GAAEC,MAAM,EAAC,CAAC,GAAGH,YAAY;wBACrCT,WAAW,CAACa,SAAS,CAACF,IAAI,EAAEC,MAAM,EAAE,CAAC;+BAChC,IAAI,CAAClB,IAAI;wBACd,CAAC;wBACD,MAAM;oBACR,CAAC;gBACH,CAAC;gBACD,KAAK,CAACoB,OAAO,GAAG,KAAK,CAtDA,GAAI,UAsDAC,QAAQ,CAAC,IAAI,CAACxB,QAAQ,EAAE,CAAM;gBAEvD,KAAK,CAACoB,IAAI,GAvDI,aAAkC,SAuDvBK,eAAe,CACtC,CAAC;oBAACC,YAAY,EAAE,IAAI,CAAC1B,QAAQ;gBAAC,CAAC,EAC/B,IAAI,CAACE,IAAI,EACT,CAAC;oBAACqB,OAAO;oBAAEI,OAAO,EAAEtB,QAAQ,CAACsB,OAAO;gBAAC,CAAC;gBAGxC,KAAK,CAACN,MAAM,GAAG,GAAG,CA5DK,QAAoC,SA4DhCO,SAAS,CAACL,OAAO;gBAE5C,EAAE,EAAEb,KAAK,EAAE,CAAC;oBACV,KAAK,CAACA,KAAK,CAACmB,YAAY,CAAC,IAAI,CAAC7B,QAAQ,EAAE,IAAI,CAACC,QAAQ,EAAE,CAAC;wBACtDmB,IAAI;wBACJC,MAAM;oBACR,CAAC;gBACH,CAAC;gBAED,EAAa,AAAb,WAAa;gBACbZ,WAAW,CAACa,SAAS,CAACF,IAAI,EAAEC,MAAM,EAAE,CAAC;uBAChC,IAAI,CAAClB,IAAI;gBACd,CAAC;YACH,CAAC;QAEL,CAAC;IACH,CAAC;;QAxEUJ,cAAc,GAAdA,cAAc"}