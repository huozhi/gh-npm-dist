{"version":3,"sources":["../../../../build/webpack/plugins/middleware-plugin.ts"],"sourcesContent":["import { webpack, sources, webpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { getMiddlewareRegex } from '../../../shared/lib/router/utils'\nimport { getSortedRoutes } from '../../../shared/lib/router/utils'\nimport {\n  MIDDLEWARE_MANIFEST,\n  MIDDLEWARE_FLIGHT_MANIFEST,\n  MIDDLEWARE_BUILD_MANIFEST,\n  MIDDLEWARE_REACT_LOADABLE_MANIFEST,\n  MIDDLEWARE_RUNTIME_WEBPACK,\n  MIDDLEWARE_SSR_RUNTIME_WEBPACK,\n} from '../../../shared/lib/constants'\nimport { nonNullable } from '../../../lib/non-nullable'\n\nconst PLUGIN_NAME = 'MiddlewarePlugin'\nconst MIDDLEWARE_FULL_ROUTE_REGEX = /^pages[/\\\\]?(.*)\\/_middleware$/\n\nexport const ssrEntries = new Map<string, { requireFlightManifest: boolean }>()\n\nexport interface MiddlewareManifest {\n  version: 1\n  sortedMiddleware: string[]\n  clientInfo: [location: string, isSSR: boolean][]\n  middleware: {\n    [page: string]: {\n      env: string[]\n      files: string[]\n      name: string\n      page: string\n      regexp: string\n    }\n  }\n}\n\nconst middlewareManifest: MiddlewareManifest = {\n  sortedMiddleware: [],\n  clientInfo: [],\n  middleware: {},\n  version: 1,\n}\n\nfunction getPageFromEntrypointName(pagePath: string) {\n  const ssrEntryInfo = ssrEntries.get(pagePath)\n  const result = MIDDLEWARE_FULL_ROUTE_REGEX.exec(pagePath)\n  const page = result\n    ? `/${result[1]}`\n    : ssrEntryInfo\n    ? pagePath.slice('pages'.length).replace(/\\/index$/, '') || '/'\n    : null\n  return page\n}\n\nexport function getEntrypointInfo(\n  compilation: webpack5.Compilation,\n  envPerRoute: Map<string, string[]>,\n  webServerRuntime: boolean\n) {\n  const entrypoints = compilation.entrypoints\n  const infos = []\n  for (const entrypoint of entrypoints.values()) {\n    if (!entrypoint.name) continue\n\n    const ssrEntryInfo = ssrEntries.get(entrypoint.name)\n\n    if (ssrEntryInfo && !webServerRuntime) continue\n    if (!ssrEntryInfo && webServerRuntime) continue\n\n    const page = getPageFromEntrypointName(entrypoint.name)\n\n    if (!page) {\n      continue\n    }\n\n    const entryFiles = entrypoint\n      .getFiles()\n      .filter((file: string) => !file.endsWith('.hot-update.js'))\n\n    const files = ssrEntryInfo\n      ? [\n          ssrEntryInfo.requireFlightManifest\n            ? `server/${MIDDLEWARE_FLIGHT_MANIFEST}.js`\n            : null,\n          `server/${MIDDLEWARE_BUILD_MANIFEST}.js`,\n          `server/${MIDDLEWARE_REACT_LOADABLE_MANIFEST}.js`,\n          ...entryFiles.map((file) => 'server/' + file),\n        ].filter(nonNullable)\n      : entryFiles.map((file: string) => file)\n\n    infos.push({\n      env: envPerRoute.get(entrypoint.name) || [],\n      files,\n      name: entrypoint.name,\n      page,\n      regexp: getMiddlewareRegex(page, !ssrEntryInfo).namedRegex!,\n    })\n  }\n  return infos\n}\n\nexport default class MiddlewarePlugin {\n  dev: boolean\n  webServerRuntime: boolean\n\n  constructor({\n    dev,\n    webServerRuntime,\n  }: {\n    dev: boolean\n    webServerRuntime: boolean\n  }) {\n    this.dev = dev\n    this.webServerRuntime = webServerRuntime\n  }\n\n  createAssets(\n    compilation: webpack5.Compilation,\n    assets: any,\n    envPerRoute: Map<string, string[]>,\n    webServerRuntime: boolean\n  ) {\n    const infos = getEntrypointInfo(compilation, envPerRoute, webServerRuntime)\n    infos.forEach((info) => {\n      middlewareManifest.middleware[info.page] = info\n    })\n\n    middlewareManifest.sortedMiddleware = getSortedRoutes(\n      Object.keys(middlewareManifest.middleware)\n    )\n    middlewareManifest.clientInfo = middlewareManifest.sortedMiddleware.map(\n      (key) => {\n        const middleware = middlewareManifest.middleware[key]\n        const ssrEntryInfo = ssrEntries.get(middleware.name)\n        return [key, !!ssrEntryInfo]\n      }\n    )\n\n    assets[\n      this.webServerRuntime\n        ? MIDDLEWARE_MANIFEST\n        : `server/${MIDDLEWARE_MANIFEST}`\n    ] = new sources.RawSource(JSON.stringify(middlewareManifest, null, 2))\n  }\n\n  apply(compiler: webpack5.Compiler) {\n    collectAssets(compiler, this.createAssets.bind(this), {\n      dev: this.dev,\n      pluginName: PLUGIN_NAME,\n      webServerRuntime: this.webServerRuntime,\n    })\n  }\n}\n\nexport function collectAssets(\n  compiler: webpack5.Compiler,\n  createAssets: (\n    compilation: webpack5.Compilation,\n    assets: any,\n    envPerRoute: Map<string, string[]>,\n    webServerRuntime: boolean\n  ) => void,\n  options: {\n    dev: boolean\n    pluginName: string\n    webServerRuntime: boolean\n  }\n) {\n  const wp = compiler.webpack\n  compiler.hooks.compilation.tap(\n    options.pluginName,\n    (compilation, { normalModuleFactory }) => {\n      compilation.hooks.afterChunks.tap(options.pluginName, () => {\n        const middlewareRuntimeChunk = compilation.namedChunks.get(\n          MIDDLEWARE_RUNTIME_WEBPACK\n        )\n        if (middlewareRuntimeChunk) {\n          middlewareRuntimeChunk.filenameTemplate = 'server/[name].js'\n        }\n      })\n\n      const envPerRoute = new Map<string, string[]>()\n\n      compilation.hooks.afterOptimizeModules.tap(PLUGIN_NAME, () => {\n        const { moduleGraph } = compilation as any\n        envPerRoute.clear()\n\n        for (const [name, info] of compilation.entries) {\n          if (\n            info.options.runtime === MIDDLEWARE_SSR_RUNTIME_WEBPACK ||\n            info.options.runtime === MIDDLEWARE_RUNTIME_WEBPACK\n          ) {\n            const middlewareEntries = new Set<webpack5.Module>()\n            const env = new Set<string>()\n\n            const addEntriesFromDependency = (dep: any) => {\n              const module = moduleGraph.getModule(dep)\n              if (module) {\n                middlewareEntries.add(module)\n              }\n            }\n\n            const runtime = wp.util.runtime.getEntryRuntime(compilation, name)\n\n            info.dependencies.forEach(addEntriesFromDependency)\n            info.includeDependencies.forEach(addEntriesFromDependency)\n\n            const queue = new Set(middlewareEntries)\n            for (const module of queue) {\n              const { buildInfo } = module\n              if (\n                !options.dev &&\n                buildInfo &&\n                isUsedByExports({\n                  module,\n                  moduleGraph,\n                  runtime,\n                  usedByExports: buildInfo.usingIndirectEval,\n                })\n              ) {\n                if (\n                  /node_modules[\\\\/]regenerator-runtime[\\\\/]runtime\\.js/.test(\n                    module.identifier()\n                  )\n                )\n                  continue\n                const error = new wp.WebpackError(\n                  `Dynamic Code Evaluation (e. g. 'eval', 'new Function') not allowed in Middleware ${name}${\n                    typeof buildInfo.usingIndirectEval !== 'boolean'\n                      ? `\\nUsed by ${Array.from(\n                          buildInfo.usingIndirectEval\n                        ).join(', ')}`\n                      : ''\n                  }`\n                )\n                error.module = module\n                compilation.errors.push(error)\n              }\n\n              if (buildInfo?.nextUsedEnvVars !== undefined) {\n                for (const envName of buildInfo.nextUsedEnvVars) {\n                  env.add(envName)\n                }\n              }\n\n              const connections = moduleGraph.getOutgoingConnections(module)\n              for (const connection of connections) {\n                if (connection.module) {\n                  queue.add(connection.module)\n                }\n              }\n            }\n\n            envPerRoute.set(name, Array.from(env))\n          }\n        }\n      })\n\n      const handler = (parser: webpack5.javascript.JavascriptParser) => {\n        const isMiddlewareModule = () =>\n          parser.state.module && parser.state.module.layer === 'middleware'\n\n        const wrapExpression = (expr: any) => {\n          if (!isMiddlewareModule()) return\n\n          if (options.dev) {\n            const dep1 = new wp.dependencies.ConstDependency(\n              '__next_eval__(function() { return ',\n              expr.range[0]\n            )\n            dep1.loc = expr.loc\n            parser.state.module.addPresentationalDependency(dep1)\n            const dep2 = new wp.dependencies.ConstDependency(\n              '})',\n              expr.range[1]\n            )\n            dep2.loc = expr.loc\n            parser.state.module.addPresentationalDependency(dep2)\n          }\n          expressionHandler()\n          return true\n        }\n\n        const flagModule = (\n          usedByExports: boolean | Set<string> | undefined\n        ) => {\n          if (usedByExports === undefined) usedByExports = true\n          const old = parser.state.module.buildInfo.usingIndirectEval\n          if (old === true || usedByExports === false) return\n          if (!old || usedByExports === true) {\n            parser.state.module.buildInfo.usingIndirectEval = usedByExports\n            return\n          }\n          const set = new Set(old)\n          for (const item of usedByExports) {\n            set.add(item)\n          }\n          parser.state.module.buildInfo.usingIndirectEval = set\n        }\n\n        const expressionHandler = () => {\n          if (!isMiddlewareModule()) return\n\n          wp.optimize.InnerGraph.onUsage(parser.state, flagModule)\n        }\n\n        const ignore = () => {\n          if (!isMiddlewareModule()) return\n\n          return true\n        }\n\n        // wrapping\n        parser.hooks.call.for('eval').tap(PLUGIN_NAME, wrapExpression)\n        parser.hooks.call.for('global.eval').tap(PLUGIN_NAME, wrapExpression)\n        parser.hooks.call.for('Function').tap(PLUGIN_NAME, wrapExpression)\n        parser.hooks.call\n          .for('global.Function')\n          .tap(PLUGIN_NAME, wrapExpression)\n        parser.hooks.new.for('Function').tap(PLUGIN_NAME, wrapExpression)\n        parser.hooks.new.for('global.Function').tap(PLUGIN_NAME, wrapExpression)\n\n        // fallbacks\n        parser.hooks.expression.for('eval').tap(PLUGIN_NAME, expressionHandler)\n        parser.hooks.expression\n          .for('Function')\n          .tap(PLUGIN_NAME, expressionHandler)\n        parser.hooks.expression\n          .for('Function.prototype')\n          .tap(PLUGIN_NAME, ignore)\n        parser.hooks.expression\n          .for('global.eval')\n          .tap(PLUGIN_NAME, expressionHandler)\n        parser.hooks.expression\n          .for('global.Function')\n          .tap(PLUGIN_NAME, expressionHandler)\n        parser.hooks.expression\n          .for('global.Function.prototype')\n          .tap(PLUGIN_NAME, ignore)\n\n        const memberChainHandler = (_expr: any, members: string[]) => {\n          if (members.length >= 2 && members[0] === 'env') {\n            const envName = members[1]\n            const { buildInfo } = parser.state.module\n            if (buildInfo.nextUsedEnvVars === undefined) {\n              buildInfo.nextUsedEnvVars = new Set()\n            }\n\n            buildInfo.nextUsedEnvVars.add(envName)\n            if (isMiddlewareModule()) return true\n          }\n        }\n\n        parser.hooks.callMemberChain\n          .for('process')\n          .tap(PLUGIN_NAME, memberChainHandler)\n\n        parser.hooks.expressionMemberChain\n          .for('process')\n          .tap(PLUGIN_NAME, memberChainHandler)\n      }\n\n      normalModuleFactory.hooks.parser\n        .for('javascript/auto')\n        .tap(PLUGIN_NAME, handler)\n\n      normalModuleFactory.hooks.parser\n        .for('javascript/dynamic')\n        .tap(PLUGIN_NAME, handler)\n\n      normalModuleFactory.hooks.parser\n        .for('javascript/esm')\n        .tap(PLUGIN_NAME, handler)\n\n      // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n      compilation.hooks.processAssets.tap(\n        {\n          name: 'NextJsMiddlewareManifest',\n          // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n          stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n        },\n        (assets: any) => {\n          createAssets(\n            compilation,\n            assets,\n            envPerRoute,\n            options.webServerRuntime\n          )\n        }\n      )\n    }\n  )\n}\n\nfunction isUsedByExports(args: {\n  module: webpack5.Module\n  moduleGraph: webpack5.ModuleGraph\n  runtime: any\n  usedByExports: boolean | Set<string> | undefined\n}): boolean {\n  const { moduleGraph, runtime, module, usedByExports } = args\n  if (usedByExports === undefined) return false\n  if (typeof usedByExports === 'boolean') return usedByExports\n  const exportsInfo = moduleGraph.getExportsInfo(module)\n  const wp = webpack as unknown as typeof webpack5\n  for (const exportName of usedByExports) {\n    if (exportsInfo.getUsed(exportName, runtime) !== wp.UsageState.Unused)\n      return true\n  }\n  return false\n}\n"],"names":["getEntrypointInfo","collectAssets","PLUGIN_NAME","MIDDLEWARE_FULL_ROUTE_REGEX","ssrEntries","Map","middlewareManifest","sortedMiddleware","clientInfo","middleware","version","getPageFromEntrypointName","pagePath","ssrEntryInfo","get","result","exec","page","slice","length","replace","compilation","envPerRoute","webServerRuntime","entrypoints","infos","entrypoint","values","name","entryFiles","getFiles","filter","file","endsWith","files","requireFlightManifest","map","push","env","regexp","namedRegex","MiddlewarePlugin","dev","createAssets","assets","forEach","info","Object","keys","key","RawSource","JSON","stringify","apply","compiler","bind","pluginName","options","wp","webpack","hooks","tap","normalModuleFactory","afterChunks","middlewareRuntimeChunk","namedChunks","filenameTemplate","afterOptimizeModules","moduleGraph","clear","entries","runtime","middlewareEntries","Set","addEntriesFromDependency","dep","module","getModule","add","util","getEntryRuntime","dependencies","includeDependencies","queue","buildInfo","isUsedByExports","usedByExports","usingIndirectEval","test","identifier","error","WebpackError","Array","from","join","errors","nextUsedEnvVars","undefined","envName","connections","getOutgoingConnections","connection","set","handler","parser","isMiddlewareModule","state","layer","wrapExpression","expr","dep1","ConstDependency","range","loc","addPresentationalDependency","dep2","expressionHandler","flagModule","old","item","optimize","InnerGraph","onUsage","ignore","call","for","new","expression","memberChainHandler","_expr","members","callMemberChain","expressionMemberChain","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS","args","exportsInfo","getExportsInfo","exportName","getUsed","UsageState","Unused"],"mappings":"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"}