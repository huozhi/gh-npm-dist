{"version":3,"sources":["../../../../build/webpack/plugins/nextjs-require-cache-hot-reloader.ts"],"sourcesContent":["import type { webpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { clearModuleContext } from '../../../server/web/sandbox'\nimport { realpathSync } from 'fs'\nimport path from 'path'\nimport isError from '../../../lib/is-error'\n\ntype Compiler = webpack5.Compiler\ntype WebpackPluginInstance = webpack5.WebpackPluginInstance\n\nconst originModules = [\n  require.resolve('../../../server/require'),\n  require.resolve('../../../server/load-components'),\n]\n\nconst RUNTIME_NAMES = ['webpack-runtime', 'webpack-api-runtime']\n\nfunction deleteCache(filePath: string) {\n  try {\n    filePath = realpathSync(filePath)\n  } catch (e) {\n    if (isError(e) && e.code !== 'ENOENT') throw e\n  }\n  const module = require.cache[filePath]\n  if (module) {\n    // remove the child reference from the originModules\n    for (const originModule of originModules) {\n      const parent = require.cache[originModule]\n      if (parent) {\n        const idx = parent.children.indexOf(module)\n        if (idx >= 0) parent.children.splice(idx, 1)\n      }\n    }\n    // remove parent references from external modules\n    for (const child of module.children) {\n      child.parent = null\n    }\n  }\n  delete require.cache[filePath]\n}\n\nconst PLUGIN_NAME = 'NextJsRequireCacheHotReloader'\n\n// This plugin flushes require.cache after emitting the files. Providing 'hot reloading' of server files.\nexport class NextJsRequireCacheHotReloader implements WebpackPluginInstance {\n  prevAssets: any = null\n  previousOutputPathsWebpack5: Set<string> = new Set()\n  currentOutputPathsWebpack5: Set<string> = new Set()\n\n  apply(compiler: Compiler) {\n    compiler.hooks.assetEmitted.tap(\n      PLUGIN_NAME,\n      (_file, { targetPath, content }) => {\n        this.currentOutputPathsWebpack5.add(targetPath)\n        deleteCache(targetPath)\n        clearModuleContext(targetPath, content.toString('utf-8'))\n      }\n    )\n\n    compiler.hooks.afterEmit.tap(PLUGIN_NAME, (compilation) => {\n      RUNTIME_NAMES.forEach((name) => {\n        const runtimeChunkPath = path.join(\n          compilation.outputOptions.path!,\n          `${name}.js`\n        )\n        deleteCache(runtimeChunkPath)\n      })\n\n      // we need to make sure to clear all server entries from cache\n      // since they can have a stale webpack-runtime cache\n      // which needs to always be in-sync\n      const entries = [...compilation.entries.keys()].filter((entry) =>\n        entry.toString().startsWith('pages/')\n      )\n\n      entries.forEach((page) => {\n        const outputPath = path.join(\n          compilation.outputOptions.path!,\n          page + '.js'\n        )\n        deleteCache(outputPath)\n      })\n    })\n\n    this.previousOutputPathsWebpack5 = new Set(this.currentOutputPathsWebpack5)\n    this.currentOutputPathsWebpack5.clear()\n  }\n}\n"],"names":["originModules","require","resolve","RUNTIME_NAMES","deleteCache","filePath","e","code","module","cache","originModule","parent","idx","children","indexOf","splice","child","PLUGIN_NAME","NextJsRequireCacheHotReloader","apply","compiler","hooks","assetEmitted","tap","_file","targetPath","content","currentOutputPathsWebpack5","add","toString","afterEmit","compilation","forEach","name","runtimeChunkPath","join","outputOptions","path","entries","keys","filter","entry","startsWith","page","outputPath","previousOutputPathsWebpack5","Set","clear","prevAssets"],"mappings":";;;;AACmC,GAA6B,CAA7B,QAA6B;AACnC,GAAI,CAAJ,GAAI;AAChB,GAAM,CAAN,KAAM;AACH,GAAuB,CAAvB,QAAuB;;;;;;AAK3C,KAAK,CAACA,aAAa,GAAG,CAAC;IACrBC,OAAO,CAACC,OAAO,CAAC,CAAyB;IACzCD,OAAO,CAACC,OAAO,CAAC,CAAiC;AACnD,CAAC;AAED,KAAK,CAACC,aAAa,GAAG,CAAC;IAAA,CAAiB;IAAE,CAAqB;AAAA,CAAC;SAEvDC,WAAW,CAACC,QAAgB,EAAE,CAAC;IACtC,GAAG,CAAC,CAAC;QACHA,QAAQ,OAhBiB,GAAI,eAgBLA,QAAQ;IAClC,CAAC,CAAC,KAAK,EAAEC,CAAC,EAAE,CAAC;QACX,EAAE,MAhBc,QAAuB,UAgB3BA,CAAC,KAAKA,CAAC,CAACC,IAAI,KAAK,CAAQ,SAAE,KAAK,CAACD,CAAC;IAChD,CAAC;IACD,KAAK,CAACE,MAAM,GAAGP,OAAO,CAACQ,KAAK,CAACJ,QAAQ;IACrC,EAAE,EAAEG,MAAM,EAAE,CAAC;QACX,EAAoD,AAApD,kDAAoD;QACpD,GAAG,EAAE,KAAK,CAACE,YAAY,IAAIV,aAAa,CAAE,CAAC;YACzC,KAAK,CAACW,MAAM,GAAGV,OAAO,CAACQ,KAAK,CAACC,YAAY;YACzC,EAAE,EAAEC,MAAM,EAAE,CAAC;gBACX,KAAK,CAACC,GAAG,GAAGD,MAAM,CAACE,QAAQ,CAACC,OAAO,CAACN,MAAM;gBAC1C,EAAE,EAAEI,GAAG,IAAI,CAAC,EAAED,MAAM,CAACE,QAAQ,CAACE,MAAM,CAACH,GAAG,EAAE,CAAC;YAC7C,CAAC;QACH,CAAC;QACD,EAAiD,AAAjD,+CAAiD;QACjD,GAAG,EAAE,KAAK,CAACI,KAAK,IAAIR,MAAM,CAACK,QAAQ,CAAE,CAAC;YACpCG,KAAK,CAACL,MAAM,GAAG,IAAI;QACrB,CAAC;IACH,CAAC;IACD,MAAM,CAACV,OAAO,CAACQ,KAAK,CAACJ,QAAQ;AAC/B,CAAC;AAED,KAAK,CAACY,WAAW,GAAG,CAA+B;MAGtCC,6BAA6B;IAKxCC,KAAK,CAACC,QAAkB,EAAE,CAAC;QACzBA,QAAQ,CAACC,KAAK,CAACC,YAAY,CAACC,GAAG,CAC7BN,WAAW,GACVO,KAAK,EAAE,CAAC,CAACC,UAAU,GAAEC,OAAO,EAAC,CAAC,GAAK,CAAC;YACnC,IAAI,CAACC,0BAA0B,CAACC,GAAG,CAACH,UAAU;YAC9CrB,WAAW,CAACqB,UAAU;gBApDK,QAA6B,qBAqDrCA,UAAU,EAAEC,OAAO,CAACG,QAAQ,CAAC,CAAO;QACzD,CAAC;QAGHT,QAAQ,CAACC,KAAK,CAACS,SAAS,CAACP,GAAG,CAACN,WAAW,GAAGc,WAAW,GAAK,CAAC;YAC1D5B,aAAa,CAAC6B,OAAO,EAAEC,IAAI,GAAK,CAAC;gBAC/B,KAAK,CAACC,gBAAgB,GAzDb,KAAM,SAyDeC,IAAI,CAChCJ,WAAW,CAACK,aAAa,CAACC,IAAI,KAC3BJ,IAAI,CAAC,GAAG;gBAEb7B,WAAW,CAAC8B,gBAAgB;YAC9B,CAAC;YAED,EAA8D,AAA9D,4DAA8D;YAC9D,EAAoD,AAApD,kDAAoD;YACpD,EAAmC,AAAnC,iCAAmC;YACnC,KAAK,CAACI,OAAO,GAAG,CAAC;mBAAGP,WAAW,CAACO,OAAO,CAACC,IAAI;YAAE,CAAC,CAACC,MAAM,EAAEC,KAAK,GAC3DA,KAAK,CAACZ,QAAQ,GAAGa,UAAU,CAAC,CAAQ;;YAGtCJ,OAAO,CAACN,OAAO,EAAEW,IAAI,GAAK,CAAC;gBACzB,KAAK,CAACC,UAAU,GAxEP,KAAM,SAwEST,IAAI,CAC1BJ,WAAW,CAACK,aAAa,CAACC,IAAI,EAC9BM,IAAI,GAAG,CAAK;gBAEdvC,WAAW,CAACwC,UAAU;YACxB,CAAC;QACH,CAAC;QAED,IAAI,CAACC,2BAA2B,GAAG,GAAG,CAACC,GAAG,CAAC,IAAI,CAACnB,0BAA0B;QAC1E,IAAI,CAACA,0BAA0B,CAACoB,KAAK;IACvC,CAAC;;QA1CI,IA2CN,CA1CCC,UAAU,GAAQ,IAAI;QADjB,IA2CN,CAzCCH,2BAA2B,GAAgB,GAAG,CAACC,GAAG;QAF7C,IA2CN,CAxCCnB,0BAA0B,GAAgB,GAAG,CAACmB,GAAG;;;QAHtC5B,6BAA6B,GAA7BA,6BAA6B"}