{"version":3,"sources":["../../../../build/webpack/plugins/flight-manifest-plugin.ts"],"sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { webpack, sources } from 'next/dist/compiled/webpack/webpack'\nimport { MIDDLEWARE_FLIGHT_MANIFEST } from '../../../shared/lib/constants'\n\n// This is the module that will be used to anchor all client references to.\n// I.e. it will have all the client files as async deps from this point on.\n// We use the Flight client implementation because you can't get to these\n// without the client runtime so it's the first time in the loading sequence\n// you might want them.\n// const clientFileName = require.resolve('../');\n\ntype Options = {\n  dev: boolean\n  clientComponentsRegex: RegExp\n}\n\nconst PLUGIN_NAME = 'FlightManifestPlugin'\n\nexport class FlightManifestPlugin {\n  dev: boolean = false\n  clientComponentsRegex: RegExp\n\n  constructor(options: Options) {\n    if (typeof options.dev === 'boolean') {\n      this.dev = options.dev\n    }\n    this.clientComponentsRegex = options.clientComponentsRegex\n  }\n\n  apply(compiler: any) {\n    compiler.hooks.compilation.tap(\n      PLUGIN_NAME,\n      (compilation: any, { normalModuleFactory }: any) => {\n        compilation.dependencyFactories.set(\n          (webpack as any).dependencies.ModuleDependency,\n          normalModuleFactory\n        )\n        compilation.dependencyTemplates.set(\n          (webpack as any).dependencies.ModuleDependency,\n          new (webpack as any).dependencies.NullDependency.Template()\n        )\n      }\n    )\n\n    // Only for webpack 5\n    compiler.hooks.make.tap(PLUGIN_NAME, (compilation: any) => {\n      compilation.hooks.processAssets.tap(\n        {\n          name: PLUGIN_NAME,\n          // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n          stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n        },\n        (assets: any) => this.createAsset(assets, compilation)\n      )\n    })\n  }\n\n  createAsset(assets: any, compilation: any) {\n    const json: any = {}\n    const { clientComponentsRegex } = this\n    compilation.chunkGroups.forEach((chunkGroup: any) => {\n      function recordModule(id: string, _chunk: any, mod: any) {\n        const resource = mod.resource?.replace(/\\?flight$/, '')\n\n        // TODO: Hook into deps instead of the target module.\n        // That way we know by the type of dep whether to include.\n        // It also resolves conflicts when the same module is in multiple chunks.\n        const isNextClientComponent = /next[\\\\/](link|image)/.test(resource)\n        if (!clientComponentsRegex.test(resource) && !isNextClientComponent) {\n          return\n        }\n\n        const moduleExports: any = json[resource] || {}\n\n        const exportsInfo = compilation.moduleGraph.getExportsInfo(mod)\n        const providedExports = exportsInfo.getProvidedExports()\n        const moduleExportedKeys = ['', '*'].concat(\n          // TODO: improve exports detection\n          providedExports === true || providedExports == null\n            ? 'default'\n            : providedExports\n        )\n\n        moduleExportedKeys.forEach((name) => {\n          if (!moduleExports[name]) {\n            moduleExports[name] = {\n              id,\n              name,\n              chunks: [],\n            }\n          }\n        })\n        json[resource] = moduleExports\n      }\n\n      chunkGroup.chunks.forEach((chunk: any) => {\n        const chunkModules =\n          compilation.chunkGraph.getChunkModulesIterable(chunk)\n        for (const mod of chunkModules) {\n          let modId = compilation.chunkGraph.getModuleId(mod)\n\n          // remove resource query on production\n          if (typeof modId === 'string') {\n            modId = modId.split('?')[0]\n          }\n          recordModule(modId, chunk, mod)\n          // If this is a concatenation, register each child to the parent ID.\n          if (mod.modules) {\n            mod.modules.forEach((concatenatedMod: any) => {\n              recordModule(modId, chunk, concatenatedMod)\n            })\n          }\n        }\n      })\n    })\n\n    const output = `self.__RSC_MANIFEST=` + JSON.stringify(json)\n    assets[`server/${MIDDLEWARE_FLIGHT_MANIFEST}.js`] = new sources.RawSource(\n      output\n    )\n  }\n}\n"],"names":["PLUGIN_NAME","FlightManifestPlugin","options","dev","clientComponentsRegex","apply","compiler","hooks","compilation","tap","normalModuleFactory","dependencyFactories","set","dependencies","ModuleDependency","dependencyTemplates","NullDependency","Template","make","processAssets","name","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS","assets","createAsset","json","chunkGroups","forEach","chunkGroup","recordModule","id","_chunk","mod","resource","replace","isNextClientComponent","test","moduleExports","exportsInfo","moduleGraph","getExportsInfo","providedExports","getProvidedExports","moduleExportedKeys","concat","chunks","chunk","chunkModules","chunkGraph","getChunkModulesIterable","modId","getModuleId","split","modules","concatenatedMod","output","JSON","stringify","RawSource"],"mappings":";;;;AAOiC,GAAoC,CAApC,QAAoC;AAC1B,GAA+B,CAA/B,UAA+B;AAc1E,KAAK,CAACA,WAAW,GAAG,CAAsB;MAE7BC,oBAAoB;gBAInBC,OAAgB,CAAE,CAAC;QAJ1B,IAuGN,CAtGCC,GAAG,GAAY,KAAK;QAIlB,EAAE,EAAE,MAAM,CAACD,OAAO,CAACC,GAAG,KAAK,CAAS,UAAE,CAAC;YACrC,IAAI,CAACA,GAAG,GAAGD,OAAO,CAACC,GAAG;QACxB,CAAC;QACD,IAAI,CAACC,qBAAqB,GAAGF,OAAO,CAACE,qBAAqB;IAC5D,CAAC;IAEDC,KAAK,CAACC,QAAa,EAAE,CAAC;QACpBA,QAAQ,CAACC,KAAK,CAACC,WAAW,CAACC,GAAG,CAC5BT,WAAW,GACVQ,WAAgB,EAAE,CAAC,CAACE,mBAAmB,EAAM,CAAC,GAAK,CAAC;YACnDF,WAAW,CAACG,mBAAmB,CAACC,GAAG,CAhCV,QAAoC,SAiC1CC,YAAY,CAACC,gBAAgB,EAC9CJ,mBAAmB;YAErBF,WAAW,CAACO,mBAAmB,CAACH,GAAG,CApCV,QAAoC,SAqC1CC,YAAY,CAACC,gBAAgB,EAC9C,GAAG,CAtCoB,QAAoC,SAsCtCD,YAAY,CAACG,cAAc,CAACC,QAAQ;QAE7D,CAAC;QAGH,EAAqB,AAArB,mBAAqB;QACrBX,QAAQ,CAACC,KAAK,CAACW,IAAI,CAACT,GAAG,CAACT,WAAW,GAAGQ,WAAgB,GAAK,CAAC;YAC1DA,WAAW,CAACD,KAAK,CAACY,aAAa,CAACV,GAAG,CACjC,CAAC;gBACCW,IAAI,EAAEpB,WAAW;gBACjB,EAA0D,AAA1D,wDAA0D;gBAC1DqB,KAAK,EAjDkB,QAAoC,SAiD5CC,WAAW,CAACC,8BAA8B;YAC3D,CAAC,GACAC,MAAW,GAAK,IAAI,CAACC,WAAW,CAACD,MAAM,EAAEhB,WAAW;;QAEzD,CAAC;IACH,CAAC;IAEDiB,WAAW,CAACD,MAAW,EAAEhB,WAAgB,EAAE,CAAC;QAC1C,KAAK,CAACkB,IAAI,GAAQ,CAAC,CAAC;QACpB,KAAK,CAAC,CAAC,CAACtB,qBAAqB,EAAC,CAAC,GAAG,IAAI;QACtCI,WAAW,CAACmB,WAAW,CAACC,OAAO,EAAEC,UAAe,GAAK,CAAC;qBAC3CC,YAAY,CAACC,EAAU,EAAEC,MAAW,EAAEC,GAAQ,EAAE,CAAC;oBACvCA,GAAY;gBAA7B,KAAK,CAACC,QAAQ,IAAGD,GAAY,GAAZA,GAAG,CAACC,QAAQ,cAAZD,GAAY,KAAZA,IAAIC,CAAJD,CAAqB,GAArBA,IAAIC,CAAJD,CAAqB,GAArBA,GAAY,CAAEE,OAAO,cAAc,CAAE;gBAEtD,EAAqD,AAArD,mDAAqD;gBACrD,EAA0D,AAA1D,wDAA0D;gBAC1D,EAAyE,AAAzE,uEAAyE;gBACzE,KAAK,CAACC,qBAAqB,2BAA2BC,IAAI,CAACH,QAAQ;gBACnE,EAAE,GAAG9B,qBAAqB,CAACiC,IAAI,CAACH,QAAQ,MAAME,qBAAqB,EAAE,CAAC;oBACpE,MAAM;gBACR,CAAC;gBAED,KAAK,CAACE,aAAa,GAAQZ,IAAI,CAACQ,QAAQ,KAAK,CAAC,CAAC;gBAE/C,KAAK,CAACK,WAAW,GAAG/B,WAAW,CAACgC,WAAW,CAACC,cAAc,CAACR,GAAG;gBAC9D,KAAK,CAACS,eAAe,GAAGH,WAAW,CAACI,kBAAkB;gBACtD,KAAK,CAACC,kBAAkB,GAAG,CAAC;oBAAA,CAAE;oBAAE,CAAG;gBAAA,CAAC,CAACC,MAAM,CACzC,EAAkC,AAAlC,gCAAkC;gBAClCH,eAAe,KAAK,IAAI,IAAIA,eAAe,IAAI,IAAI,GAC/C,CAAS,WACTA,eAAe;gBAGrBE,kBAAkB,CAAChB,OAAO,EAAER,IAAI,GAAK,CAAC;oBACpC,EAAE,GAAGkB,aAAa,CAAClB,IAAI,GAAG,CAAC;wBACzBkB,aAAa,CAAClB,IAAI,IAAI,CAAC;4BACrBW,EAAE;4BACFX,IAAI;4BACJ0B,MAAM,EAAE,CAAC,CAAC;wBACZ,CAAC;oBACH,CAAC;gBACH,CAAC;gBACDpB,IAAI,CAACQ,QAAQ,IAAII,aAAa;YAChC,CAAC;YAEDT,UAAU,CAACiB,MAAM,CAAClB,OAAO,EAAEmB,KAAU,GAAK,CAAC;gBACzC,KAAK,CAACC,YAAY,GAChBxC,WAAW,CAACyC,UAAU,CAACC,uBAAuB,CAACH,KAAK;gBACtD,GAAG,EAAE,KAAK,CAACd,GAAG,IAAIe,YAAY,CAAE,CAAC;oBAC/B,GAAG,CAACG,KAAK,GAAG3C,WAAW,CAACyC,UAAU,CAACG,WAAW,CAACnB,GAAG;oBAElD,EAAsC,AAAtC,oCAAsC;oBACtC,EAAE,EAAE,MAAM,CAACkB,KAAK,KAAK,CAAQ,SAAE,CAAC;wBAC9BA,KAAK,GAAGA,KAAK,CAACE,KAAK,CAAC,CAAG,IAAE,CAAC;oBAC5B,CAAC;oBACDvB,YAAY,CAACqB,KAAK,EAAEJ,KAAK,EAAEd,GAAG;oBAC9B,EAAoE,AAApE,kEAAoE;oBACpE,EAAE,EAAEA,GAAG,CAACqB,OAAO,EAAE,CAAC;wBAChBrB,GAAG,CAACqB,OAAO,CAAC1B,OAAO,EAAE2B,eAAoB,GAAK,CAAC;4BAC7CzB,YAAY,CAACqB,KAAK,EAAEJ,KAAK,EAAEQ,eAAe;wBAC5C,CAAC;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;QAED,KAAK,CAACC,MAAM,IAAI,oBAAoB,IAAIC,IAAI,CAACC,SAAS,CAAChC,IAAI;QAC3DF,MAAM,EAAE,OAAO,EAnHwB,UAA+B,4BAmH1B,GAAG,KAAK,GAAG,CApH1B,QAAoC,SAoHDmC,SAAS,CACvEH,MAAM;IAEV,CAAC;;QAtGUvD,oBAAoB,GAApBA,oBAAoB"}