{"version":3,"sources":["../../build/compiler.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\nimport type { webpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { Span } from '../trace'\n\nexport type CompilerResult = {\n  errors: webpack5.StatsError[]\n  warnings: webpack5.StatsError[]\n}\n\nfunction generateStats(\n  result: CompilerResult,\n  stat: webpack5.Stats\n): CompilerResult {\n  const { errors, warnings } = stat.toJson({\n    preset: 'errors-warnings',\n    moduleTrace: true,\n  })\n  if (errors && errors.length > 0) {\n    result.errors.push(...errors)\n  }\n\n  if (warnings && warnings.length > 0) {\n    result.warnings.push(...warnings)\n  }\n\n  return result\n}\n\n// Webpack 5 requires the compiler to be closed (to save caches)\n// Webpack 4 does not have this close method so in order to be backwards compatible we check if it exists\nfunction closeCompiler(compiler: webpack5.Compiler | webpack5.MultiCompiler) {\n  return new Promise<void>((resolve, reject) => {\n    // @ts-ignore Close only exists on the compiler in webpack 5\n    return compiler.close((err: any) => (err ? reject(err) : resolve()))\n  })\n}\n\nexport function runCompiler(\n  config: webpack.Configuration,\n  { runWebpackSpan }: { runWebpackSpan: Span }\n): Promise<CompilerResult> {\n  return new Promise((resolve, reject) => {\n    const compiler = webpack(config) as unknown as webpack5.Compiler\n    compiler.run((err, stats) => {\n      const webpackCloseSpan = runWebpackSpan.traceChild('webpack-close', {\n        name: config.name,\n      })\n      webpackCloseSpan\n        .traceAsyncFn(() => closeCompiler(compiler))\n        .then(() => {\n          if (err) {\n            const reason = err.stack ?? err.toString()\n            if (reason) {\n              return resolve({\n                errors: [{ message: reason, details: (err as any).details }],\n                warnings: [],\n              })\n            }\n            return reject(err)\n          } else if (!stats) throw new Error('No Stats from webpack')\n\n          const result = webpackCloseSpan\n            .traceChild('webpack-generate-error-stats')\n            .traceFn(() => generateStats({ errors: [], warnings: [] }, stats))\n          return resolve(result)\n        })\n    })\n  })\n}\n"],"names":["runCompiler","generateStats","result","stat","errors","warnings","toJson","preset","moduleTrace","length","push","closeCompiler","compiler","Promise","resolve","reject","close","err","config","runWebpackSpan","run","stats","webpackCloseSpan","traceChild","name","traceAsyncFn","then","reason","stack","toString","message","details","Error","traceFn"],"mappings":";;;;QAqCgBA,WAAW,GAAXA,WAAW;AArCH,GAAoC,CAApC,QAAoC;SASnDC,aAAa,CACpBC,MAAsB,EACtBC,IAAoB,EACJ,CAAC;IACjB,KAAK,CAAC,CAAC,CAACC,MAAM,GAAEC,QAAQ,EAAC,CAAC,GAAGF,IAAI,CAACG,MAAM,CAAC,CAAC;QACxCC,MAAM,EAAE,CAAiB;QACzBC,WAAW,EAAE,IAAI;IACnB,CAAC;IACD,EAAE,EAAEJ,MAAM,IAAIA,MAAM,CAACK,MAAM,GAAG,CAAC,EAAE,CAAC;QAChCP,MAAM,CAACE,MAAM,CAACM,IAAI,IAAIN,MAAM;IAC9B,CAAC;IAED,EAAE,EAAEC,QAAQ,IAAIA,QAAQ,CAACI,MAAM,GAAG,CAAC,EAAE,CAAC;QACpCP,MAAM,CAACG,QAAQ,CAACK,IAAI,IAAIL,QAAQ;IAClC,CAAC;IAED,MAAM,CAACH,MAAM;AACf,CAAC;AAED,EAAgE,AAAhE,8DAAgE;AAChE,EAAyG,AAAzG,uGAAyG;SAChGS,aAAa,CAACC,QAAoD,EAAE,CAAC;IAC5E,MAAM,CAAC,GAAG,CAACC,OAAO,EAAQC,OAAO,EAAEC,MAAM,GAAK,CAAC;QAC7C,EAA4D,AAA5D,0DAA4D;QAC5D,MAAM,CAACH,QAAQ,CAACI,KAAK,EAAEC,GAAQ,GAAMA,GAAG,GAAGF,MAAM,CAACE,GAAG,IAAIH,OAAO;;IAClE,CAAC;AACH,CAAC;SAEed,WAAW,CACzBkB,MAA6B,EAC7B,CAAC,CAACC,cAAc,EAA2B,CAAC,EACnB,CAAC;IAC1B,MAAM,CAAC,GAAG,CAACN,OAAO,EAAEC,OAAO,EAAEC,MAAM,GAAK,CAAC;QACvC,KAAK,CAACH,QAAQ,OA1CM,QAAoC,UA0C/BM,MAAM;QAC/BN,QAAQ,CAACQ,GAAG,EAAEH,GAAG,EAAEI,KAAK,GAAK,CAAC;YAC5B,KAAK,CAACC,gBAAgB,GAAGH,cAAc,CAACI,UAAU,CAAC,CAAe,gBAAE,CAAC;gBACnEC,IAAI,EAAEN,MAAM,CAACM,IAAI;YACnB,CAAC;YACDF,gBAAgB,CACbG,YAAY,KAAOd,aAAa,CAACC,QAAQ;cACzCc,IAAI,KAAO,CAAC;gBACX,EAAE,EAAET,GAAG,EAAE,CAAC;wBACOA,MAAS;oBAAxB,KAAK,CAACU,MAAM,IAAGV,MAAS,GAATA,GAAG,CAACW,KAAK,cAATX,MAAS,cAATA,MAAS,GAAIA,GAAG,CAACY,QAAQ;oBACxC,EAAE,EAAEF,MAAM,EAAE,CAAC;wBACX,MAAM,CAACb,OAAO,CAAC,CAAC;4BACdV,MAAM,EAAE,CAAC;gCAAA,CAAC;oCAAC0B,OAAO,EAAEH,MAAM;oCAAEI,OAAO,EAAGd,GAAG,CAASc,OAAO;gCAAC,CAAC;4BAAA,CAAC;4BAC5D1B,QAAQ,EAAE,CAAC,CAAC;wBACd,CAAC;oBACH,CAAC;oBACD,MAAM,CAACU,MAAM,CAACE,GAAG;gBACnB,CAAC,MAAM,EAAE,GAAGI,KAAK,EAAE,KAAK,CAAC,GAAG,CAACW,KAAK,CAAC,CAAuB;gBAE1D,KAAK,CAAC9B,MAAM,GAAGoB,gBAAgB,CAC5BC,UAAU,CAAC,CAA8B,+BACzCU,OAAO,KAAOhC,aAAa,CAAC,CAAC;wBAACG,MAAM,EAAE,CAAC,CAAC;wBAAEC,QAAQ,EAAE,CAAC,CAAC;oBAAC,CAAC,EAAEgB,KAAK;;gBAClE,MAAM,CAACP,OAAO,CAACZ,MAAM;YACvB,CAAC;QACL,CAAC;IACH,CAAC;AACH,CAAC"}