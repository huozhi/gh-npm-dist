{"version":3,"sources":["../../cli/next-dev.ts"],"sourcesContent":["#!/usr/bin/env node\nimport arg from 'next/dist/compiled/arg/index.js'\nimport { existsSync } from 'fs'\nimport { startServer } from '../server/lib/start-server'\nimport { printAndExit } from '../server/lib/utils'\nimport * as Log from '../build/output/log'\nimport { startedDevelopmentServer } from '../build/output'\nimport { cliCommand } from '../bin/next'\nimport isError from '../lib/is-error'\nimport { getProjectDir } from '../lib/get-project-dir'\n\nconst nextDev: cliCommand = (argv) => {\n  const validArgs: arg.Spec = {\n    // Types\n    '--help': Boolean,\n    '--port': Number,\n    '--hostname': String,\n\n    // Aliases\n    '-h': '--help',\n    '-p': '--port',\n    '-H': '--hostname',\n  }\n  let args: arg.Result<arg.Spec>\n  try {\n    args = arg(validArgs, { argv })\n  } catch (error) {\n    if (isError(error) && error.code === 'ARG_UNKNOWN_OPTION') {\n      return printAndExit(error.message, 1)\n    }\n    throw error\n  }\n  if (args['--help']) {\n    console.log(`\n      Description\n        Starts the application in development mode (hot-code reloading, error\n        reporting, etc)\n\n      Usage\n        $ next dev <dir> -p <port number>\n\n      <dir> represents the directory of the Next.js application.\n      If no directory is provided, the current directory will be used.\n\n      Options\n        --port, -p      A port number on which to start the application\n        --hostname, -H  Hostname on which to start the application (default: 0.0.0.0)\n        --help, -h      Displays this message\n    `)\n    process.exit(0)\n  }\n\n  const dir = getProjectDir(args._[0])\n\n  // Check if pages dir exists and warn if not\n  if (!existsSync(dir)) {\n    printAndExit(`> No such directory exists as the project root: ${dir}`)\n  }\n\n  async function preflight() {\n    const { getPackageVersion } = await Promise.resolve(\n      require('../lib/get-package-version')\n    )\n    const [sassVersion, nodeSassVersion] = await Promise.all([\n      getPackageVersion({ cwd: dir, name: 'sass' }),\n      getPackageVersion({ cwd: dir, name: 'node-sass' }),\n    ])\n    if (sassVersion && nodeSassVersion) {\n      Log.warn(\n        'Your project has both `sass` and `node-sass` installed as dependencies, but should only use one or the other. ' +\n          'Please remove the `node-sass` dependency from your project. ' +\n          ' Read more: https://nextjs.org/docs/messages/duplicate-sass'\n      )\n    }\n  }\n  const allowRetry = !args['--port']\n  let port: number =\n    args['--port'] || (process.env.PORT && parseInt(process.env.PORT)) || 3000\n\n  // we allow the server to use a random port while testing\n  // instead of attempting to find a random port and then hope\n  // it doesn't become occupied before we leverage it\n  if (process.env.__NEXT_RAND_PORT) {\n    port = 0\n  }\n\n  // We do not set a default host value here to prevent breaking\n  // some set-ups that rely on listening on other interfaces\n  const host = args['--hostname']\n\n  startServer({\n    allowRetry,\n    dev: true,\n    dir,\n    hostname: host,\n    isNextDevCommand: true,\n    port,\n  })\n    .then(async (app) => {\n      const appUrl = `http://${app.hostname}:${app.port}`\n      startedDevelopmentServer(appUrl, `${host || '0.0.0.0'}:${app.port}`)\n      // Start preflight after server is listening and ignore errors:\n      preflight().catch(() => {})\n      // Finalize server bootup:\n      await app.prepare()\n    })\n    .catch((err) => {\n      if (err.code === 'EADDRINUSE') {\n        let errorMessage = `Port ${port} is already in use.`\n        const pkgAppPath = require('next/dist/compiled/find-up').sync(\n          'package.json',\n          {\n            cwd: dir,\n          }\n        )\n        const appPackage = require(pkgAppPath)\n        if (appPackage.scripts) {\n          const nextScript = Object.entries(appPackage.scripts).find(\n            (scriptLine) => scriptLine[1] === 'next'\n          )\n          if (nextScript) {\n            errorMessage += `\\nUse \\`npm run ${nextScript[0]} -- -p <some other port>\\`.`\n          }\n        }\n        console.error(errorMessage)\n      } else {\n        console.error(err)\n      }\n      process.nextTick(() => process.exit(1))\n    })\n}\n\nexport { nextDev }\n"],"names":["Log","nextDev","argv","validArgs","Boolean","Number","String","args","error","code","message","console","log","process","exit","dir","_","preflight","getPackageVersion","Promise","resolve","require","sassVersion","nodeSassVersion","all","cwd","name","warn","allowRetry","port","env","PORT","parseInt","__NEXT_RAND_PORT","host","dev","hostname","isNextDevCommand","then","app","appUrl","catch","prepare","err","errorMessage","pkgAppPath","sync","appPackage","scripts","nextScript","Object","entries","find","scriptLine","nextTick"],"mappings":"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"}