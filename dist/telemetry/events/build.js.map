{"version":3,"sources":["../../../telemetry/events/build.ts"],"sourcesContent":["import { TelemetryPlugin } from '../../build/webpack/plugins/telemetry-plugin'\n\nconst REGEXP_DIRECTORY_DUNDER =\n  /[\\\\/]__[^\\\\/]+(?<![\\\\/]__(?:tests|mocks))__[\\\\/]/i\nconst REGEXP_DIRECTORY_TESTS = /[\\\\/]__(tests|mocks)__[\\\\/]/i\nconst REGEXP_FILE_TEST = /\\.(?:spec|test)\\.[^.]+$/i\n\nconst EVENT_TYPE_CHECK_COMPLETED = 'NEXT_TYPE_CHECK_COMPLETED'\ntype EventTypeCheckCompleted = {\n  durationInSeconds: number\n  typescriptVersion: string | null\n  inputFilesCount?: number\n  totalFilesCount?: number\n  incremental?: boolean\n}\n\nexport function eventTypeCheckCompleted(event: EventTypeCheckCompleted): {\n  eventName: string\n  payload: EventTypeCheckCompleted\n} {\n  return {\n    eventName: EVENT_TYPE_CHECK_COMPLETED,\n    payload: event,\n  }\n}\n\nconst EVENT_LINT_CHECK_COMPLETED = 'NEXT_LINT_CHECK_COMPLETED'\nexport type EventLintCheckCompleted = {\n  durationInSeconds: number\n  eslintVersion: string | null\n  lintedFilesCount?: number\n  lintFix?: boolean\n  buildLint?: boolean\n  nextEslintPluginVersion?: string | null\n  nextEslintPluginErrorsCount?: number\n  nextEslintPluginWarningsCount?: number\n}\n\nexport function eventLintCheckCompleted(event: EventLintCheckCompleted): {\n  eventName: string\n  payload: EventLintCheckCompleted\n} {\n  return {\n    eventName: EVENT_LINT_CHECK_COMPLETED,\n    payload: event,\n  }\n}\n\nconst EVENT_BUILD_COMPLETED = 'NEXT_BUILD_COMPLETED'\ntype EventBuildCompleted = {\n  durationInSeconds: number\n  totalPageCount: number\n  hasDunderPages: boolean\n  hasTestPages: boolean\n}\n\nexport function eventBuildCompleted(\n  pagePaths: string[],\n  event: Omit<\n    EventBuildCompleted,\n    'totalPageCount' | 'hasDunderPages' | 'hasTestPages'\n  >\n): { eventName: string; payload: EventBuildCompleted } {\n  return {\n    eventName: EVENT_BUILD_COMPLETED,\n    payload: {\n      ...event,\n      totalPageCount: pagePaths.length,\n      hasDunderPages: pagePaths.some((path) =>\n        REGEXP_DIRECTORY_DUNDER.test(path)\n      ),\n      hasTestPages: pagePaths.some(\n        (path) =>\n          REGEXP_DIRECTORY_TESTS.test(path) || REGEXP_FILE_TEST.test(path)\n      ),\n    },\n  }\n}\n\nconst EVENT_BUILD_OPTIMIZED = 'NEXT_BUILD_OPTIMIZED'\ntype EventBuildOptimized = {\n  durationInSeconds: number\n  totalPageCount: number\n  staticPageCount: number\n  staticPropsPageCount: number\n  serverPropsPageCount: number\n  ssrPageCount: number\n  hasDunderPages: boolean\n  hasTestPages: boolean\n  hasStatic404: boolean\n  hasReportWebVitals: boolean\n  headersCount: number\n  rewritesCount: number\n  redirectsCount: number\n  headersWithHasCount: number\n  rewritesWithHasCount: number\n  redirectsWithHasCount: number\n  middlewareCount: number\n}\n\nexport function eventBuildOptimize(\n  pagePaths: string[],\n  event: Omit<\n    EventBuildOptimized,\n    'totalPageCount' | 'hasDunderPages' | 'hasTestPages'\n  >\n): { eventName: string; payload: EventBuildOptimized } {\n  return {\n    eventName: EVENT_BUILD_OPTIMIZED,\n    payload: {\n      ...event,\n      totalPageCount: pagePaths.length,\n      hasDunderPages: pagePaths.some((path) =>\n        REGEXP_DIRECTORY_DUNDER.test(path)\n      ),\n      hasTestPages: pagePaths.some(\n        (path) =>\n          REGEXP_DIRECTORY_TESTS.test(path) || REGEXP_FILE_TEST.test(path)\n      ),\n    },\n  }\n}\n\nexport const EVENT_BUILD_FEATURE_USAGE = 'NEXT_BUILD_FEATURE_USAGE'\nexport type EventBuildFeatureUsage = {\n  // NOTE: If you are adding features, make sure to update the `enum` field\n  // for `featureName` in https://github.com/vercel/next-telemetry/blob/master/events/v1/featureUsage.ts\n  // *before* you make changes here.\n  featureName:\n    | 'next/image'\n    | 'next/script'\n    | 'next/dynamic'\n    | 'experimental/optimizeCss'\n    | 'optimizeFonts'\n    | 'swcLoader'\n    | 'swcMinify'\n    | 'build-lint'\n  invocationCount: number\n}\nexport function eventBuildFeatureUsage(\n  telemetryPlugin: TelemetryPlugin\n): Array<{ eventName: string; payload: EventBuildFeatureUsage }> {\n  return telemetryPlugin.usages().map(({ featureName, invocationCount }) => ({\n    eventName: EVENT_BUILD_FEATURE_USAGE,\n    payload: {\n      featureName,\n      invocationCount,\n    },\n  }))\n}\n"],"names":["eventTypeCheckCompleted","eventLintCheckCompleted","eventBuildCompleted","eventBuildOptimize","eventBuildFeatureUsage","REGEXP_DIRECTORY_DUNDER","REGEXP_DIRECTORY_TESTS","REGEXP_FILE_TEST","EVENT_TYPE_CHECK_COMPLETED","event","eventName","payload","EVENT_LINT_CHECK_COMPLETED","EVENT_BUILD_COMPLETED","pagePaths","totalPageCount","length","hasDunderPages","some","path","test","hasTestPages","EVENT_BUILD_OPTIMIZED","EVENT_BUILD_FEATURE_USAGE","telemetryPlugin","usages","map","featureName","invocationCount"],"mappings":";;;;QAgBgBA,uBAAuB,GAAvBA,uBAAuB;QAsBvBC,uBAAuB,GAAvBA,uBAAuB;QAkBvBC,mBAAmB,GAAnBA,mBAAmB;QA4CnBC,kBAAkB,GAAlBA,kBAAkB;QAuClBC,sBAAsB,GAAtBA,sBAAsB;;AAzItC,KAAK,CAACC,uBAAuB;AAE7B,KAAK,CAACC,sBAAsB;AAC5B,KAAK,CAACC,gBAAgB;AAEtB,KAAK,CAACC,0BAA0B,GAAG,CAA2B;SAS9CR,uBAAuB,CAACS,KAA8B,EAGpE,CAAC;IACD,MAAM,CAAC,CAAC;QACNC,SAAS,EAAEF,0BAA0B;QACrCG,OAAO,EAAEF,KAAK;IAChB,CAAC;AACH,CAAC;AAED,KAAK,CAACG,0BAA0B,GAAG,CAA2B;SAY9CX,uBAAuB,CAACQ,KAA8B,EAGpE,CAAC;IACD,MAAM,CAAC,CAAC;QACNC,SAAS,EAAEE,0BAA0B;QACrCD,OAAO,EAAEF,KAAK;IAChB,CAAC;AACH,CAAC;AAED,KAAK,CAACI,qBAAqB,GAAG,CAAsB;SAQpCX,mBAAmB,CACjCY,SAAmB,EACnBL,KAGC,EACoD,CAAC;IACtD,MAAM,CAAC,CAAC;QACNC,SAAS,EAAEG,qBAAqB;QAChCF,OAAO,EAAE,CAAC;eACLF,KAAK;YACRM,cAAc,EAAED,SAAS,CAACE,MAAM;YAChCC,cAAc,EAAEH,SAAS,CAACI,IAAI,EAAEC,IAAI,GAClCd,uBAAuB,CAACe,IAAI,CAACD,IAAI;;YAEnCE,YAAY,EAAEP,SAAS,CAACI,IAAI,EACzBC,IAAI,GACHb,sBAAsB,CAACc,IAAI,CAACD,IAAI,KAAKZ,gBAAgB,CAACa,IAAI,CAACD,IAAI;;QAErE,CAAC;IACH,CAAC;AACH,CAAC;AAED,KAAK,CAACG,qBAAqB,GAAG,CAAsB;SAqBpCnB,kBAAkB,CAChCW,SAAmB,EACnBL,KAGC,EACoD,CAAC;IACtD,MAAM,CAAC,CAAC;QACNC,SAAS,EAAEY,qBAAqB;QAChCX,OAAO,EAAE,CAAC;eACLF,KAAK;YACRM,cAAc,EAAED,SAAS,CAACE,MAAM;YAChCC,cAAc,EAAEH,SAAS,CAACI,IAAI,EAAEC,IAAI,GAClCd,uBAAuB,CAACe,IAAI,CAACD,IAAI;;YAEnCE,YAAY,EAAEP,SAAS,CAACI,IAAI,EACzBC,IAAI,GACHb,sBAAsB,CAACc,IAAI,CAACD,IAAI,KAAKZ,gBAAgB,CAACa,IAAI,CAACD,IAAI;;QAErE,CAAC;IACH,CAAC;AACH,CAAC;AAEM,KAAK,CAACI,yBAAyB,GAAG,CAA0B;QAAtDA,yBAAyB,GAAzBA,yBAAyB;SAgBtBnB,sBAAsB,CACpCoB,eAAgC,EAC+B,CAAC;IAChE,MAAM,CAACA,eAAe,CAACC,MAAM,GAAGC,GAAG,EAAE,CAAC,CAACC,WAAW,GAAEC,eAAe,EAAC,CAAC,IAAM,CAAC;YAC1ElB,SAAS,EAAEa,yBAAyB;YACpCZ,OAAO,EAAE,CAAC;gBACRgB,WAAW;gBACXC,eAAe;YACjB,CAAC;QACH,CAAC;;AACH,CAAC"}