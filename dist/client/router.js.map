{"version":3,"sources":["../../client/router.ts"],"sourcesContent":["/* global window */\nimport React from 'react'\nimport Router from '../shared/lib/router/router'\nimport type { NextRouter } from '../shared/lib/router/router'\nimport { RouterContext } from '../shared/lib/router-context'\nimport isError from '../lib/is-error'\n\ntype ClassArguments<T> = T extends new (...args: infer U) => any ? U : any\n\ntype RouterArgs = ClassArguments<typeof Router>\n\ntype SingletonRouterBase = {\n  router: Router | null\n  readyCallbacks: Array<() => any>\n  ready(cb: () => any): void\n}\n\nexport { Router }\n\nexport type { NextRouter }\n\nexport type SingletonRouter = SingletonRouterBase & NextRouter\n\nconst singletonRouter: SingletonRouterBase = {\n  router: null, // holds the actual router instance\n  readyCallbacks: [],\n  ready(cb: () => void) {\n    if (this.router) return cb()\n    if (typeof window !== 'undefined') {\n      this.readyCallbacks.push(cb)\n    }\n  },\n}\n\n// Create public properties and methods of the router in the singletonRouter\nconst urlPropertyFields = [\n  'pathname',\n  'route',\n  'query',\n  'asPath',\n  'components',\n  'isFallback',\n  'basePath',\n  'locale',\n  'locales',\n  'defaultLocale',\n  'isReady',\n  'isPreview',\n  'isLocaleDomain',\n  'domainLocales',\n]\nconst routerEvents = [\n  'routeChangeStart',\n  'beforeHistoryChange',\n  'routeChangeComplete',\n  'routeChangeError',\n  'hashChangeStart',\n  'hashChangeComplete',\n] as const\nexport type RouterEvent = typeof routerEvents[number]\n\nconst coreMethodFields = [\n  'push',\n  'replace',\n  'reload',\n  'back',\n  'prefetch',\n  'beforePopState',\n]\n\n// Events is a static property on the router, the router doesn't have to be initialized to use it\nObject.defineProperty(singletonRouter, 'events', {\n  get() {\n    return Router.events\n  },\n})\n\nurlPropertyFields.forEach((field: string) => {\n  // Here we need to use Object.defineProperty because we need to return\n  // the property assigned to the actual router\n  // The value might get changed as we change routes and this is the\n  // proper way to access it\n  Object.defineProperty(singletonRouter, field, {\n    get() {\n      const router = getRouter() as any\n      return router[field] as string\n    },\n  })\n})\n\ncoreMethodFields.forEach((field: string) => {\n  // We don't really know the types here, so we add them later instead\n  ;(singletonRouter as any)[field] = (...args: any[]) => {\n    const router = getRouter() as any\n    return router[field](...args)\n  }\n})\n\nrouterEvents.forEach((event) => {\n  singletonRouter.ready(() => {\n    Router.events.on(event, (...args) => {\n      const eventField = `on${event.charAt(0).toUpperCase()}${event.substring(\n        1\n      )}`\n      const _singletonRouter = singletonRouter as any\n      if (_singletonRouter[eventField]) {\n        try {\n          _singletonRouter[eventField](...args)\n        } catch (err) {\n          console.error(`Error when running the Router event: ${eventField}`)\n          console.error(\n            isError(err) ? `${err.message}\\n${err.stack}` : err + ''\n          )\n        }\n      }\n    })\n  })\n})\n\nfunction getRouter(): Router {\n  if (!singletonRouter.router) {\n    const message =\n      'No router instance found.\\n' +\n      'You should only use \"next/router\" on the client side of your app.\\n'\n    throw new Error(message)\n  }\n  return singletonRouter.router\n}\n\n// Export the singletonRouter and this is the public API.\nexport default singletonRouter as SingletonRouter\n\n// Reexport the withRoute HOC\nexport { default as withRouter } from './with-router'\n\nexport function useRouter(): NextRouter {\n  return React.useContext(RouterContext)\n}\n\n// INTERNAL APIS\n// -------------\n// (do not use following exports inside the app)\n\n// Create a router and assign it as the singleton instance.\n// This is used in client side when we are initializing the app.\n// This should **not** be used inside the server.\nexport function createRouter(...args: RouterArgs): Router {\n  singletonRouter.router = new Router(...args)\n  singletonRouter.readyCallbacks.forEach((cb) => cb())\n  singletonRouter.readyCallbacks = []\n\n  return singletonRouter.router\n}\n\n// This function is used to create the `withRouter` router instance\nexport function makePublicRouterInstance(router: Router): NextRouter {\n  const scopedRouter = router as any\n  const instance = {} as any\n\n  for (const property of urlPropertyFields) {\n    if (typeof scopedRouter[property] === 'object') {\n      instance[property] = Object.assign(\n        Array.isArray(scopedRouter[property]) ? [] : {},\n        scopedRouter[property]\n      ) // makes sure query is not stateful\n      continue\n    }\n\n    instance[property] = scopedRouter[property]\n  }\n\n  // Events is a static property on the router, the router doesn't have to be initialized to use it\n  instance.events = Router.events\n\n  coreMethodFields.forEach((field) => {\n    instance[field] = (...args: any[]) => {\n      return scopedRouter[field](...args)\n    }\n  })\n\n  return instance\n}\n"],"names":["Router","withRouter","default","useRouter","createRouter","makePublicRouterInstance","singletonRouter","router","readyCallbacks","ready","cb","window","push","urlPropertyFields","routerEvents","coreMethodFields","Object","defineProperty","get","events","forEach","field","getRouter","args","event","on","eventField","charAt","toUpperCase","substring","_singletonRouter","err","console","error","message","stack","Error","useContext","scopedRouter","instance","property","assign","Array","isArray"],"mappings":"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"}