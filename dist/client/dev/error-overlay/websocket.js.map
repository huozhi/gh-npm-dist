{"version":3,"sources":["../../../../client/dev/error-overlay/websocket.ts"],"sourcesContent":["let source: WebSocket\nconst eventCallbacks: ((event: any) => void)[] = []\nlet lastActivity = Date.now()\n\nfunction getSocketProtocol(assetPrefix: string): string {\n  let protocol = location.protocol\n\n  try {\n    // assetPrefix is a url\n    protocol = new URL(assetPrefix).protocol\n  } catch (_) {}\n\n  return protocol === 'http:' ? 'ws' : 'wss'\n}\n\nexport function addMessageListener(cb: (event: any) => void) {\n  eventCallbacks.push(cb)\n}\n\nexport function sendMessage(data: any) {\n  if (!source || source.readyState !== source.OPEN) return\n  return source.send(data)\n}\n\nexport function connectHMR(options: {\n  path: string\n  assetPrefix: string\n  timeout: number\n  log?: boolean\n}) {\n  if (!options.timeout) {\n    options.timeout = 5 * 1000\n  }\n\n  init()\n\n  let timer = setInterval(function () {\n    if (Date.now() - lastActivity > options.timeout) {\n      handleDisconnect()\n    }\n  }, options.timeout / 2)\n\n  function init() {\n    if (source) source.close()\n    const { hostname, port } = location\n    const protocol = getSocketProtocol(options.assetPrefix || '')\n    const assetPrefix = options.assetPrefix.replace(/^\\/+/, '')\n\n    let url = `${protocol}://${hostname}:${port}${\n      assetPrefix ? `/${assetPrefix}` : ''\n    }`\n\n    if (assetPrefix.startsWith('http')) {\n      url = `${protocol}://${assetPrefix.split('://')[1]}`\n    }\n\n    source = new window.WebSocket(`${url}${options.path}`)\n    source.onopen = handleOnline\n    source.onerror = handleDisconnect\n    source.onmessage = handleMessage\n  }\n\n  function handleOnline() {\n    if (options.log) console.log('[HMR] connected')\n    lastActivity = Date.now()\n  }\n\n  function handleMessage(event: any) {\n    lastActivity = Date.now()\n\n    eventCallbacks.forEach((cb) => {\n      cb(event)\n    })\n  }\n\n  function handleDisconnect() {\n    clearInterval(timer)\n    source.close()\n    setTimeout(init, options.timeout)\n  }\n}\n"],"names":["addMessageListener","sendMessage","connectHMR","source","eventCallbacks","lastActivity","Date","now","getSocketProtocol","assetPrefix","protocol","location","URL","_","cb","push","data","readyState","OPEN","send","options","timeout","init","timer","setInterval","handleDisconnect","close","hostname","port","replace","url","startsWith","split","window","WebSocket","path","onopen","handleOnline","onerror","onmessage","handleMessage","log","console","event","forEach","clearInterval","setTimeout"],"mappings":"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"}