{"version":3,"sources":["../../client/script.tsx"],"sourcesContent":["import React, { useEffect, useContext } from 'react'\nimport { ScriptHTMLAttributes } from 'react'\nimport { HeadManagerContext } from '../shared/lib/head-manager-context'\nimport { DOMAttributeNames } from './head-manager'\nimport { requestIdleCallback } from './request-idle-callback'\n\nconst ScriptCache = new Map()\nconst LoadCache = new Set()\n\nexport interface ScriptProps extends ScriptHTMLAttributes<HTMLScriptElement> {\n  strategy?: 'afterInteractive' | 'lazyOnload' | 'beforeInteractive'\n  id?: string\n  onLoad?: (e: any) => void\n  onError?: (e: any) => void\n  children?: React.ReactNode\n}\n\n/**\n * @deprecated Use `ScriptProps` instead.\n */\nexport type Props = ScriptProps\n\nconst ignoreProps = [\n  'onLoad',\n  'dangerouslySetInnerHTML',\n  'children',\n  'onError',\n  'strategy',\n]\n\nconst loadScript = (props: ScriptProps): void => {\n  const {\n    src,\n    id,\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    strategy = 'afterInteractive',\n    onError,\n  } = props\n\n  const cacheKey = id || src\n\n  // Script has already loaded\n  if (cacheKey && LoadCache.has(cacheKey)) {\n    return\n  }\n\n  // Contents of this script are already loading/loaded\n  if (ScriptCache.has(src)) {\n    LoadCache.add(cacheKey)\n    // Execute onLoad since the script loading has begun\n    ScriptCache.get(src).then(onLoad, onError)\n    return\n  }\n\n  const el = document.createElement('script')\n\n  const loadPromise = new Promise<void>((resolve, reject) => {\n    el.addEventListener('load', function (e) {\n      resolve()\n      if (onLoad) {\n        onLoad.call(this, e)\n      }\n    })\n    el.addEventListener('error', function (e) {\n      reject(e)\n    })\n  }).catch(function (e) {\n    if (onError) {\n      onError(e)\n    }\n  })\n\n  if (src) {\n    ScriptCache.set(src, loadPromise)\n  }\n  LoadCache.add(cacheKey)\n\n  if (dangerouslySetInnerHTML) {\n    el.innerHTML = dangerouslySetInnerHTML.__html || ''\n  } else if (children) {\n    el.textContent =\n      typeof children === 'string'\n        ? children\n        : Array.isArray(children)\n        ? children.join('')\n        : ''\n  } else if (src) {\n    el.src = src\n  }\n\n  for (const [k, value] of Object.entries(props)) {\n    if (value === undefined || ignoreProps.includes(k)) {\n      continue\n    }\n\n    const attr = DOMAttributeNames[k] || k.toLowerCase()\n    el.setAttribute(attr, value)\n  }\n\n  el.setAttribute('data-nscript', strategy)\n\n  document.body.appendChild(el)\n}\n\nfunction handleClientScriptLoad(props: ScriptProps) {\n  const { strategy = 'afterInteractive' } = props\n  if (strategy === 'afterInteractive') {\n    loadScript(props)\n  } else if (strategy === 'lazyOnload') {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nfunction loadLazyScript(props: ScriptProps) {\n  if (document.readyState === 'complete') {\n    requestIdleCallback(() => loadScript(props))\n  } else {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nexport function initScriptLoader(scriptLoaderItems: ScriptProps[]) {\n  scriptLoaderItems.forEach(handleClientScriptLoad)\n}\n\nfunction Script(props: ScriptProps): JSX.Element | null {\n  const {\n    src = '',\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    strategy = 'afterInteractive',\n    onError,\n    ...restProps\n  } = props\n\n  // Context is available only during SSR\n  const { updateScripts, scripts, getIsSsr } = useContext(HeadManagerContext)\n\n  useEffect(() => {\n    if (strategy === 'afterInteractive') {\n      loadScript(props)\n    } else if (strategy === 'lazyOnload') {\n      loadLazyScript(props)\n    }\n  }, [props, strategy])\n\n  if (strategy === 'beforeInteractive') {\n    if (updateScripts) {\n      scripts.beforeInteractive = (scripts.beforeInteractive || []).concat([\n        {\n          src,\n          onLoad,\n          onError,\n          ...restProps,\n        },\n      ])\n      updateScripts(scripts)\n    } else if (getIsSsr && getIsSsr()) {\n      // Script has already loaded during SSR\n      LoadCache.add(restProps.id || src)\n    } else if (getIsSsr && !getIsSsr()) {\n      loadScript(props)\n    }\n  }\n\n  return null\n}\n\nexport default Script\n"],"names":["initScriptLoader","ScriptCache","Map","LoadCache","Set","ignoreProps","loadScript","props","src","id","onLoad","dangerouslySetInnerHTML","children","strategy","onError","cacheKey","has","add","get","then","el","document","createElement","loadPromise","Promise","resolve","reject","addEventListener","e","call","catch","set","innerHTML","__html","textContent","Array","isArray","join","k","value","Object","entries","undefined","includes","attr","toLowerCase","setAttribute","body","appendChild","handleClientScriptLoad","window","loadLazyScript","readyState","scriptLoaderItems","forEach","Script","restProps","updateScripts","scripts","getIsSsr","beforeInteractive","concat"],"mappings":"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"}