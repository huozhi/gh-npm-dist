{"version":3,"sources":["../../client/route-loader.ts"],"sourcesContent":["import type { ComponentType } from 'react'\nimport getAssetPathFromRoute from '../shared/lib/router/utils/get-asset-path-from-route'\nimport { requestIdleCallback } from './request-idle-callback'\n\n// 3.8s was arbitrarily chosen as it's what https://web.dev/interactive\n// considers as \"Good\" time-to-interactive. We must assume something went\n// wrong beyond this point, and then fall-back to a full page transition to\n// show the user something of value.\nconst MS_MAX_IDLE_DELAY = 3800\n\ndeclare global {\n  interface Window {\n    __BUILD_MANIFEST?: Record<string, string[]>\n    __BUILD_MANIFEST_CB?: Function\n    __MIDDLEWARE_MANIFEST?: [location: string, isSSR: boolean][]\n    __MIDDLEWARE_MANIFEST_CB?: Function\n  }\n}\n\ninterface LoadedEntrypointSuccess {\n  component: ComponentType\n  exports: any\n}\ninterface LoadedEntrypointFailure {\n  error: unknown\n}\ntype RouteEntrypoint = LoadedEntrypointSuccess | LoadedEntrypointFailure\n\ninterface RouteStyleSheet {\n  href: string\n  content: string\n}\n\ninterface LoadedRouteSuccess extends LoadedEntrypointSuccess {\n  styles: RouteStyleSheet[]\n}\ninterface LoadedRouteFailure {\n  error: unknown\n}\ntype RouteLoaderEntry = LoadedRouteSuccess | LoadedRouteFailure\n\ninterface Future<V> {\n  resolve: (entrypoint: V) => void\n  future: Promise<V>\n}\nfunction withFuture<T>(\n  key: string,\n  map: Map<string, Future<T> | T>,\n  generator?: () => Promise<T>\n): Promise<T> {\n  let entry: Future<T> | T | undefined = map.get(key)\n  if (entry) {\n    if ('future' in entry) {\n      return entry.future\n    }\n    return Promise.resolve(entry)\n  }\n  let resolver: (entrypoint: T) => void\n  const prom: Promise<T> = new Promise<T>((resolve) => {\n    resolver = resolve\n  })\n  map.set(key, (entry = { resolve: resolver!, future: prom }))\n  return generator\n    ? generator()\n        // eslint-disable-next-line no-sequences\n        .then((value) => (resolver(value), value))\n        .catch((err) => {\n          map.delete(key)\n          throw err\n        })\n    : prom\n}\n\nexport interface RouteLoader {\n  whenEntrypoint(route: string): Promise<RouteEntrypoint>\n  onEntrypoint(route: string, execute: () => unknown): void\n  loadRoute(route: string, prefetch?: boolean): Promise<RouteLoaderEntry>\n  prefetch(route: string): Promise<void>\n}\n\nfunction hasPrefetch(link?: HTMLLinkElement): boolean {\n  try {\n    link = document.createElement('link')\n    return (\n      // detect IE11 since it supports prefetch but isn't detected\n      // with relList.support\n      (!!window.MSInputMethodContext && !!(document as any).documentMode) ||\n      link.relList.supports('prefetch')\n    )\n  } catch {\n    return false\n  }\n}\n\nconst canPrefetch: boolean = hasPrefetch()\n\nfunction prefetchViaDom(\n  href: string,\n  as: string,\n  link?: HTMLLinkElement\n): Promise<any> {\n  return new Promise<void>((res, rej) => {\n    const selector = `\n      link[rel=\"prefetch\"][href^=\"${href}\"],\n      link[rel=\"preload\"][href^=\"${href}\"],\n      script[src^=\"${href}\"]`\n    if (document.querySelector(selector)) {\n      return res()\n    }\n\n    link = document.createElement('link')\n\n    // The order of property assignment here is intentional:\n    if (as) link!.as = as\n    link!.rel = `prefetch`\n    link!.crossOrigin = process.env.__NEXT_CROSS_ORIGIN!\n    link!.onload = res as any\n    link!.onerror = rej\n\n    // `href` should always be last:\n    link!.href = href\n\n    document.head.appendChild(link)\n  })\n}\n\nconst ASSET_LOAD_ERROR = Symbol('ASSET_LOAD_ERROR')\n// TODO: unexport\nexport function markAssetError(err: Error): Error {\n  return Object.defineProperty(err, ASSET_LOAD_ERROR, {})\n}\n\nexport function isAssetError(err?: Error): boolean | undefined {\n  return err && ASSET_LOAD_ERROR in err\n}\n\nfunction appendScript(\n  src: string,\n  script?: HTMLScriptElement\n): Promise<unknown> {\n  return new Promise((resolve, reject) => {\n    script = document.createElement('script')\n\n    // The order of property assignment here is intentional.\n    // 1. Setup success/failure hooks in case the browser synchronously\n    //    executes when `src` is set.\n    script.onload = resolve\n    script.onerror = () =>\n      reject(markAssetError(new Error(`Failed to load script: ${src}`)))\n\n    // 2. Configure the cross-origin attribute before setting `src` in case the\n    //    browser begins to fetch.\n    script.crossOrigin = process.env.__NEXT_CROSS_ORIGIN!\n\n    // 3. Finally, set the source and inject into the DOM in case the child\n    //    must be appended for fetching to start.\n    script.src = src\n    document.body.appendChild(script)\n  })\n}\n\n// We wait for pages to be built in dev before we start the route transition\n// timeout to prevent an un-necessary hard navigation in development.\nlet devBuildPromise: Promise<void> | undefined\n\n// Resolve a promise that times out after given amount of milliseconds.\nfunction resolvePromiseWithTimeout<T>(\n  p: Promise<T>,\n  ms: number,\n  err: Error\n): Promise<T> {\n  return new Promise((resolve, reject) => {\n    let cancelled = false\n\n    p.then((r) => {\n      // Resolved, cancel the timeout\n      cancelled = true\n      resolve(r)\n    }).catch(reject)\n\n    // We wrap these checks separately for better dead-code elimination in\n    // production bundles.\n    if (process.env.NODE_ENV === 'development') {\n      ;(devBuildPromise || Promise.resolve()).then(() => {\n        requestIdleCallback(() =>\n          setTimeout(() => {\n            if (!cancelled) {\n              reject(err)\n            }\n          }, ms)\n        )\n      })\n    }\n\n    if (process.env.NODE_ENV !== 'development') {\n      requestIdleCallback(() =>\n        setTimeout(() => {\n          if (!cancelled) {\n            reject(err)\n          }\n        }, ms)\n      )\n    }\n  })\n}\n\n// TODO: stop exporting or cache the failure\n// It'd be best to stop exporting this. It's an implementation detail. We're\n// only exporting it for backwards compatibility with the `page-loader`.\n// Only cache this response as a last resort if we cannot eliminate all other\n// code branches that use the Build Manifest Callback and push them through\n// the Route Loader interface.\nexport function getClientBuildManifest() {\n  if (self.__BUILD_MANIFEST) {\n    return Promise.resolve(self.__BUILD_MANIFEST)\n  }\n\n  const onBuildManifest = new Promise<Record<string, string[]>>((resolve) => {\n    // Mandatory because this is not concurrent safe:\n    const cb = self.__BUILD_MANIFEST_CB\n    self.__BUILD_MANIFEST_CB = () => {\n      resolve(self.__BUILD_MANIFEST!)\n      cb && cb()\n    }\n  })\n\n  return resolvePromiseWithTimeout(\n    onBuildManifest,\n    MS_MAX_IDLE_DELAY,\n    markAssetError(new Error('Failed to load client build manifest'))\n  )\n}\n\nexport function getMiddlewareManifest() {\n  if (self.__MIDDLEWARE_MANIFEST) {\n    return Promise.resolve(self.__MIDDLEWARE_MANIFEST)\n  }\n\n  const onMiddlewareManifest = new Promise<\n    [location: string, isSSR: boolean][]\n  >((resolve) => {\n    const cb = self.__MIDDLEWARE_MANIFEST_CB\n    self.__MIDDLEWARE_MANIFEST_CB = () => {\n      resolve(self.__MIDDLEWARE_MANIFEST!)\n      cb && cb()\n    }\n  })\n\n  return resolvePromiseWithTimeout(\n    onMiddlewareManifest,\n    MS_MAX_IDLE_DELAY,\n    markAssetError(new Error('Failed to load client middleware manifest'))\n  )\n}\n\ninterface RouteFiles {\n  scripts: string[]\n  css: string[]\n}\nfunction getFilesForRoute(\n  assetPrefix: string,\n  route: string\n): Promise<RouteFiles> {\n  if (process.env.NODE_ENV === 'development') {\n    return Promise.resolve({\n      scripts: [\n        assetPrefix +\n          '/_next/static/chunks/pages' +\n          encodeURI(getAssetPathFromRoute(route, '.js')),\n      ],\n      // Styles are handled by `style-loader` in development:\n      css: [],\n    })\n  }\n  return getClientBuildManifest().then((manifest) => {\n    if (!(route in manifest)) {\n      throw markAssetError(new Error(`Failed to lookup route: ${route}`))\n    }\n    const allFiles = manifest[route].map(\n      (entry) => assetPrefix + '/_next/' + encodeURI(entry)\n    )\n    return {\n      scripts: allFiles.filter((v) => v.endsWith('.js')),\n      css: allFiles.filter((v) => v.endsWith('.css')),\n    }\n  })\n}\n\nexport function createRouteLoader(assetPrefix: string): RouteLoader {\n  const entrypoints: Map<string, Future<RouteEntrypoint> | RouteEntrypoint> =\n    new Map()\n  const loadedScripts: Map<string, Promise<unknown>> = new Map()\n  const styleSheets: Map<string, Promise<RouteStyleSheet>> = new Map()\n  const routes: Map<string, Future<RouteLoaderEntry> | RouteLoaderEntry> =\n    new Map()\n\n  function maybeExecuteScript(src: string): Promise<unknown> {\n    // With HMR we might need to \"reload\" scripts when they are\n    // disposed and readded. Executing scripts twice has no functional\n    // differences\n    if (process.env.NODE_ENV !== 'development') {\n      let prom: Promise<unknown> | undefined = loadedScripts.get(src)\n      if (prom) {\n        return prom\n      }\n\n      // Skip executing script if it's already in the DOM:\n      if (document.querySelector(`script[src^=\"${src}\"]`)) {\n        return Promise.resolve()\n      }\n\n      loadedScripts.set(src, (prom = appendScript(src)))\n      return prom\n    } else {\n      return appendScript(src)\n    }\n  }\n\n  function fetchStyleSheet(href: string): Promise<RouteStyleSheet> {\n    let prom: Promise<RouteStyleSheet> | undefined = styleSheets.get(href)\n    if (prom) {\n      return prom\n    }\n\n    styleSheets.set(\n      href,\n      (prom = fetch(href)\n        .then((res) => {\n          if (!res.ok) {\n            throw new Error(`Failed to load stylesheet: ${href}`)\n          }\n          return res.text().then((text) => ({ href: href, content: text }))\n        })\n        .catch((err) => {\n          throw markAssetError(err)\n        }))\n    )\n    return prom\n  }\n\n  return {\n    whenEntrypoint(route: string) {\n      return withFuture(route, entrypoints)\n    },\n    onEntrypoint(route: string, execute: undefined | (() => unknown)) {\n      ;(execute\n        ? Promise.resolve()\n            .then(() => execute())\n            .then(\n              (exports: any) => ({\n                component: (exports && exports.default) || exports,\n                exports: exports,\n              }),\n              (err) => ({ error: err })\n            )\n        : Promise.resolve(undefined)\n      ).then((input: RouteEntrypoint | undefined) => {\n        const old = entrypoints.get(route)\n        if (old && 'resolve' in old) {\n          if (input) {\n            entrypoints.set(route, input)\n            old.resolve(input)\n          }\n        } else {\n          if (input) {\n            entrypoints.set(route, input)\n          } else {\n            entrypoints.delete(route)\n          }\n          // when this entrypoint has been resolved before\n          // the route is outdated and we want to invalidate\n          // this cache entry\n          routes.delete(route)\n        }\n      })\n    },\n    loadRoute(route: string, prefetch?: boolean) {\n      return withFuture<RouteLoaderEntry>(route, routes, () => {\n        let devBuildPromiseResolve: () => void\n\n        if (process.env.NODE_ENV === 'development') {\n          devBuildPromise = new Promise<void>((resolve) => {\n            devBuildPromiseResolve = resolve\n          })\n        }\n\n        return resolvePromiseWithTimeout(\n          getFilesForRoute(assetPrefix, route)\n            .then(({ scripts, css }) => {\n              return Promise.all([\n                entrypoints.has(route)\n                  ? []\n                  : Promise.all(scripts.map(maybeExecuteScript)),\n                Promise.all(css.map(fetchStyleSheet)),\n              ] as const)\n            })\n            .then((res) => {\n              return this.whenEntrypoint(route).then((entrypoint) => ({\n                entrypoint,\n                styles: res[1],\n              }))\n            }),\n          MS_MAX_IDLE_DELAY,\n          markAssetError(new Error(`Route did not complete loading: ${route}`))\n        )\n          .then(({ entrypoint, styles }) => {\n            const res: RouteLoaderEntry = Object.assign<\n              { styles: RouteStyleSheet[] },\n              RouteEntrypoint\n            >({ styles: styles! }, entrypoint)\n            return 'error' in entrypoint ? entrypoint : res\n          })\n          .catch((err) => {\n            if (prefetch) {\n              // we don't want to cache errors during prefetch\n              throw err\n            }\n            return { error: err }\n          })\n          .finally(() => devBuildPromiseResolve?.())\n      })\n    },\n    prefetch(route: string): Promise<void> {\n      // https://github.com/GoogleChromeLabs/quicklink/blob/453a661fa1fa940e2d2e044452398e38c67a98fb/src/index.mjs#L115-L118\n      // License: Apache 2.0\n      let cn\n      if ((cn = (navigator as any).connection)) {\n        // Don't prefetch if using 2G or if Save-Data is enabled.\n        if (cn.saveData || /2g/.test(cn.effectiveType)) return Promise.resolve()\n      }\n      return getFilesForRoute(assetPrefix, route)\n        .then((output) =>\n          Promise.all(\n            canPrefetch\n              ? output.scripts.map((script) => prefetchViaDom(script, 'script'))\n              : []\n          )\n        )\n        .then(() => {\n          requestIdleCallback(() => this.loadRoute(route, true).catch(() => {}))\n        })\n        .catch(\n          // swallow prefetch errors\n          () => {}\n        )\n    },\n  }\n}\n"],"names":["markAssetError","isAssetError","getClientBuildManifest","getMiddlewareManifest","createRouteLoader","MS_MAX_IDLE_DELAY","withFuture","key","map","generator","entry","get","future","Promise","resolve","resolver","prom","set","then","value","catch","err","delete","hasPrefetch","link","document","createElement","window","MSInputMethodContext","documentMode","relList","supports","canPrefetch","prefetchViaDom","href","as","res","rej","selector","querySelector","rel","crossOrigin","process","env","__NEXT_CROSS_ORIGIN","onload","onerror","head","appendChild","ASSET_LOAD_ERROR","Symbol","Object","defineProperty","appendScript","src","script","reject","Error","body","devBuildPromise","resolvePromiseWithTimeout","p","ms","cancelled","r","NODE_ENV","setTimeout","self","__BUILD_MANIFEST","onBuildManifest","cb","__BUILD_MANIFEST_CB","__MIDDLEWARE_MANIFEST","onMiddlewareManifest","__MIDDLEWARE_MANIFEST_CB","getFilesForRoute","assetPrefix","route","scripts","encodeURI","css","manifest","allFiles","filter","v","endsWith","entrypoints","Map","loadedScripts","styleSheets","routes","maybeExecuteScript","fetchStyleSheet","fetch","ok","text","content","whenEntrypoint","onEntrypoint","execute","exports","component","default","error","undefined","input","old","loadRoute","prefetch","devBuildPromiseResolve","all","has","entrypoint","styles","assign","finally","cn","navigator","connection","saveData","test","effectiveType","output"],"mappings":"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"}