{"version":3,"sources":["../../client/page-loader.ts"],"sourcesContent":["import type { ComponentType } from 'react'\nimport type { RouteLoader } from './route-loader'\nimport {\n  addBasePath,\n  addLocale,\n  interpolateAs,\n} from '../shared/lib/router/router'\nimport getAssetPathFromRoute from '../shared/lib/router/utils/get-asset-path-from-route'\nimport { isDynamicRoute } from '../shared/lib/router/utils/is-dynamic'\nimport { parseRelativeUrl } from '../shared/lib/router/utils/parse-relative-url'\nimport { removePathTrailingSlash } from './normalize-trailing-slash'\nimport {\n  createRouteLoader,\n  getClientBuildManifest,\n  getMiddlewareManifest,\n} from './route-loader'\n\nfunction normalizeRoute(route: string): string {\n  if (route[0] !== '/') {\n    throw new Error(`Route name should start with a \"/\", got \"${route}\"`)\n  }\n\n  if (route === '/') return route\n  return route.replace(/\\/$/, '')\n}\n\ndeclare global {\n  interface Window {\n    __DEV_MIDDLEWARE_MANIFEST?: [location: string, isSSR: boolean][]\n    __DEV_PAGES_MANIFEST?: { pages: string[] }\n    __SSG_MANIFEST_CB?: () => void\n    __SSG_MANIFEST?: Set<string>\n  }\n}\n\nexport type StyleSheetTuple = { href: string; text: string }\nexport type GoodPageCache = {\n  page: ComponentType\n  mod: any\n  styleSheets: StyleSheetTuple[]\n}\n\nexport default class PageLoader {\n  private buildId: string\n  private assetPrefix: string\n  private promisedSsgManifest: Promise<Set<string>>\n  private promisedDevPagesManifest?: Promise<string[]>\n  private promisedMiddlewareManifest?: Promise<\n    [location: string, isSSR: boolean][]\n  >\n\n  public routeLoader: RouteLoader\n\n  constructor(buildId: string, assetPrefix: string) {\n    this.routeLoader = createRouteLoader(assetPrefix)\n\n    this.buildId = buildId\n    this.assetPrefix = assetPrefix\n\n    this.promisedSsgManifest = new Promise((resolve) => {\n      if (window.__SSG_MANIFEST) {\n        resolve(window.__SSG_MANIFEST)\n      } else {\n        window.__SSG_MANIFEST_CB = () => {\n          resolve(window.__SSG_MANIFEST!)\n        }\n      }\n    })\n  }\n\n  getPageList() {\n    if (process.env.NODE_ENV === 'production') {\n      return getClientBuildManifest().then((manifest) => manifest.sortedPages)\n    } else {\n      if (window.__DEV_PAGES_MANIFEST) {\n        return window.__DEV_PAGES_MANIFEST.pages\n      } else {\n        if (!this.promisedDevPagesManifest) {\n          // TODO: Decide what should happen when fetching fails instead of asserting\n          // @ts-ignore\n          this.promisedDevPagesManifest = fetch(\n            `${this.assetPrefix}/_next/static/development/_devPagesManifest.json`\n          )\n            .then((res) => res.json())\n            .then((manifest: { pages: string[] }) => {\n              window.__DEV_PAGES_MANIFEST = manifest\n              return manifest.pages\n            })\n            .catch((err) => {\n              console.log(`Failed to fetch devPagesManifest`, err)\n            })\n        }\n        // TODO Remove this assertion as this could be undefined\n        return this.promisedDevPagesManifest!\n      }\n    }\n  }\n\n  getMiddlewareList() {\n    if (process.env.NODE_ENV === 'production') {\n      return getMiddlewareManifest()\n    } else {\n      if (window.__DEV_MIDDLEWARE_MANIFEST) {\n        return window.__DEV_MIDDLEWARE_MANIFEST\n      } else {\n        if (!this.promisedMiddlewareManifest) {\n          // TODO: Decide what should happen when fetching fails instead of asserting\n          // @ts-ignore\n          this.promisedMiddlewareManifest = fetch(\n            `${this.assetPrefix}/_next/static/${this.buildId}/_devMiddlewareManifest.json`\n          )\n            .then((res) => res.json())\n            .then((manifest: [location: string, isSSR: boolean][]) => {\n              window.__DEV_MIDDLEWARE_MANIFEST = manifest\n              return manifest\n            })\n            .catch((err) => {\n              console.log(`Failed to fetch _devMiddlewareManifest`, err)\n            })\n        }\n        // TODO Remove this assertion as this could be undefined\n        return this.promisedMiddlewareManifest!\n      }\n    }\n  }\n\n  /**\n   * @param {string} href the route href (file-system path)\n   * @param {string} asPath the URL as shown in browser (virtual path); used for dynamic routes\n   * @returns {string}\n   */\n  getDataHref({\n    href,\n    asPath,\n    ssg,\n    rsc,\n    locale,\n  }: {\n    href: string\n    asPath: string\n    ssg?: boolean\n    rsc?: boolean\n    locale?: string | false\n  }): string {\n    const { pathname: hrefPathname, query, search } = parseRelativeUrl(href)\n    const { pathname: asPathname } = parseRelativeUrl(asPath)\n    const route = normalizeRoute(hrefPathname)\n\n    const getHrefForSlug = (path: string) => {\n      if (rsc) {\n        return path + search + (search ? `&` : '?') + '__flight__'\n      }\n\n      const dataRoute = getAssetPathFromRoute(\n        removePathTrailingSlash(addLocale(path, locale)),\n        '.json'\n      )\n      return addBasePath(\n        `/_next/data/${this.buildId}${dataRoute}${ssg ? '' : search}`\n      )\n    }\n\n    const isDynamic: boolean = isDynamicRoute(route)\n    const interpolatedRoute = isDynamic\n      ? interpolateAs(hrefPathname, asPathname, query).result\n      : ''\n\n    return isDynamic\n      ? interpolatedRoute && getHrefForSlug(interpolatedRoute)\n      : getHrefForSlug(route)\n  }\n\n  /**\n   * @param {string} route - the route (file-system path)\n   */\n  _isSsg(route: string): Promise<boolean> {\n    return this.promisedSsgManifest.then((manifest) => manifest.has(route))\n  }\n\n  loadPage(route: string): Promise<GoodPageCache> {\n    return this.routeLoader.loadRoute(route).then((res) => {\n      if ('component' in res) {\n        return {\n          page: res.component,\n          mod: res.exports,\n          styleSheets: res.styles.map((o) => ({\n            href: o.href,\n            text: o.content,\n          })),\n        }\n      }\n      throw res.error\n    })\n  }\n\n  prefetch(route: string): Promise<void> {\n    return this.routeLoader.prefetch(route)\n  }\n}\n"],"names":["normalizeRoute","route","Error","replace","PageLoader","getPageList","process","env","NODE_ENV","then","manifest","sortedPages","window","__DEV_PAGES_MANIFEST","pages","promisedDevPagesManifest","fetch","assetPrefix","res","json","catch","err","console","log","getMiddlewareList","__DEV_MIDDLEWARE_MANIFEST","promisedMiddlewareManifest","buildId","getDataHref","href","asPath","ssg","rsc","locale","pathname","hrefPathname","query","search","asPathname","getHrefForSlug","path","dataRoute","isDynamic","interpolatedRoute","result","_isSsg","promisedSsgManifest","has","loadPage","routeLoader","loadRoute","page","component","mod","exports","styleSheets","styles","map","o","text","content","error","prefetch","Promise","resolve","__SSG_MANIFEST","__SSG_MANIFEST_CB"],"mappings":"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"}