{"version":3,"sources":["../../server/base-http.ts"],"sourcesContent":["import type { ServerResponse, IncomingMessage, IncomingHttpHeaders } from 'http'\nimport type { Writable, Readable } from 'stream'\n\nimport { PERMANENT_REDIRECT_STATUS } from '../shared/lib/constants'\nimport {\n  getCookieParser,\n  NextApiRequestCookies,\n  parseBody,\n  SYMBOL_CLEARED_COOKIES,\n} from './api-utils'\nimport { I18NConfig } from './config-shared'\nimport { NEXT_REQUEST_META, RequestMeta } from './request-meta'\n\nexport interface BaseNextRequestConfig {\n  basePath: string | undefined\n  i18n?: I18NConfig\n  trailingSlash?: boolean | undefined\n}\n\nexport abstract class BaseNextRequest<Body = any> {\n  protected _cookies: NextApiRequestCookies | undefined\n  public abstract headers: IncomingHttpHeaders\n\n  constructor(public method: string, public url: string, public body: Body) {}\n\n  abstract parseBody(limit: string | number): Promise<any>\n\n  // Utils implemented using the abstract methods above\n\n  public get cookies() {\n    if (this._cookies) return this._cookies\n    return (this._cookies = getCookieParser(this.headers)())\n  }\n}\n\nexport class NodeNextRequest extends BaseNextRequest<Readable> {\n  public headers = this._req.headers;\n\n  [NEXT_REQUEST_META]: RequestMeta\n\n  get originalRequest() {\n    // Need to mimic these changes to the original req object for places where we use it:\n    // render.tsx, api/ssg requests\n    this._req[NEXT_REQUEST_META] = this[NEXT_REQUEST_META]\n    this._req.url = this.url\n    this._req.cookies = this.cookies\n    return this._req\n  }\n\n  constructor(\n    private _req: IncomingMessage & {\n      [NEXT_REQUEST_META]?: RequestMeta\n      cookies?: NextApiRequestCookies\n    }\n  ) {\n    super(_req.method!.toUpperCase(), _req.url!, _req)\n  }\n\n  async parseBody(limit: string | number): Promise<any> {\n    return parseBody(this._req, limit)\n  }\n}\n\nexport class WebNextRequest extends BaseNextRequest<ReadableStream | null> {\n  public request: Request\n  public headers: IncomingHttpHeaders\n\n  constructor(request: Request) {\n    const url = new URL(request.url)\n\n    super(\n      request.method,\n      url.href.slice(url.origin.length),\n      request.clone().body\n    )\n    this.request = request\n\n    this.headers = {}\n    for (const [name, value] of request.headers.entries()) {\n      this.headers[name] = value\n    }\n  }\n\n  async parseBody(_limit: string | number): Promise<any> {\n    throw new Error('parseBody is not implemented in the web runtime')\n  }\n}\n\nexport abstract class BaseNextResponse<Destination = any> {\n  abstract statusCode: number | undefined\n  abstract statusMessage: string | undefined\n  abstract get sent(): boolean\n\n  constructor(public destination: Destination) {}\n\n  /**\n   * Sets a value for the header overwriting existing values\n   */\n  abstract setHeader(name: string, value: string | string[]): this\n\n  /**\n   * Appends value for the given header name\n   */\n  abstract appendHeader(name: string, value: string): this\n\n  /**\n   * Get all vaues for a header as an array or undefined if no value is present\n   */\n  abstract getHeaderValues(name: string): string[] | undefined\n\n  abstract hasHeader(name: string): boolean\n\n  /**\n   * Get vaues for a header concatenated using `,` or undefined if no value is present\n   */\n  abstract getHeader(name: string): string | undefined\n\n  abstract body(value: string): this\n\n  abstract send(): void\n\n  // Utils implemented using the abstract methods above\n\n  redirect(destination: string, statusCode: number) {\n    this.setHeader('Location', destination)\n    this.statusCode = statusCode\n\n    // Since IE11 doesn't support the 308 header add backwards\n    // compatibility using refresh header\n    if (statusCode === PERMANENT_REDIRECT_STATUS) {\n      this.setHeader('Refresh', `0;url=${destination}`)\n    }\n    return this\n  }\n}\n\nexport class NodeNextResponse extends BaseNextResponse<Writable> {\n  private textBody: string | undefined = undefined\n\n  public [SYMBOL_CLEARED_COOKIES]?: boolean\n\n  get originalResponse() {\n    if (SYMBOL_CLEARED_COOKIES in this) {\n      this._res[SYMBOL_CLEARED_COOKIES] = this[SYMBOL_CLEARED_COOKIES]\n    }\n\n    return this._res\n  }\n\n  constructor(\n    private _res: ServerResponse & { [SYMBOL_CLEARED_COOKIES]?: boolean }\n  ) {\n    super(_res)\n  }\n\n  get sent() {\n    return this._res.finished || this._res.headersSent\n  }\n\n  get statusCode() {\n    return this._res.statusCode\n  }\n\n  set statusCode(value: number) {\n    this._res.statusCode = value\n  }\n\n  get statusMessage() {\n    return this._res.statusMessage\n  }\n\n  set statusMessage(value: string) {\n    this._res.statusMessage = value\n  }\n\n  setHeader(name: string, value: string | string[]): this {\n    this._res.setHeader(name, value)\n    return this\n  }\n\n  getHeaderValues(name: string): string[] | undefined {\n    const values = this._res.getHeader(name)\n\n    if (values === undefined) return undefined\n\n    return (Array.isArray(values) ? values : [values]).map((value) =>\n      value.toString()\n    )\n  }\n\n  hasHeader(name: string): boolean {\n    return this._res.hasHeader(name)\n  }\n\n  getHeader(name: string): string | undefined {\n    const values = this.getHeaderValues(name)\n    return Array.isArray(values) ? values.join(',') : undefined\n  }\n\n  appendHeader(name: string, value: string): this {\n    const currentValues = this.getHeaderValues(name) ?? []\n\n    if (!currentValues.includes(value)) {\n      this._res.setHeader(name, [...currentValues, value])\n    }\n\n    return this\n  }\n\n  body(value: string) {\n    this.textBody = value\n    return this\n  }\n\n  send() {\n    this._res.end(this.textBody)\n  }\n}\n\nexport class WebNextResponse extends BaseNextResponse<WritableStream> {\n  private headers = new Headers()\n  private textBody: string | undefined = undefined\n  private _sent = false\n\n  private sendPromise = new Promise<void>((resolve) => {\n    this.sendResolve = resolve\n  })\n  private sendResolve?: () => void\n  private response = this.sendPromise.then(() => {\n    return new Response(this.textBody ?? this.transformStream.readable, {\n      headers: this.headers,\n      status: this.statusCode,\n      statusText: this.statusMessage,\n    })\n  })\n\n  public statusCode: number | undefined\n  public statusMessage: string | undefined\n\n  get sent() {\n    return this._sent\n  }\n\n  constructor(public transformStream = new TransformStream()) {\n    super(transformStream.writable)\n  }\n\n  setHeader(name: string, value: string | string[]): this {\n    this.headers.delete(name)\n    for (const val of Array.isArray(value) ? value : [value]) {\n      this.headers.append(name, val)\n    }\n    return this\n  }\n\n  getHeaderValues(name: string): string[] | undefined {\n    // https://developer.mozilla.org/en-US/docs/Web/API/Headers/get#example\n    return this.getHeader(name)\n      ?.split(',')\n      .map((v) => v.trimStart())\n  }\n\n  getHeader(name: string): string | undefined {\n    return this.headers.get(name) ?? undefined\n  }\n\n  hasHeader(name: string): boolean {\n    return this.headers.has(name)\n  }\n\n  appendHeader(name: string, value: string): this {\n    this.headers.append(name, value)\n    return this\n  }\n\n  body(value: string) {\n    this.textBody = value\n    return this\n  }\n\n  send() {\n    this.sendResolve?.()\n    this._sent = true\n  }\n\n  toResponse() {\n    return this.response\n  }\n}\n"],"names":["BaseNextRequest","method","url","body","cookies","_cookies","headers","NodeNextRequest","originalRequest","_req","toUpperCase","parseBody","limit","WebNextRequest","request","URL","href","slice","origin","length","clone","name","value","entries","_limit","Error","BaseNextResponse","destination","redirect","statusCode","setHeader","NodeNextResponse","originalResponse","_res","textBody","undefined","sent","finished","headersSent","statusMessage","getHeaderValues","values","getHeader","Array","isArray","map","toString","hasHeader","join","appendHeader","currentValues","includes","send","end","WebNextResponse","_sent","transformStream","TransformStream","writable","Headers","sendPromise","Promise","resolve","sendResolve","response","then","Response","readable","status","statusText","delete","val","append","split","v","trimStart","get","has","toResponse"],"mappings":"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"}