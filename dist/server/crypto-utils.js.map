{"version":3,"sources":["../../server/crypto-utils.ts"],"sourcesContent":["import crypto from 'crypto'\n\n// Background:\n// https://security.stackexchange.com/questions/184305/why-would-i-ever-use-aes-256-cbc-if-aes-256-gcm-is-more-secure\n\nconst CIPHER_ALGORITHM = `aes-256-gcm`,\n  CIPHER_KEY_LENGTH = 32, // https://stackoverflow.com/a/28307668/4397028\n  CIPHER_IV_LENGTH = 16, // https://stackoverflow.com/a/28307668/4397028\n  CIPHER_TAG_LENGTH = 16,\n  CIPHER_SALT_LENGTH = 64\n\nconst PBKDF2_ITERATIONS = 100_000 // https://support.1password.com/pbkdf2/\n\nexport function encryptWithSecret(secret: Buffer, data: string): string {\n  const iv = crypto.randomBytes(CIPHER_IV_LENGTH)\n  const salt = crypto.randomBytes(CIPHER_SALT_LENGTH)\n\n  // https://nodejs.org/api/crypto.html#crypto_crypto_pbkdf2sync_password_salt_iterations_keylen_digest\n  const key = crypto.pbkdf2Sync(\n    secret,\n    salt,\n    PBKDF2_ITERATIONS,\n    CIPHER_KEY_LENGTH,\n    `sha512`\n  )\n\n  const cipher = crypto.createCipheriv(CIPHER_ALGORITHM, key, iv)\n  const encrypted = Buffer.concat([cipher.update(data, `utf8`), cipher.final()])\n\n  // https://nodejs.org/api/crypto.html#crypto_cipher_getauthtag\n  const tag = cipher.getAuthTag()\n\n  return Buffer.concat([\n    // Data as required by:\n    // Salt for Key: https://nodejs.org/api/crypto.html#crypto_crypto_pbkdf2sync_password_salt_iterations_keylen_digest\n    // IV: https://nodejs.org/api/crypto.html#crypto_class_decipher\n    // Tag: https://nodejs.org/api/crypto.html#crypto_decipher_setauthtag_buffer\n    salt,\n    iv,\n    tag,\n    encrypted,\n  ]).toString(`hex`)\n}\n\nexport function decryptWithSecret(\n  secret: Buffer,\n  encryptedData: string\n): string {\n  const buffer = Buffer.from(encryptedData, `hex`)\n\n  const salt = buffer.slice(0, CIPHER_SALT_LENGTH)\n  const iv = buffer.slice(\n    CIPHER_SALT_LENGTH,\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH\n  )\n  const tag = buffer.slice(\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH,\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH + CIPHER_TAG_LENGTH\n  )\n  const encrypted = buffer.slice(\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH + CIPHER_TAG_LENGTH\n  )\n\n  // https://nodejs.org/api/crypto.html#crypto_crypto_pbkdf2sync_password_salt_iterations_keylen_digest\n  const key = crypto.pbkdf2Sync(\n    secret,\n    salt,\n    PBKDF2_ITERATIONS,\n    CIPHER_KEY_LENGTH,\n    `sha512`\n  )\n\n  const decipher = crypto.createDecipheriv(CIPHER_ALGORITHM, key, iv)\n  decipher.setAuthTag(tag)\n\n  return decipher.update(encrypted) + decipher.final(`utf8`)\n}\n"],"names":["encryptWithSecret","decryptWithSecret","CIPHER_ALGORITHM","CIPHER_KEY_LENGTH","CIPHER_IV_LENGTH","CIPHER_TAG_LENGTH","CIPHER_SALT_LENGTH","PBKDF2_ITERATIONS","secret","data","iv","randomBytes","salt","key","pbkdf2Sync","cipher","createCipheriv","encrypted","Buffer","concat","update","final","tag","getAuthTag","toString","encryptedData","buffer","from","slice","decipher","createDecipheriv","setAuthTag"],"mappings":";;;;QAagBA,iBAAiB,GAAjBA,iBAAiB;QA+BjBC,iBAAiB,GAAjBA,iBAAiB;AA5Cd,GAAQ,CAAR,OAAQ;;;;;;AAE3B,EAAc,AAAd,YAAc;AACd,EAAqH,AAArH,mHAAqH;AAErH,KAAK,CAACC,gBAAgB,IAAI,WAAW,GACnCC,iBAAiB,GAAG,EAAE,EACtBC,gBAAgB,GAAG,EAAE,EACrBC,iBAAiB,GAAG,EAAE,EACtBC,kBAAkB,GAAG,EAAE;AAEzB,KAAK,CAACC,iBAAiB,GAAG,MAAO,AAAC,CAAwC,AAAxC,EAAwC,AAAxC,sCAAwC;;SAE1DP,iBAAiB,CAACQ,MAAc,EAAEC,IAAY,EAAU,CAAC;IACvE,KAAK,CAACC,EAAE,GAdS,OAAQ,SAcPC,WAAW,CAACP,gBAAgB;IAC9C,KAAK,CAACQ,IAAI,GAfO,OAAQ,SAeLD,WAAW,CAACL,kBAAkB;IAElD,EAAqG,AAArG,mGAAqG;IACrG,KAAK,CAACO,GAAG,GAlBQ,OAAQ,SAkBNC,UAAU,CAC3BN,MAAM,EACNI,IAAI,EACJL,iBAAiB,EACjBJ,iBAAiB,GAChB,MAAM;IAGT,KAAK,CAACY,MAAM,GA1BK,OAAQ,SA0BHC,cAAc,CAACd,gBAAgB,EAAEW,GAAG,EAAEH,EAAE;IAC9D,KAAK,CAACO,SAAS,GAAGC,MAAM,CAACC,MAAM,CAAC,CAACJ;QAAAA,MAAM,CAACK,MAAM,CAACX,IAAI,GAAG,IAAI;QAAIM,MAAM,CAACM,KAAK;IAAE,CAAC;IAE7E,EAA8D,AAA9D,4DAA8D;IAC9D,KAAK,CAACC,GAAG,GAAGP,MAAM,CAACQ,UAAU;IAE7B,MAAM,CAACL,MAAM,CAACC,MAAM,CAAC,CAAC;QACpB,EAAuB,AAAvB,qBAAuB;QACvB,EAAmH,AAAnH,iHAAmH;QACnH,EAA+D,AAA/D,6DAA+D;QAC/D,EAA4E,AAA5E,0EAA4E;QAC5EP,IAAI;QACJF,EAAE;QACFY,GAAG;QACHL,SAAS;IACX,CAAC,EAAEO,QAAQ,EAAE,GAAG;AAClB,CAAC;SAEevB,iBAAiB,CAC/BO,MAAc,EACdiB,aAAqB,EACb,CAAC;IACT,KAAK,CAACC,MAAM,GAAGR,MAAM,CAACS,IAAI,CAACF,aAAa,GAAG,GAAG;IAE9C,KAAK,CAACb,IAAI,GAAGc,MAAM,CAACE,KAAK,CAAC,CAAC,EAAEtB,kBAAkB;IAC/C,KAAK,CAACI,EAAE,GAAGgB,MAAM,CAACE,KAAK,CACrBtB,kBAAkB,EAClBA,kBAAkB,GAAGF,gBAAgB;IAEvC,KAAK,CAACkB,GAAG,GAAGI,MAAM,CAACE,KAAK,CACtBtB,kBAAkB,GAAGF,gBAAgB,EACrCE,kBAAkB,GAAGF,gBAAgB,GAAGC,iBAAiB;IAE3D,KAAK,CAACY,SAAS,GAAGS,MAAM,CAACE,KAAK,CAC5BtB,kBAAkB,GAAGF,gBAAgB,GAAGC,iBAAiB;IAG3D,EAAqG,AAArG,mGAAqG;IACrG,KAAK,CAACQ,GAAG,GAhEQ,OAAQ,SAgENC,UAAU,CAC3BN,MAAM,EACNI,IAAI,EACJL,iBAAiB,EACjBJ,iBAAiB,GAChB,MAAM;IAGT,KAAK,CAAC0B,QAAQ,GAxEG,OAAQ,SAwEDC,gBAAgB,CAAC5B,gBAAgB,EAAEW,GAAG,EAAEH,EAAE;IAClEmB,QAAQ,CAACE,UAAU,CAACT,GAAG;IAEvB,MAAM,CAACO,QAAQ,CAACT,MAAM,CAACH,SAAS,IAAIY,QAAQ,CAACR,KAAK,EAAE,IAAI;AAC1D,CAAC"}