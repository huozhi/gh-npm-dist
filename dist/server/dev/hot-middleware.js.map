{"version":3,"sources":["../../../server/dev/hot-middleware.ts"],"sourcesContent":["// Based on https://github.com/webpack-contrib/webpack-hot-middleware/blob/9708d781ae0e46179cf8ea1a94719de4679aaf53/middleware.js\n// Included License below\n\n// Copyright JS Foundation and other contributors\n\n// Permission is hereby granted, free of charge, to any person obtaining\n// a copy of this software and associated documentation files (the\n// 'Software'), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to\n// permit persons to whom the Software is furnished to do so, subject to\n// the following conditions:\n\n// The above copyright notice and this permission notice shall be\n// included in all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n// CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n// TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n// SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nimport type { webpack5 as webpack } from 'next/dist/compiled/webpack/webpack'\nimport type ws from 'ws'\n\nexport class WebpackHotMiddleware {\n  eventStream: EventStream\n  latestStats: webpack.Stats | null\n  clientLatestStats: webpack.Stats | null\n  closed: boolean\n  serverError: boolean\n\n  constructor(compilers: webpack.Compiler[]) {\n    this.eventStream = new EventStream()\n    this.latestStats = null\n    this.clientLatestStats = null\n    this.serverError = false\n    this.closed = false\n\n    compilers[0].hooks.invalid.tap(\n      'webpack-hot-middleware',\n      this.onClientInvalid\n    )\n    compilers[0].hooks.done.tap('webpack-hot-middleware', this.onClientDone)\n\n    compilers[1].hooks.invalid.tap(\n      'webpack-hot-middleware',\n      this.onServerInvalid\n    )\n    compilers[1].hooks.done.tap('webpack-hot-middleware', this.onServerDone)\n  }\n\n  onServerInvalid = () => {\n    if (!this.serverError) return\n\n    this.serverError = false\n\n    if (this.clientLatestStats) {\n      this.latestStats = this.clientLatestStats\n      this.publishStats('built', this.latestStats)\n    }\n  }\n  onClientInvalid = () => {\n    if (this.closed || this.serverError) return\n    this.latestStats = null\n    this.eventStream.publish({ action: 'building' })\n  }\n  onServerDone = (statsResult: webpack.Stats) => {\n    if (this.closed) return\n    // Keep hold of latest stats so they can be propagated to new clients\n    // this.latestStats = statsResult\n    // this.publishStats('built', this.latestStats)\n    this.serverError = statsResult.hasErrors()\n\n    if (this.serverError) {\n      this.latestStats = statsResult\n      this.publishStats('built', this.latestStats)\n    }\n  }\n  onClientDone = (statsResult: webpack.Stats) => {\n    this.clientLatestStats = statsResult\n\n    if (this.closed || this.serverError) return\n    // Keep hold of latest stats so they can be propagated to new clients\n    this.latestStats = statsResult\n    this.publishStats('built', this.latestStats)\n  }\n\n  onHMR = (client: ws) => {\n    if (this.closed) return\n    this.eventStream.handler(client)\n    if (this.latestStats) {\n      // Explicitly not passing in `log` fn as we don't want to log again on\n      // the server\n      this.publishStats('sync', this.latestStats)\n    }\n  }\n\n  publishStats = (action: string, statsResult: webpack.Stats) => {\n    const stats = statsResult.toJson({\n      all: false,\n      hash: true,\n      warnings: true,\n      errors: true,\n    })\n\n    this.eventStream.publish({\n      action: action,\n      hash: stats.hash,\n      warnings: stats.warnings || [],\n      errors: stats.errors || [],\n    })\n  }\n\n  publish = (payload: any) => {\n    if (this.closed) return\n    this.eventStream.publish(payload)\n  }\n  close = () => {\n    if (this.closed) return\n    // Can't remove compiler plugins, so we just set a flag and noop if closed\n    // https://github.com/webpack/tapable/issues/32#issuecomment-350644466\n    this.closed = true\n    this.eventStream.close()\n  }\n}\n\nclass EventStream {\n  clients: Set<ws>\n  constructor() {\n    this.clients = new Set()\n  }\n\n  everyClient(fn: (client: ws) => void) {\n    for (const client of this.clients) {\n      fn(client)\n    }\n  }\n\n  close() {\n    this.everyClient((client) => {\n      client.close()\n    })\n    this.clients.clear()\n  }\n\n  handler(client: ws) {\n    this.clients.add(client)\n    client.addEventListener('close', () => {\n      this.clients.delete(client)\n    })\n  }\n\n  publish(payload: any) {\n    this.everyClient((client) => {\n      client.send(JSON.stringify(payload))\n    })\n  }\n}\n"],"names":["WebpackHotMiddleware","compilers","onServerInvalid","serverError","clientLatestStats","latestStats","publishStats","onClientInvalid","closed","eventStream","publish","action","onServerDone","statsResult","hasErrors","onClientDone","onHMR","client","handler","stats","toJson","all","hash","warnings","errors","payload","close","EventStream","hooks","invalid","tap","done","clients","Set","everyClient","fn","clear","add","addEventListener","delete","send","JSON","stringify"],"mappings":";;;;MA0BaA,oBAAoB;gBAOnBC,SAA6B,CAAE,CAAC;QAPvC,IAoGN,CAzECC,eAAe,OAAS,CAAC;YACvB,EAAE,GAAG,IAAI,CAACC,WAAW,EAAE,MAAM;YAE7B,IAAI,CAACA,WAAW,GAAG,KAAK;YAExB,EAAE,EAAE,IAAI,CAACC,iBAAiB,EAAE,CAAC;gBAC3B,IAAI,CAACC,WAAW,GAAG,IAAI,CAACD,iBAAiB;gBACzC,IAAI,CAACE,YAAY,CAAC,CAAO,QAAE,IAAI,CAACD,WAAW;YAC7C,CAAC;QACH,CAAC;QApCI,IAoGN,CA/DCE,eAAe,OAAS,CAAC;YACvB,EAAE,EAAE,IAAI,CAACC,MAAM,IAAI,IAAI,CAACL,WAAW,EAAE,MAAM;YAC3C,IAAI,CAACE,WAAW,GAAG,IAAI;YACvB,IAAI,CAACI,WAAW,CAACC,OAAO,CAAC,CAAC;gBAACC,MAAM,EAAE,CAAU;YAAC,CAAC;QACjD,CAAC;QAzCI,IAoGN,CA1DCC,YAAY,IAAIC,WAA0B,GAAK,CAAC;YAC9C,EAAE,EAAE,IAAI,CAACL,MAAM,EAAE,MAAM;YACvB,EAAqE,AAArE,mEAAqE;YACrE,EAAiC,AAAjC,+BAAiC;YACjC,EAA+C,AAA/C,6CAA+C;YAC/C,IAAI,CAACL,WAAW,GAAGU,WAAW,CAACC,SAAS;YAExC,EAAE,EAAE,IAAI,CAACX,WAAW,EAAE,CAAC;gBACrB,IAAI,CAACE,WAAW,GAAGQ,WAAW;gBAC9B,IAAI,CAACP,YAAY,CAAC,CAAO,QAAE,IAAI,CAACD,WAAW;YAC7C,CAAC;QACH,CAAC;QArDI,IAoGN,CA9CCU,YAAY,IAAIF,WAA0B,GAAK,CAAC;YAC9C,IAAI,CAACT,iBAAiB,GAAGS,WAAW;YAEpC,EAAE,EAAE,IAAI,CAACL,MAAM,IAAI,IAAI,CAACL,WAAW,EAAE,MAAM;YAC3C,EAAqE,AAArE,mEAAqE;YACrE,IAAI,CAACE,WAAW,GAAGQ,WAAW;YAC9B,IAAI,CAACP,YAAY,CAAC,CAAO,QAAE,IAAI,CAACD,WAAW;QAC7C,CAAC;QA7DI,IAoGN,CArCCW,KAAK,IAAIC,MAAU,GAAK,CAAC;YACvB,EAAE,EAAE,IAAI,CAACT,MAAM,EAAE,MAAM;YACvB,IAAI,CAACC,WAAW,CAACS,OAAO,CAACD,MAAM;YAC/B,EAAE,EAAE,IAAI,CAACZ,WAAW,EAAE,CAAC;gBACrB,EAAsE,AAAtE,oEAAsE;gBACtE,EAAa,AAAb,WAAa;gBACb,IAAI,CAACC,YAAY,CAAC,CAAM,OAAE,IAAI,CAACD,WAAW;YAC5C,CAAC;QACH,CAAC;QAvEI,IAoGN,CA3BCC,YAAY,IAAIK,MAAc,EAAEE,WAA0B,GAAK,CAAC;YAC9D,KAAK,CAACM,KAAK,GAAGN,WAAW,CAACO,MAAM,CAAC,CAAC;gBAChCC,GAAG,EAAE,KAAK;gBACVC,IAAI,EAAE,IAAI;gBACVC,QAAQ,EAAE,IAAI;gBACdC,MAAM,EAAE,IAAI;YACd,CAAC;YAED,IAAI,CAACf,WAAW,CAACC,OAAO,CAAC,CAAC;gBACxBC,MAAM,EAAEA,MAAM;gBACdW,IAAI,EAAEH,KAAK,CAACG,IAAI;gBAChBC,QAAQ,EAAEJ,KAAK,CAACI,QAAQ,IAAI,CAAC,CAAC;gBAC9BC,MAAM,EAAEL,KAAK,CAACK,MAAM,IAAI,CAAC,CAAC;YAC5B,CAAC;QACH,CAAC;QAvFI,IAoGN,CAXCd,OAAO,IAAIe,OAAY,GAAK,CAAC;YAC3B,EAAE,EAAE,IAAI,CAACjB,MAAM,EAAE,MAAM;YACvB,IAAI,CAACC,WAAW,CAACC,OAAO,CAACe,OAAO;QAClC,CAAC;QA5FI,IAoGN,CAPCC,KAAK,OAAS,CAAC;YACb,EAAE,EAAE,IAAI,CAAClB,MAAM,EAAE,MAAM;YACvB,EAA0E,AAA1E,wEAA0E;YAC1E,EAAsE,AAAtE,oEAAsE;YACtE,IAAI,CAACA,MAAM,GAAG,IAAI;YAClB,IAAI,CAACC,WAAW,CAACiB,KAAK;QACxB,CAAC;QA3FC,IAAI,CAACjB,WAAW,GAAG,GAAG,CAACkB,WAAW;QAClC,IAAI,CAACtB,WAAW,GAAG,IAAI;QACvB,IAAI,CAACD,iBAAiB,GAAG,IAAI;QAC7B,IAAI,CAACD,WAAW,GAAG,KAAK;QACxB,IAAI,CAACK,MAAM,GAAG,KAAK;QAEnBP,SAAS,CAAC,CAAC,EAAE2B,KAAK,CAACC,OAAO,CAACC,GAAG,CAC5B,CAAwB,yBACxB,IAAI,CAACvB,eAAe;QAEtBN,SAAS,CAAC,CAAC,EAAE2B,KAAK,CAACG,IAAI,CAACD,GAAG,CAAC,CAAwB,yBAAE,IAAI,CAACf,YAAY;QAEvEd,SAAS,CAAC,CAAC,EAAE2B,KAAK,CAACC,OAAO,CAACC,GAAG,CAC5B,CAAwB,yBACxB,IAAI,CAAC5B,eAAe;QAEtBD,SAAS,CAAC,CAAC,EAAE2B,KAAK,CAACG,IAAI,CAACD,GAAG,CAAC,CAAwB,yBAAE,IAAI,CAAClB,YAAY;IACzE,CAAC;;QAzBUZ,oBAAoB,GAApBA,oBAAoB;MAsG3B2B,WAAW;iBAED,CAAC;QACb,IAAI,CAACK,OAAO,GAAG,GAAG,CAACC,GAAG;IACxB,CAAC;IAEDC,WAAW,CAACC,EAAwB,EAAE,CAAC;QACrC,GAAG,EAAE,KAAK,CAAClB,MAAM,IAAI,IAAI,CAACe,OAAO,CAAE,CAAC;YAClCG,EAAE,CAAClB,MAAM;QACX,CAAC;IACH,CAAC;IAEDS,KAAK,GAAG,CAAC;QACP,IAAI,CAACQ,WAAW,EAAEjB,MAAM,GAAK,CAAC;YAC5BA,MAAM,CAACS,KAAK;QACd,CAAC;QACD,IAAI,CAACM,OAAO,CAACI,KAAK;IACpB,CAAC;IAEDlB,OAAO,CAACD,MAAU,EAAE,CAAC;QACnB,IAAI,CAACe,OAAO,CAACK,GAAG,CAACpB,MAAM;QACvBA,MAAM,CAACqB,gBAAgB,CAAC,CAAO,YAAQ,CAAC;YACtC,IAAI,CAACN,OAAO,CAACO,MAAM,CAACtB,MAAM;QAC5B,CAAC;IACH,CAAC;IAEDP,OAAO,CAACe,OAAY,EAAE,CAAC;QACrB,IAAI,CAACS,WAAW,EAAEjB,MAAM,GAAK,CAAC;YAC5BA,MAAM,CAACuB,IAAI,CAACC,IAAI,CAACC,SAAS,CAACjB,OAAO;QACpC,CAAC;IACH,CAAC"}