{"version":3,"sources":["../../../server/dev/on-demand-entry-handler.ts"],"sourcesContent":["import { EventEmitter } from 'events'\nimport { join, posix } from 'path'\nimport type { webpack5 as webpack } from 'next/dist/compiled/webpack/webpack'\nimport { normalizePagePath, normalizePathSep } from '../normalize-page-path'\nimport { pageNotFoundError } from '../require'\nimport { findPageFile } from '../lib/find-page-file'\nimport getRouteFromEntrypoint from '../get-route-from-entrypoint'\nimport { API_ROUTE, MIDDLEWARE_ROUTE } from '../../lib/constants'\nimport { reportTrigger } from '../../build/output'\nimport type ws from 'ws'\nimport { NextConfigComplete } from '../config-shared'\nimport { isCustomErrorPage } from '../../build/utils'\n\nexport const ADDED = Symbol('added')\nexport const BUILDING = Symbol('building')\nexport const BUILT = Symbol('built')\n\nexport const entries: {\n  [page: string]: {\n    bundlePath: string\n    absolutePagePath: string\n    status?: typeof ADDED | typeof BUILDING | typeof BUILT\n    lastActiveTime?: number\n    dispose?: boolean\n  }\n} = {}\n\nexport default function onDemandEntryHandler(\n  watcher: any,\n  multiCompiler: webpack.MultiCompiler,\n  {\n    pagesDir,\n    nextConfig,\n    maxInactiveAge,\n    pagesBufferLength,\n  }: {\n    pagesDir: string\n    nextConfig: NextConfigComplete\n    maxInactiveAge: number\n    pagesBufferLength: number\n  }\n) {\n  const { compilers } = multiCompiler\n  const invalidator = new Invalidator(watcher, multiCompiler)\n\n  let lastClientAccessPages = ['']\n  let doneCallbacks: EventEmitter | null = new EventEmitter()\n\n  for (const compiler of compilers) {\n    compiler.hooks.make.tap(\n      'NextJsOnDemandEntries',\n      (_compilation: webpack.Compilation) => {\n        invalidator.startBuilding()\n      }\n    )\n  }\n\n  function getPagePathsFromEntrypoints(\n    type: string,\n    entrypoints: any\n  ): string[] {\n    const pagePaths = []\n    for (const entrypoint of entrypoints.values()) {\n      const page = getRouteFromEntrypoint(entrypoint.name)\n      if (page) {\n        pagePaths.push(`${type}${page}`)\n      }\n    }\n\n    return pagePaths\n  }\n\n  multiCompiler.hooks.done.tap('NextJsOnDemandEntries', (multiStats) => {\n    if (invalidator.rebuildAgain) {\n      return invalidator.doneBuilding()\n    }\n    const [clientStats, serverStats, serverWebStats] = multiStats.stats\n    const pagePaths = [\n      ...getPagePathsFromEntrypoints(\n        'client',\n        clientStats.compilation.entrypoints\n      ),\n      ...getPagePathsFromEntrypoints(\n        'server',\n        serverStats.compilation.entrypoints\n      ),\n      ...(serverWebStats\n        ? getPagePathsFromEntrypoints(\n            'server-web',\n            serverWebStats.compilation.entrypoints\n          )\n        : []),\n    ]\n\n    for (const page of pagePaths) {\n      const entry = entries[page]\n      if (!entry) {\n        continue\n      }\n\n      if (entry.status !== BUILDING) {\n        continue\n      }\n\n      entry.status = BUILT\n      doneCallbacks!.emit(page)\n    }\n\n    invalidator.doneBuilding()\n  })\n\n  const pingIntervalTime = Math.max(1000, Math.min(5000, maxInactiveAge))\n\n  const disposeHandler = setInterval(function () {\n    disposeInactiveEntries(watcher, lastClientAccessPages, maxInactiveAge)\n  }, pingIntervalTime + 1000)\n\n  disposeHandler.unref()\n\n  function handlePing(pg: string) {\n    const page = normalizePathSep(pg)\n    const pageKey = `client${page}`\n    const entryInfo = entries[pageKey]\n    let toSend\n\n    // If there's no entry, it may have been invalidated and needs to be re-built.\n    if (!entryInfo) {\n      // if (page !== lastEntry) client pings, but there's no entry for page\n      return { invalid: true }\n    }\n\n    // 404 is an on demand entry but when a new page is added we have to refresh the page\n    if (page === '/_error') {\n      toSend = { invalid: true }\n    } else {\n      toSend = { success: true }\n    }\n\n    // We don't need to maintain active state of anything other than BUILT entries\n    if (entryInfo.status !== BUILT) return\n\n    // If there's an entryInfo\n    if (!lastClientAccessPages.includes(pageKey)) {\n      lastClientAccessPages.unshift(pageKey)\n\n      // Maintain the buffer max length\n      if (lastClientAccessPages.length > pagesBufferLength) {\n        lastClientAccessPages.pop()\n      }\n    }\n    entryInfo.lastActiveTime = Date.now()\n    entryInfo.dispose = false\n    return toSend\n  }\n\n  return {\n    async ensurePage(page: string, clientOnly: boolean) {\n      let normalizedPagePath: string\n      try {\n        normalizedPagePath = normalizePagePath(page)\n      } catch (err) {\n        console.error(err)\n        throw pageNotFoundError(page)\n      }\n\n      let pagePath = await findPageFile(\n        pagesDir,\n        normalizedPagePath,\n        nextConfig.pageExtensions\n      )\n\n      // Default the /_error route to the Next.js provided default page\n      if (page === '/_error' && pagePath === null) {\n        pagePath = 'next/dist/pages/_error'\n      }\n\n      if (pagePath === null) {\n        throw pageNotFoundError(normalizedPagePath)\n      }\n\n      let bundlePath: string\n      let absolutePagePath: string\n      if (pagePath.startsWith('next/dist/pages/')) {\n        bundlePath = page\n        absolutePagePath = require.resolve(pagePath)\n      } else {\n        let pageUrl = pagePath.replace(/\\\\/g, '/')\n\n        pageUrl = `${pageUrl[0] !== '/' ? '/' : ''}${pageUrl\n          .replace(\n            new RegExp(`\\\\.+(?:${nextConfig.pageExtensions.join('|')})$`),\n            ''\n          )\n          .replace(/\\/index$/, '')}`\n\n        pageUrl = pageUrl === '' ? '/' : pageUrl\n        const bundleFile = normalizePagePath(pageUrl)\n        bundlePath = posix.join('pages', bundleFile)\n        absolutePagePath = join(pagesDir, pagePath)\n        page = posix.normalize(pageUrl)\n      }\n\n      const normalizedPage = normalizePathSep(page)\n\n      const isMiddleware = normalizedPage.match(MIDDLEWARE_ROUTE)\n      const isApiRoute = normalizedPage.match(API_ROUTE) && !isMiddleware\n      const isServerWeb = !!nextConfig.experimental.concurrentFeatures\n      const isCustomError = isCustomErrorPage(page)\n\n      let entriesChanged = false\n      const addPageEntry = (type: 'client' | 'server' | 'server-web') => {\n        return new Promise<void>((resolve, reject) => {\n          // Makes sure the page that is being kept in on-demand-entries matches the webpack output\n          const pageKey = `${type}${page}`\n          const entryInfo = entries[pageKey]\n\n          if (entryInfo) {\n            entryInfo.lastActiveTime = Date.now()\n            entryInfo.dispose = false\n            if (entryInfo.status === BUILT) {\n              resolve()\n              return\n            }\n\n            doneCallbacks!.once(pageKey, handleCallback)\n            return\n          }\n\n          entriesChanged = true\n\n          entries[pageKey] = {\n            bundlePath,\n            absolutePagePath,\n            status: ADDED,\n            lastActiveTime: Date.now(),\n            dispose: false,\n          }\n          doneCallbacks!.once(pageKey, handleCallback)\n\n          function handleCallback(err: Error) {\n            if (err) return reject(err)\n            resolve()\n          }\n        })\n      }\n\n      const isClientOrMiddleware = clientOnly || isMiddleware\n\n      const promise = isApiRoute\n        ? addPageEntry('server')\n        : isClientOrMiddleware\n        ? addPageEntry('client')\n        : Promise.all([\n            addPageEntry('client'),\n            addPageEntry(\n              isServerWeb && !isCustomError ? 'server-web' : 'server'\n            ),\n          ])\n\n      if (entriesChanged) {\n        reportTrigger(\n          isApiRoute || isMiddleware || clientOnly\n            ? normalizedPage\n            : `${normalizedPage} (client and server)`\n        )\n        invalidator.invalidate()\n      }\n\n      return promise\n    },\n\n    onHMR(client: ws) {\n      client.addEventListener('message', ({ data }) => {\n        data = typeof data !== 'string' ? data.toString() : data\n        try {\n          const parsedData = JSON.parse(data)\n\n          if (parsedData.event === 'ping') {\n            const result = handlePing(parsedData.page)\n            client.send(\n              JSON.stringify({\n                ...result,\n                event: 'pong',\n              })\n            )\n          }\n        } catch (_) {}\n      })\n    },\n  }\n}\n\nfunction disposeInactiveEntries(\n  _watcher: any,\n  lastClientAccessPages: any,\n  maxInactiveAge: number\n) {\n  Object.keys(entries).forEach((page) => {\n    const { lastActiveTime, status, dispose } = entries[page]\n\n    // Skip pages already scheduled for disposing\n    if (dispose) return\n\n    // This means this entry is currently building or just added\n    // We don't need to dispose those entries.\n    if (status !== BUILT) return\n\n    // We should not build the last accessed page even we didn't get any pings\n    // Sometimes, it's possible our XHR ping to wait before completing other requests.\n    // In that case, we should not dispose the current viewing page\n    if (lastClientAccessPages.includes(page)) return\n\n    if (lastActiveTime && Date.now() - lastActiveTime > maxInactiveAge) {\n      entries[page].dispose = true\n    }\n  })\n}\n\n// Make sure only one invalidation happens at a time\n// Otherwise, webpack hash gets changed and it'll force the client to reload.\nclass Invalidator {\n  private multiCompiler: webpack.MultiCompiler\n  private watcher: any\n  private building: boolean\n  public rebuildAgain: boolean\n\n  constructor(watcher: any, multiCompiler: webpack.MultiCompiler) {\n    this.multiCompiler = multiCompiler\n    this.watcher = watcher\n    // contains an array of types of compilers currently building\n    this.building = false\n    this.rebuildAgain = false\n  }\n\n  invalidate() {\n    // If there's a current build is processing, we won't abort it by invalidating.\n    // (If aborted, it'll cause a client side hard reload)\n    // But let it to invalidate just after the completion.\n    // So, it can re-build the queued pages at once.\n    if (this.building) {\n      this.rebuildAgain = true\n      return\n    }\n\n    this.building = true\n    this.watcher.invalidate()\n  }\n\n  startBuilding() {\n    this.building = true\n  }\n\n  doneBuilding() {\n    this.building = false\n\n    if (this.rebuildAgain) {\n      this.rebuildAgain = false\n      this.invalidate()\n    }\n  }\n}\n"],"names":["onDemandEntryHandler","ADDED","Symbol","BUILDING","BUILT","entries","watcher","multiCompiler","pagesDir","nextConfig","maxInactiveAge","pagesBufferLength","compilers","invalidator","Invalidator","lastClientAccessPages","doneCallbacks","compiler","hooks","make","tap","_compilation","startBuilding","getPagePathsFromEntrypoints","type","entrypoints","pagePaths","entrypoint","values","page","name","push","done","multiStats","rebuildAgain","doneBuilding","clientStats","serverStats","serverWebStats","stats","compilation","entry","status","emit","pingIntervalTime","Math","max","min","disposeHandler","setInterval","disposeInactiveEntries","unref","handlePing","pg","pageKey","entryInfo","toSend","invalid","success","includes","unshift","length","pop","lastActiveTime","Date","now","dispose","ensurePage","clientOnly","normalizedPagePath","err","console","error","pagePath","pageExtensions","bundlePath","absolutePagePath","startsWith","require","resolve","pageUrl","replace","RegExp","join","bundleFile","normalize","normalizedPage","isMiddleware","match","isApiRoute","isServerWeb","experimental","concurrentFeatures","isCustomError","entriesChanged","addPageEntry","Promise","reject","once","handleCallback","isClientOrMiddleware","promise","all","invalidate","onHMR","client","addEventListener","data","toString","parsedData","JSON","parse","event","result","send","stringify","_","_watcher","Object","keys","forEach","building"],"mappings":"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"}