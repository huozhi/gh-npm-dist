{"version":3,"sources":["../../server/require.ts"],"sourcesContent":["import { promises } from 'fs'\nimport { join } from 'path'\nimport {\n  FONT_MANIFEST,\n  MIDDLEWARE_MANIFEST,\n  PAGES_MANIFEST,\n  SERVER_DIRECTORY,\n  SERVERLESS_DIRECTORY,\n} from '../shared/lib/constants'\nimport { normalizePagePath, denormalizePagePath } from './normalize-page-path'\nimport { normalizeLocalePath } from '../shared/lib/i18n/normalize-locale-path'\nimport type { PagesManifest } from '../build/webpack/plugins/pages-manifest-plugin'\nimport type { MiddlewareManifest } from '../build/webpack/plugins/middleware-plugin'\n\nexport function pageNotFoundError(page: string): Error {\n  const err: any = new Error(`Cannot find module for page: ${page}`)\n  err.code = 'ENOENT'\n  return err\n}\n\nexport function getPagePath(\n  page: string,\n  distDir: string,\n  serverless: boolean,\n  dev?: boolean,\n  locales?: string[]\n): string {\n  const serverBuildPath = join(\n    distDir,\n    serverless && !dev ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY\n  )\n  const pagesManifest = require(join(\n    serverBuildPath,\n    PAGES_MANIFEST\n  )) as PagesManifest\n\n  try {\n    page = denormalizePagePath(normalizePagePath(page))\n  } catch (err) {\n    console.error(err)\n    throw pageNotFoundError(page)\n  }\n  let pagePath = pagesManifest[page]\n\n  if (!pagesManifest[page] && locales) {\n    const manifestNoLocales: typeof pagesManifest = {}\n\n    for (const key of Object.keys(pagesManifest)) {\n      manifestNoLocales[normalizeLocalePath(key, locales).pathname] =\n        pagesManifest[key]\n    }\n    pagePath = manifestNoLocales[page]\n  }\n\n  if (!pagePath) {\n    throw pageNotFoundError(page)\n  }\n\n  return join(serverBuildPath, pagePath)\n}\n\nexport function requirePage(\n  page: string,\n  distDir: string,\n  serverless: boolean\n): any {\n  const pagePath = getPagePath(page, distDir, serverless)\n  if (pagePath.endsWith('.html')) {\n    return promises.readFile(pagePath, 'utf8')\n  }\n  return require(pagePath)\n}\n\nexport function requireFontManifest(distDir: string, serverless: boolean) {\n  const serverBuildPath = join(\n    distDir,\n    serverless ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY\n  )\n  const fontManifest = require(join(serverBuildPath, FONT_MANIFEST))\n  return fontManifest\n}\n\nexport function getMiddlewareInfo(params: {\n  dev?: boolean\n  distDir: string\n  page: string\n  serverless: boolean\n}): { name: string; paths: string[]; env: string[] } {\n  const serverBuildPath = join(\n    params.distDir,\n    params.serverless && !params.dev ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY\n  )\n\n  const middlewareManifest: MiddlewareManifest = require(join(\n    serverBuildPath,\n    MIDDLEWARE_MANIFEST\n  ))\n\n  let page: string\n\n  try {\n    page = denormalizePagePath(normalizePagePath(params.page))\n  } catch (err) {\n    throw pageNotFoundError(params.page)\n  }\n\n  let pageInfo = middlewareManifest.middleware[page]\n  if (!pageInfo) {\n    throw pageNotFoundError(page)\n  }\n\n  return {\n    name: pageInfo.name,\n    paths: pageInfo.files.map((file) => join(params.distDir, file)),\n    env: pageInfo.env ?? [],\n  }\n}\n"],"names":["pageNotFoundError","getPagePath","requirePage","requireFontManifest","getMiddlewareInfo","page","err","Error","code","distDir","serverless","dev","locales","serverBuildPath","pagesManifest","require","console","error","pagePath","manifestNoLocales","key","Object","keys","pathname","endsWith","readFile","fontManifest","params","middlewareManifest","pageInfo","middleware","name","paths","files","map","file","env"],"mappings":"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"}