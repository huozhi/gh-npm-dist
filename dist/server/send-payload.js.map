{"version":3,"sources":["../../server/send-payload.ts"],"sourcesContent":["import type { IncomingMessage, ServerResponse } from 'http'\nimport type { BaseNextResponse } from './base-http'\n\nimport { isResSent } from '../shared/lib/utils'\nimport generateETag from 'next/dist/compiled/etag'\nimport fresh from 'next/dist/compiled/fresh'\nimport RenderResult from './render-result'\n\nexport type PayloadOptions =\n  | { private: true }\n  | { private: boolean; stateful: true }\n  | { private: boolean; stateful: false; revalidate: number | false }\n\nexport function setRevalidateHeaders(\n  res: ServerResponse | BaseNextResponse,\n  options: PayloadOptions\n) {\n  if (options.private || options.stateful) {\n    if (options.private || !res.hasHeader('Cache-Control')) {\n      res.setHeader(\n        'Cache-Control',\n        `private, no-cache, no-store, max-age=0, must-revalidate`\n      )\n    }\n  } else if (typeof options.revalidate === 'number') {\n    if (options.revalidate < 1) {\n      throw new Error(\n        `invariant: invalid Cache-Control duration provided: ${options.revalidate} < 1`\n      )\n    }\n\n    res.setHeader(\n      'Cache-Control',\n      `s-maxage=${options.revalidate}, stale-while-revalidate`\n    )\n  } else if (options.revalidate === false) {\n    res.setHeader('Cache-Control', `s-maxage=31536000, stale-while-revalidate`)\n  }\n}\n\nexport async function sendRenderResult({\n  req,\n  res,\n  result,\n  type,\n  generateEtags,\n  poweredByHeader,\n  options,\n}: {\n  req: IncomingMessage\n  res: ServerResponse\n  result: RenderResult\n  type: 'html' | 'json'\n  generateEtags: boolean\n  poweredByHeader: boolean\n  options?: PayloadOptions\n}): Promise<void> {\n  if (isResSent(res)) {\n    return\n  }\n\n  if (poweredByHeader && type === 'html') {\n    res.setHeader('X-Powered-By', 'Next.js')\n  }\n\n  const payload = result.isDynamic() ? null : await result.toUnchunkedString()\n\n  if (payload) {\n    const etag = generateEtags ? generateETag(payload) : undefined\n    if (sendEtagResponse(req, res, etag)) {\n      return\n    }\n  }\n\n  if (!res.getHeader('Content-Type')) {\n    res.setHeader(\n      'Content-Type',\n      type === 'json' ? 'application/json' : 'text/html; charset=utf-8'\n    )\n  }\n\n  if (payload) {\n    res.setHeader('Content-Length', Buffer.byteLength(payload))\n  }\n\n  if (options != null) {\n    setRevalidateHeaders(res, options)\n  }\n\n  if (req.method === 'HEAD') {\n    res.end(null)\n  } else if (payload) {\n    res.end(payload)\n  } else {\n    await result.pipe(res)\n  }\n}\n\nexport function sendEtagResponse(\n  req: IncomingMessage,\n  res: ServerResponse,\n  etag: string | undefined\n): boolean {\n  if (etag) {\n    /**\n     * The server generating a 304 response MUST generate any of the\n     * following header fields that would have been sent in a 200 (OK)\n     * response to the same request: Cache-Control, Content-Location, Date,\n     * ETag, Expires, and Vary. https://tools.ietf.org/html/rfc7232#section-4.1\n     */\n    res.setHeader('ETag', etag)\n  }\n\n  if (fresh(req.headers, { etag })) {\n    res.statusCode = 304\n    res.end()\n    return true\n  }\n\n  return false\n}\n"],"names":["setRevalidateHeaders","sendRenderResult","sendEtagResponse","res","options","private","stateful","hasHeader","setHeader","revalidate","Error","req","result","type","generateEtags","poweredByHeader","payload","isDynamic","toUnchunkedString","etag","undefined","getHeader","Buffer","byteLength","method","end","pipe","headers","statusCode"],"mappings":"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"}