{"version":3,"sources":["../../server/web-server.ts"],"sourcesContent":["import type { WebNextRequest, WebNextResponse } from './base-http'\nimport type { RenderOpts } from './render'\nimport type RenderResult from './render-result'\nimport type { NextParsedUrlQuery } from './request-meta'\nimport type { Params } from './router'\nimport type { PayloadOptions } from './send-payload'\nimport type { LoadComponentsReturnType } from './load-components'\n\nimport BaseServer, { Options } from './base-server'\nimport { renderToHTML } from './render'\n\ninterface WebServerConfig {\n  loadComponent: (pathname: string) => Promise<LoadComponentsReturnType | null>\n  extendRenderOpts?: Partial<BaseServer['renderOpts']>\n}\n\nexport default class NextWebServer extends BaseServer {\n  webServerConfig: WebServerConfig\n\n  constructor(options: Options & { webServerConfig: WebServerConfig }) {\n    super(options)\n    this.webServerConfig = options.webServerConfig\n    Object.assign(this.renderOpts, options.webServerConfig.extendRenderOpts)\n  }\n  protected generateRewrites() {\n    // @TODO: assuming minimal mode right now\n    return {\n      beforeFiles: [],\n      afterFiles: [],\n      fallback: [],\n    }\n  }\n  protected handleCompression() {\n    // @TODO\n  }\n  protected getRoutesManifest() {\n    return {\n      headers: [],\n      rewrites: {\n        fallback: [],\n        afterFiles: [],\n        beforeFiles: [],\n      },\n      redirects: [],\n    }\n  }\n  protected getPagePath() {\n    // @TODO\n    return ''\n  }\n  protected getPublicDir() {\n    // @TODO\n    return ''\n  }\n  protected getBuildId() {\n    return (globalThis as any).__server_context.buildId\n  }\n  protected loadEnvConfig() {\n    // @TODO\n  }\n  protected getHasStaticDir() {\n    return false\n  }\n  protected async hasMiddleware() {\n    return false\n  }\n  protected generateImageRoutes() {\n    return []\n  }\n  protected generateStaticRoutes() {\n    return []\n  }\n  protected generateFsStaticRoutes() {\n    return []\n  }\n  protected generatePublicRoutes() {\n    return []\n  }\n  protected getMiddleware() {\n    return []\n  }\n  protected generateCatchAllMiddlewareRoute() {\n    return undefined\n  }\n  protected getFontManifest() {\n    return undefined\n  }\n  protected getMiddlewareManifest() {\n    return undefined\n  }\n  protected getPagesManifest() {\n    return {\n      [(globalThis as any).__server_context.page]: '',\n    }\n  }\n  protected getFilesystemPaths() {\n    return new Set<string>()\n  }\n  protected getPrerenderManifest() {\n    return {\n      version: 3 as const,\n      routes: {},\n      dynamicRoutes: {},\n      notFoundRoutes: [],\n      preview: {\n        previewModeId: '',\n        previewModeSigningKey: '',\n        previewModeEncryptionKey: '',\n      },\n    }\n  }\n  protected async renderHTML(\n    req: WebNextRequest,\n    _res: WebNextResponse,\n    pathname: string,\n    query: NextParsedUrlQuery,\n    renderOpts: RenderOpts\n  ): Promise<RenderResult | null> {\n    return renderToHTML(\n      {\n        url: pathname,\n        cookies: req.cookies,\n        headers: req.headers,\n      } as any,\n      {} as any,\n      pathname,\n      query,\n      {\n        ...renderOpts,\n        supportsDynamicHTML: true,\n        concurrentFeatures: true,\n        disableOptimizedLoading: true,\n      }\n    )\n  }\n  protected async sendRenderResult(\n    _req: WebNextRequest,\n    res: WebNextResponse,\n    options: {\n      result: RenderResult\n      type: 'html' | 'json'\n      generateEtags: boolean\n      poweredByHeader: boolean\n      options?: PayloadOptions | undefined\n    }\n  ): Promise<void> {\n    // @TODO\n    const writer = res.transformStream.writable.getWriter()\n    options.result.pipe({\n      write: (chunk: Uint8Array) => writer.write(chunk),\n      end: () => writer.close(),\n      destroy: (err: Error) => writer.abort(err),\n      cork: () => {},\n      uncork: () => {},\n      // Not implemented: on/removeListener\n    } as any)\n\n    // To prevent Safari's bfcache caching the \"shell\", we have to add the\n    // `no-cache` header to document responses.\n    res.setHeader(\n      'Cache-Control',\n      'no-cache, no-store, max-age=0, must-revalidate'\n    )\n    res.send()\n  }\n  protected async runApi() {\n    // @TODO\n    return true\n  }\n  protected async findPageComponents(\n    pathname: string,\n    query?: NextParsedUrlQuery,\n    params?: Params | null\n  ) {\n    const result = await this.webServerConfig.loadComponent(pathname)\n    if (!result) return null\n\n    return {\n      query: {\n        ...(query || {}),\n        ...(params || {}),\n      },\n      components: result,\n    }\n  }\n\n  public updateRenderOpts(renderOpts: Partial<BaseServer['renderOpts']>) {\n    Object.assign(this.renderOpts, renderOpts)\n  }\n}\n"],"names":["NextWebServer","options","webServerConfig","Object","assign","renderOpts","extendRenderOpts","generateRewrites","beforeFiles","afterFiles","fallback","handleCompression","getRoutesManifest","headers","rewrites","redirects","getPagePath","getPublicDir","getBuildId","globalThis","__server_context","buildId","loadEnvConfig","getHasStaticDir","hasMiddleware","generateImageRoutes","generateStaticRoutes","generateFsStaticRoutes","generatePublicRoutes","getMiddleware","generateCatchAllMiddlewareRoute","undefined","getFontManifest","getMiddlewareManifest","getPagesManifest","page","getFilesystemPaths","Set","getPrerenderManifest","version","routes","dynamicRoutes","notFoundRoutes","preview","previewModeId","previewModeSigningKey","previewModeEncryptionKey","renderHTML","req","_res","pathname","query","url","cookies","supportsDynamicHTML","concurrentFeatures","disableOptimizedLoading","sendRenderResult","_req","res","writer","transformStream","writable","getWriter","result","pipe","write","chunk","end","close","destroy","err","abort","cork","uncork","setHeader","send","runApi","findPageComponents","params","loadComponent","components","updateRenderOpts"],"mappings":";;;;;AAQoC,GAAe,CAAf,WAAe;AACtB,GAAU,CAAV,OAAU;;;;;;MAOlBA,aAAa,SARE,WAAe;gBAWrCC,OAAuD,CAAE,CAAC;QACpE,KAAK,CAACA,OAAO;QACb,IAAI,CAACC,eAAe,GAAGD,OAAO,CAACC,eAAe;QAC9CC,MAAM,CAACC,MAAM,CAAC,IAAI,CAACC,UAAU,EAAEJ,OAAO,CAACC,eAAe,CAACI,gBAAgB;IACzE,CAAC;IACSC,gBAAgB,GAAG,CAAC;QAC5B,EAAyC,AAAzC,uCAAyC;QACzC,MAAM,CAAC,CAAC;YACNC,WAAW,EAAE,CAAC,CAAC;YACfC,UAAU,EAAE,CAAC,CAAC;YACdC,QAAQ,EAAE,CAAC,CAAC;QACd,CAAC;IACH,CAAC;IACSC,iBAAiB,GAAG,CAAC;IAC7B,EAAQ,AAAR,MAAQ;IACV,CAAC;IACSC,iBAAiB,GAAG,CAAC;QAC7B,MAAM,CAAC,CAAC;YACNC,OAAO,EAAE,CAAC,CAAC;YACXC,QAAQ,EAAE,CAAC;gBACTJ,QAAQ,EAAE,CAAC,CAAC;gBACZD,UAAU,EAAE,CAAC,CAAC;gBACdD,WAAW,EAAE,CAAC,CAAC;YACjB,CAAC;YACDO,SAAS,EAAE,CAAC,CAAC;QACf,CAAC;IACH,CAAC;IACSC,WAAW,GAAG,CAAC;QACvB,EAAQ,AAAR,MAAQ;QACR,MAAM,CAAC,CAAE;IACX,CAAC;IACSC,YAAY,GAAG,CAAC;QACxB,EAAQ,AAAR,MAAQ;QACR,MAAM,CAAC,CAAE;IACX,CAAC;IACSC,UAAU,GAAG,CAAC;QACtB,MAAM,CAAEC,UAAU,CAASC,gBAAgB,CAACC,OAAO;IACrD,CAAC;IACSC,aAAa,GAAG,CAAC;IACzB,EAAQ,AAAR,MAAQ;IACV,CAAC;IACSC,eAAe,GAAG,CAAC;QAC3B,MAAM,CAAC,KAAK;IACd,CAAC;UACeC,aAAa,GAAG,CAAC;QAC/B,MAAM,CAAC,KAAK;IACd,CAAC;IACSC,mBAAmB,GAAG,CAAC;QAC/B,MAAM,CAAC,CAAC,CAAC;IACX,CAAC;IACSC,oBAAoB,GAAG,CAAC;QAChC,MAAM,CAAC,CAAC,CAAC;IACX,CAAC;IACSC,sBAAsB,GAAG,CAAC;QAClC,MAAM,CAAC,CAAC,CAAC;IACX,CAAC;IACSC,oBAAoB,GAAG,CAAC;QAChC,MAAM,CAAC,CAAC,CAAC;IACX,CAAC;IACSC,aAAa,GAAG,CAAC;QACzB,MAAM,CAAC,CAAC,CAAC;IACX,CAAC;IACSC,+BAA+B,GAAG,CAAC;QAC3C,MAAM,CAACC,SAAS;IAClB,CAAC;IACSC,eAAe,GAAG,CAAC;QAC3B,MAAM,CAACD,SAAS;IAClB,CAAC;IACSE,qBAAqB,GAAG,CAAC;QACjC,MAAM,CAACF,SAAS;IAClB,CAAC;IACSG,gBAAgB,GAAG,CAAC;QAC5B,MAAM,CAAC,CAAC;aACJf,UAAU,CAASC,gBAAgB,CAACe,IAAI,GAAG,CAAE;QACjD,CAAC;IACH,CAAC;IACSC,kBAAkB,GAAG,CAAC;QAC9B,MAAM,CAAC,GAAG,CAACC,GAAG;IAChB,CAAC;IACSC,oBAAoB,GAAG,CAAC;QAChC,MAAM,CAAC,CAAC;YACNC,OAAO,EAAE,CAAC;YACVC,MAAM,EAAE,CAAC,CAAC;YACVC,aAAa,EAAE,CAAC,CAAC;YACjBC,cAAc,EAAE,CAAC,CAAC;YAClBC,OAAO,EAAE,CAAC;gBACRC,aAAa,EAAE,CAAE;gBACjBC,qBAAqB,EAAE,CAAE;gBACzBC,wBAAwB,EAAE,CAAE;YAC9B,CAAC;QACH,CAAC;IACH,CAAC;UACeC,UAAU,CACxBC,GAAmB,EACnBC,IAAqB,EACrBC,QAAgB,EAChBC,KAAyB,EACzB9C,UAAsB,EACQ,CAAC;QAC/B,MAAM,KA7GmB,OAAU,eA8GjC,CAAC;YACC+C,GAAG,EAAEF,QAAQ;YACbG,OAAO,EAAEL,GAAG,CAACK,OAAO;YACpBxC,OAAO,EAAEmC,GAAG,CAACnC,OAAO;QACtB,CAAC,EACD,CAAC,CAAC,EACFqC,QAAQ,EACRC,KAAK,EACL,CAAC;eACI9C,UAAU;YACbiD,mBAAmB,EAAE,IAAI;YACzBC,kBAAkB,EAAE,IAAI;YACxBC,uBAAuB,EAAE,IAAI;QAC/B,CAAC;IAEL,CAAC;UACeC,gBAAgB,CAC9BC,IAAoB,EACpBC,GAAoB,EACpB1D,OAMC,EACc,CAAC;QAChB,EAAQ,AAAR,MAAQ;QACR,KAAK,CAAC2D,MAAM,GAAGD,GAAG,CAACE,eAAe,CAACC,QAAQ,CAACC,SAAS;QACrD9D,OAAO,CAAC+D,MAAM,CAACC,IAAI,CAAC,CAAC;YACnBC,KAAK,GAAGC,KAAiB,GAAKP,MAAM,CAACM,KAAK,CAACC,KAAK;;YAChDC,GAAG,MAAQR,MAAM,CAACS,KAAK;;YACvBC,OAAO,GAAGC,GAAU,GAAKX,MAAM,CAACY,KAAK,CAACD,GAAG;;YACzCE,IAAI,MAAQ,CAAC,CAAC;YACdC,MAAM,MAAQ,CAAC,CAAC;QAElB,CAAC;QAED,EAAsE,AAAtE,oEAAsE;QACtE,EAA2C,AAA3C,yCAA2C;QAC3Cf,GAAG,CAACgB,SAAS,CACX,CAAe,gBACf,CAAgD;QAElDhB,GAAG,CAACiB,IAAI;IACV,CAAC;UACeC,MAAM,GAAG,CAAC;QACxB,EAAQ,AAAR,MAAQ;QACR,MAAM,CAAC,IAAI;IACb,CAAC;UACeC,kBAAkB,CAChC5B,QAAgB,EAChBC,KAA0B,EAC1B4B,MAAsB,EACtB,CAAC;QACD,KAAK,CAACf,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC9D,eAAe,CAAC8E,aAAa,CAAC9B,QAAQ;QAChE,EAAE,GAAGc,MAAM,EAAE,MAAM,CAAC,IAAI;QAExB,MAAM,CAAC,CAAC;YACNb,KAAK,EAAE,CAAC;mBACFA,KAAK,IAAI,CAAC,CAAC;mBACX4B,MAAM,IAAI,CAAC,CAAC;YAClB,CAAC;YACDE,UAAU,EAAEjB,MAAM;QACpB,CAAC;IACH,CAAC;IAEMkB,gBAAgB,CAAC7E,UAA6C,EAAE,CAAC;QACtEF,MAAM,CAACC,MAAM,CAAC,IAAI,CAACC,UAAU,EAAEA,UAAU;IAC3C,CAAC;;kBA5KkBL,aAAa"}