{"version":3,"sources":["../../../server/lib/start-server.ts"],"sourcesContent":["import type { NextServerOptions, NextServer, RequestHandler } from '../next'\nimport { warn } from '../../build/output/log'\nimport http from 'http'\nimport next from '../next'\n\ninterface StartServerOptions extends NextServerOptions {\n  allowRetry?: boolean\n}\n\nexport function startServer(opts: StartServerOptions) {\n  let requestHandler: RequestHandler\n\n  const server = http.createServer((req, res) => {\n    return requestHandler(req, res)\n  })\n\n  return new Promise<NextServer>((resolve, reject) => {\n    let port = opts.port\n    let retryCount = 0\n\n    server.on('error', (err: NodeJS.ErrnoException) => {\n      if (\n        port &&\n        opts.allowRetry &&\n        err.code === 'EADDRINUSE' &&\n        retryCount < 10\n      ) {\n        warn(`Port ${port} is in use, trying ${port + 1} instead.`)\n        port += 1\n        retryCount += 1\n        server.listen(port, opts.hostname)\n      } else {\n        reject(err)\n      }\n    })\n\n    server.on('listening', () => {\n      const addr = server.address()\n      const hostname =\n        !opts.hostname || opts.hostname === '0.0.0.0'\n          ? 'localhost'\n          : opts.hostname\n\n      const app = next({\n        ...opts,\n        hostname,\n        customServer: false,\n        httpServer: server,\n        port: addr && typeof addr === 'object' ? addr.port : port,\n      })\n\n      requestHandler = app.getRequestHandler()\n      resolve(app)\n    })\n\n    server.listen(port, opts.hostname)\n  })\n}\n"],"names":["startServer","opts","requestHandler","server","createServer","req","res","Promise","resolve","reject","port","retryCount","on","err","allowRetry","code","listen","hostname","addr","address","app","customServer","httpServer","getRequestHandler"],"mappings":";;;;QASgBA,WAAW,GAAXA,WAAW;AARN,GAAwB,CAAxB,IAAwB;AAC5B,GAAM,CAAN,KAAM;AACN,GAAS,CAAT,KAAS;;;;;;SAMVA,WAAW,CAACC,IAAwB,EAAE,CAAC;IACrD,GAAG,CAACC,cAAc;IAElB,KAAK,CAACC,MAAM,GAVG,KAAM,SAUDC,YAAY,EAAEC,GAAG,EAAEC,GAAG,GAAK,CAAC;QAC9C,MAAM,CAACJ,cAAc,CAACG,GAAG,EAAEC,GAAG;IAChC,CAAC;IAED,MAAM,CAAC,GAAG,CAACC,OAAO,EAAcC,OAAO,EAAEC,MAAM,GAAK,CAAC;QACnD,GAAG,CAACC,IAAI,GAAGT,IAAI,CAACS,IAAI;QACpB,GAAG,CAACC,UAAU,GAAG,CAAC;QAElBR,MAAM,CAACS,EAAE,CAAC,CAAO,SAAGC,GAA0B,GAAK,CAAC;YAClD,EAAE,EACAH,IAAI,IACJT,IAAI,CAACa,UAAU,IACfD,GAAG,CAACE,IAAI,KAAK,CAAY,eACzBJ,UAAU,GAAG,EAAE,EACf,CAAC;oBAzBY,IAAwB,QA0B/B,KAAK,EAAED,IAAI,CAAC,mBAAmB,EAAEA,IAAI,GAAG,CAAC,CAAC,SAAS;gBACzDA,IAAI,IAAI,CAAC;gBACTC,UAAU,IAAI,CAAC;gBACfR,MAAM,CAACa,MAAM,CAACN,IAAI,EAAET,IAAI,CAACgB,QAAQ;YACnC,CAAC,MAAM,CAAC;gBACNR,MAAM,CAACI,GAAG;YACZ,CAAC;QACH,CAAC;QAEDV,MAAM,CAACS,EAAE,CAAC,CAAW,gBAAQ,CAAC;YAC5B,KAAK,CAACM,IAAI,GAAGf,MAAM,CAACgB,OAAO;YAC3B,KAAK,CAACF,QAAQ,IACXhB,IAAI,CAACgB,QAAQ,IAAIhB,IAAI,CAACgB,QAAQ,KAAK,CAAS,WACzC,CAAW,aACXhB,IAAI,CAACgB,QAAQ;YAEnB,KAAK,CAACG,GAAG,OAxCE,KAAS,UAwCH,CAAC;mBACbnB,IAAI;gBACPgB,QAAQ;gBACRI,YAAY,EAAE,KAAK;gBACnBC,UAAU,EAAEnB,MAAM;gBAClBO,IAAI,EAAEQ,IAAI,IAAI,MAAM,CAACA,IAAI,KAAK,CAAQ,UAAGA,IAAI,CAACR,IAAI,GAAGA,IAAI;YAC3D,CAAC;YAEDR,cAAc,GAAGkB,GAAG,CAACG,iBAAiB;YACtCf,OAAO,CAACY,GAAG;QACb,CAAC;QAEDjB,MAAM,CAACa,MAAM,CAACN,IAAI,EAAET,IAAI,CAACgB,QAAQ;IACnC,CAAC;AACH,CAAC"}