{"version":3,"sources":["../../../server/web/utils.ts"],"sourcesContent":["import type { NodeHeaders } from './types'\n\nexport async function* streamToIterator<T>(\n  readable: ReadableStream<T>\n): AsyncIterableIterator<T> {\n  const reader = readable.getReader()\n  while (true) {\n    const { value, done } = await reader.read()\n    if (done) break\n    if (value) {\n      yield value\n    }\n  }\n  reader.releaseLock()\n}\n\nexport function readableStreamTee<T = any>(\n  readable: ReadableStream<T>\n): [ReadableStream<T>, ReadableStream<T>] {\n  const transformStream = new TransformStream()\n  const transformStream2 = new TransformStream()\n  const writer = transformStream.writable.getWriter()\n  const writer2 = transformStream2.writable.getWriter()\n\n  const reader = readable.getReader()\n  function read() {\n    reader.read().then(({ done, value }) => {\n      if (done) {\n        writer.close()\n        writer2.close()\n        return\n      }\n      writer.write(value)\n      writer2.write(value)\n      read()\n    })\n  }\n  read()\n\n  return [transformStream.readable, transformStream2.readable]\n}\n\nexport function notImplemented(name: string, method: string): any {\n  throw new Error(\n    `Failed to get the '${method}' property on '${name}': the property is not implemented`\n  )\n}\n\nexport function fromNodeHeaders(object: NodeHeaders): Headers {\n  const headers = new Headers()\n  for (let [key, value] of Object.entries(object)) {\n    const values = Array.isArray(value) ? value : [value]\n    for (let v of values) {\n      if (v !== undefined) {\n        headers.append(key, v)\n      }\n    }\n  }\n  return headers\n}\n\nexport function toNodeHeaders(headers?: Headers): NodeHeaders {\n  const result: NodeHeaders = {}\n  if (headers) {\n    for (const [key, value] of headers.entries()) {\n      result[key] = value\n      if (key.toLowerCase() === 'set-cookie') {\n        result[key] = splitCookiesString(value)\n      }\n    }\n  }\n  return result\n}\n\n/*\n  Set-Cookie header field-values are sometimes comma joined in one string. This splits them without choking on commas\n  that are within a single set-cookie field-value, such as in the Expires portion.\n  This is uncommon, but explicitly allowed - see https://tools.ietf.org/html/rfc2616#section-4.2\n  Node.js does this for every header *except* set-cookie - see https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib/_http_incoming.js#L128\n  React Native's fetch does this for *every* header, including set-cookie.\n  \n  Based on: https://github.com/google/j2objc/commit/16820fdbc8f76ca0c33472810ce0cb03d20efe25\n  Credits to: https://github.com/tomball for original and https://github.com/chrusart for JavaScript implementation\n*/\nexport function splitCookiesString(cookiesString: string) {\n  var cookiesStrings = []\n  var pos = 0\n  var start\n  var ch\n  var lastComma\n  var nextStart\n  var cookiesSeparatorFound\n\n  function skipWhitespace() {\n    while (pos < cookiesString.length && /\\s/.test(cookiesString.charAt(pos))) {\n      pos += 1\n    }\n    return pos < cookiesString.length\n  }\n\n  function notSpecialChar() {\n    ch = cookiesString.charAt(pos)\n\n    return ch !== '=' && ch !== ';' && ch !== ','\n  }\n\n  while (pos < cookiesString.length) {\n    start = pos\n    cookiesSeparatorFound = false\n\n    while (skipWhitespace()) {\n      ch = cookiesString.charAt(pos)\n      if (ch === ',') {\n        // ',' is a cookie separator if we have later first '=', not ';' or ','\n        lastComma = pos\n        pos += 1\n\n        skipWhitespace()\n        nextStart = pos\n\n        while (pos < cookiesString.length && notSpecialChar()) {\n          pos += 1\n        }\n\n        // currently special character\n        if (pos < cookiesString.length && cookiesString.charAt(pos) === '=') {\n          // we found cookies separator\n          cookiesSeparatorFound = true\n          // pos is inside the next cookie, so back up and return it.\n          pos = nextStart\n          cookiesStrings.push(cookiesString.substring(start, lastComma))\n          start = pos\n        } else {\n          // in param ',' or param separator ';',\n          // we continue from that comma\n          pos = lastComma + 1\n        }\n      } else {\n        pos += 1\n      }\n    }\n\n    if (!cookiesSeparatorFound || pos >= cookiesString.length) {\n      cookiesStrings.push(cookiesString.substring(start, cookiesString.length))\n    }\n  }\n\n  return cookiesStrings\n}\n\n/**\n * We will be soon deprecating the usage of relative URLs in Middleware introducing\n * URL validation. This helper puts the future code in place and prints a warning\n * for cases where it will break. Meanwhile we preserve the previous behavior.\n */\nexport function validateURL(url: string | URL): string {\n  try {\n    return String(new URL(String(url)))\n  } catch (error: any) {\n    console.log(\n      `warn  -`,\n      'using relative URLs for Middleware will be deprecated soon - https://nextjs.org/docs/messages/middleware-relative-urls'\n    )\n    return String(url)\n  }\n}\n"],"names":["streamToIterator","readableStreamTee","notImplemented","fromNodeHeaders","toNodeHeaders","splitCookiesString","validateURL","readable","reader","getReader","value","done","read","releaseLock","transformStream","TransformStream","transformStream2","writer","writable","getWriter","writer2","then","close","write","name","method","Error","object","headers","Headers","key","Object","entries","values","Array","isArray","v","undefined","append","result","toLowerCase","cookiesString","cookiesStrings","pos","start","ch","lastComma","nextStart","cookiesSeparatorFound","skipWhitespace","length","test","charAt","notSpecialChar","push","substring","url","String","URL","error","console","log"],"mappings":"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"}