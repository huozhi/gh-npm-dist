{"version":3,"sources":["../../../../server/web/sandbox/context.ts"],"sourcesContent":["import type { Context } from 'vm'\nimport { Blob, File, FormData } from 'next/dist/compiled/formdata-node'\nimport { readFileSync } from 'fs'\nimport { requireDependencies } from './require'\nimport { TransformStream } from 'next/dist/compiled/web-streams-polyfill'\nimport cookie from 'next/dist/compiled/cookie'\nimport * as polyfills from './polyfills'\nimport {\n  AbortController,\n  AbortSignal,\n} from 'next/dist/compiled/abort-controller'\nimport vm from 'vm'\n\nconst WEBPACK_HASH_REGEX =\n  /__webpack_require__\\.h = function\\(\\) \\{ return \"[0-9a-f]+\"; \\}/g\n\n/**\n * For a given path a context, this function checks if there is any module\n * context that contains the path with an older content and, if that's the\n * case, removes the context from the cache.\n */\nexport function clearModuleContext(path: string, content: Buffer | string) {\n  for (const [key, cache] of caches) {\n    const prev = cache?.paths.get(path)?.replace(WEBPACK_HASH_REGEX, '')\n    if (\n      typeof prev !== 'undefined' &&\n      prev !== content.toString().replace(WEBPACK_HASH_REGEX, '')\n    ) {\n      caches.delete(key)\n    }\n  }\n}\n\n/**\n * A Map of cached module contexts indexed by the module name. It allows\n * to have a different cache scoped per module name or depending on the\n * provided module key on creation.\n */\nconst caches = new Map<\n  string,\n  {\n    context: Context\n    paths: Map<string, string>\n    require: Map<string, any>\n    warnedEvals: Set<string>\n  }\n>()\n\n/**\n * For a given module name this function will create a context for the\n * runtime. It returns a function where we can provide a module path and\n * run in within the context. It may or may not use a cache depending on\n * the parameters.\n */\nexport function getModuleContext(options: {\n  module: string\n  onWarning: (warn: Error) => void\n  useCache: boolean\n  env: string[]\n}) {\n  let moduleCache = options.useCache\n    ? caches.get(options.module)\n    : createModuleContext(options)\n\n  if (!moduleCache) {\n    moduleCache = createModuleContext(options)\n    caches.set(options.module, moduleCache)\n  }\n\n  return {\n    context: moduleCache.context,\n    runInContext: (paramPath: string) => {\n      if (!moduleCache!.paths.has(paramPath)) {\n        const content = readFileSync(paramPath, 'utf-8')\n        try {\n          vm.runInNewContext(content, moduleCache!.context, {\n            filename: paramPath,\n          })\n          moduleCache!.paths.set(paramPath, content)\n        } catch (error) {\n          if (options.useCache) {\n            caches.delete(options.module)\n          }\n          throw error\n        }\n      }\n    },\n  }\n}\n\n/**\n * Create a module cache specific for the provided parameters. It includes\n * a context, require cache and paths cache and loads three types:\n * 1. Dependencies that hold no runtime dependencies.\n * 2. Dependencies that require runtime globals such as Blob.\n * 3. Dependencies that are scoped for the provided parameters.\n */\nfunction createModuleContext(options: {\n  onWarning: (warn: Error) => void\n  module: string\n  env: string[]\n}) {\n  const requireCache = new Map([\n    [require.resolve('next/dist/compiled/cookie'), { exports: cookie }],\n  ])\n\n  const context = createContext(options)\n\n  requireDependencies({\n    requireCache: requireCache,\n    context: context,\n    dependencies: [\n      {\n        path: require.resolve('../spec-compliant/headers'),\n        mapExports: { Headers: 'Headers' },\n      },\n      {\n        path: require.resolve('../spec-compliant/response'),\n        mapExports: { Response: 'Response' },\n      },\n      {\n        path: require.resolve('../spec-compliant/request'),\n        mapExports: { Request: 'Request' },\n      },\n    ],\n  })\n\n  const moduleCache = {\n    context: context,\n    paths: new Map<string, string>(),\n    require: requireCache,\n    warnedEvals: new Set<string>(),\n  }\n\n  context.__next_eval__ = function __next_eval__(fn: Function) {\n    const key = fn.toString()\n    if (!moduleCache.warnedEvals.has(key)) {\n      const warning = new Error(\n        `Dynamic Code Evaluation (e. g. 'eval', 'new Function') not allowed in Middleware`\n      )\n      warning.name = 'DynamicCodeEvaluationWarning'\n      Error.captureStackTrace(warning, __next_eval__)\n      moduleCache.warnedEvals.add(key)\n      options.onWarning(warning)\n    }\n    return fn()\n  }\n\n  context.fetch = (input: RequestInfo, init: RequestInit = {}) => {\n    init.headers = new Headers(init.headers ?? {})\n    const prevs = init.headers.get(`x-middleware-subrequest`)?.split(':') || []\n    const value = prevs.concat(options.module).join(':')\n    init.headers.set('x-middleware-subrequest', value)\n    init.headers.set(`user-agent`, `Next.js Middleware`)\n\n    if (typeof input === 'object' && 'url' in input) {\n      return fetch(input.url, {\n        ...init,\n        headers: {\n          ...Object.fromEntries(input.headers),\n          ...Object.fromEntries(init.headers),\n        },\n      })\n    }\n\n    return fetch(String(input), init)\n  }\n\n  return moduleCache\n}\n\n/**\n * Create a base context with all required globals for the runtime that\n * won't depend on any externally provided dependency.\n */\nfunction createContext(options: {\n  /** Environment variables to be provided to the context */\n  env: string[]\n}) {\n  const context: { [key: string]: unknown } = {\n    _ENTRIES: {},\n    atob: polyfills.atob,\n    Blob,\n    btoa: polyfills.btoa,\n    clearInterval,\n    clearTimeout,\n    console: {\n      assert: console.assert.bind(console),\n      error: console.error.bind(console),\n      info: console.info.bind(console),\n      log: console.log.bind(console),\n      time: console.time.bind(console),\n      timeEnd: console.timeEnd.bind(console),\n      timeLog: console.timeLog.bind(console),\n      warn: console.warn.bind(console),\n    },\n    AbortController: AbortController,\n    AbortSignal: AbortSignal,\n    CryptoKey: polyfills.CryptoKey,\n    Crypto: polyfills.Crypto,\n    crypto: new polyfills.Crypto(),\n    File,\n    FormData,\n    process: {\n      env: buildEnvironmentVariablesFrom(options.env),\n    },\n    ReadableStream: polyfills.ReadableStream,\n    setInterval,\n    setTimeout,\n    TextDecoder,\n    TextEncoder,\n    TransformStream,\n    URL,\n    URLSearchParams,\n\n    // Indexed collections\n    Array,\n    Int8Array,\n    Uint8Array,\n    Uint8ClampedArray,\n    Int16Array,\n    Uint16Array,\n    Int32Array,\n    Uint32Array,\n    Float32Array,\n    Float64Array,\n    BigInt64Array,\n    BigUint64Array,\n\n    // Keyed collections\n    Map,\n    Set,\n    WeakMap,\n    WeakSet,\n\n    // Structured data\n    ArrayBuffer,\n    SharedArrayBuffer,\n  }\n\n  // Self references\n  context.self = context\n  context.globalThis = context\n\n  return vm.createContext(context, {\n    codeGeneration:\n      process.env.NODE_ENV === 'production'\n        ? {\n            strings: false,\n            wasm: false,\n          }\n        : undefined,\n  })\n}\n\nfunction buildEnvironmentVariablesFrom(\n  keys: string[]\n): Record<string, string | undefined> {\n  const pairs = keys.map((key) => [key, process.env[key]])\n  return Object.fromEntries(pairs)\n}\n"],"names":["clearModuleContext","getModuleContext","polyfills","WEBPACK_HASH_REGEX","path","content","key","cache","caches","prev","paths","get","replace","toString","delete","Map","options","moduleCache","useCache","module","createModuleContext","set","context","runInContext","paramPath","has","runInNewContext","filename","error","requireCache","require","resolve","exports","createContext","dependencies","mapExports","Headers","Response","Request","warnedEvals","Set","__next_eval__","fn","warning","Error","name","captureStackTrace","add","onWarning","fetch","input","init","headers","prevs","split","value","concat","join","url","Object","fromEntries","String","_ENTRIES","atob","Blob","btoa","clearInterval","clearTimeout","console","assert","bind","info","log","time","timeEnd","timeLog","warn","AbortController","AbortSignal","CryptoKey","Crypto","crypto","File","FormData","process","env","buildEnvironmentVariablesFrom","ReadableStream","setInterval","setTimeout","TextDecoder","TextEncoder","TransformStream","URL","URLSearchParams","Array","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","self","globalThis","codeGeneration","NODE_ENV","strings","wasm","undefined","keys","pairs","map"],"mappings":"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"}