{"version":3,"sources":["../../../../server/web/spec-extension/response.ts"],"sourcesContent":["import type { I18NConfig } from '../../config-shared'\nimport { NextURL } from '../next-url'\nimport { toNodeHeaders, validateURL } from '../utils'\nimport cookie from 'next/dist/compiled/cookie'\nimport { CookieSerializeOptions } from '../types'\n\nconst INTERNALS = Symbol('internal response')\nconst REDIRECTS = new Set([301, 302, 303, 307, 308])\n\nexport class NextResponse extends Response {\n  [INTERNALS]: {\n    cookieParser(): { [key: string]: string }\n    url?: NextURL\n  }\n\n  constructor(body?: BodyInit | null, init: ResponseInit = {}) {\n    super(body, init)\n\n    const cookieParser = () => {\n      const value = this.headers.get('cookie')\n      return value ? cookie.parse(value) : {}\n    }\n\n    this[INTERNALS] = {\n      cookieParser,\n      url: init.url\n        ? new NextURL(init.url, {\n            basePath: init.nextConfig?.basePath,\n            i18n: init.nextConfig?.i18n,\n            trailingSlash: init.nextConfig?.trailingSlash,\n            headers: toNodeHeaders(this.headers),\n          })\n        : undefined,\n    }\n  }\n\n  public get cookies() {\n    return this[INTERNALS].cookieParser()\n  }\n\n  public cookie(\n    name: string,\n    value: { [key: string]: any } | string,\n    opts: CookieSerializeOptions = {}\n  ) {\n    const val =\n      typeof value === 'object' ? 'j:' + JSON.stringify(value) : String(value)\n\n    const options = { ...opts }\n    if (options.maxAge) {\n      options.expires = new Date(Date.now() + options.maxAge)\n      options.maxAge /= 1000\n    }\n\n    if (options.path == null) {\n      options.path = '/'\n    }\n\n    this.headers.append(\n      'Set-Cookie',\n      cookie.serialize(name, String(val), options)\n    )\n    return this\n  }\n\n  public clearCookie(name: string, opts: CookieSerializeOptions = {}) {\n    return this.cookie(name, '', { expires: new Date(1), path: '/', ...opts })\n  }\n\n  static json(body: any) {\n    return new NextResponse(JSON.stringify(body), {\n      headers: { 'content-type': 'application/json' },\n    })\n  }\n\n  static redirect(url: string | NextURL | URL, status = 307) {\n    if (!REDIRECTS.has(status)) {\n      throw new RangeError(\n        'Failed to execute \"redirect\" on \"response\": Invalid status code'\n      )\n    }\n\n    const destination = validateURL(url)\n    return new NextResponse(destination, {\n      headers: { Location: destination },\n      status,\n    })\n  }\n\n  static rewrite(destination: string | NextURL) {\n    return new NextResponse(null, {\n      headers: {\n        'x-middleware-rewrite': validateURL(destination),\n      },\n    })\n  }\n\n  static next() {\n    return new NextResponse(null, {\n      headers: {\n        'x-middleware-next': '1',\n      },\n    })\n  }\n}\n\ninterface ResponseInit extends globalThis.ResponseInit {\n  nextConfig?: {\n    basePath?: string\n    i18n?: I18NConfig\n    trailingSlash?: boolean\n  }\n  url?: string\n}\n"],"names":["INTERNALS","Symbol","REDIRECTS","Set","NextResponse","Response","body","init","cookieParser","value","headers","get","parse","url","basePath","nextConfig","i18n","trailingSlash","undefined","cookies","cookie","name","opts","val","JSON","stringify","String","options","maxAge","expires","Date","now","path","append","serialize","clearCookie","json","redirect","status","has","RangeError","destination","Location","rewrite","next"],"mappings":";;;;AACwB,GAAa,CAAb,QAAa;AACM,GAAU,CAAV,MAAU;AAClC,GAA2B,CAA3B,OAA2B;;;;;;AAG9C,KAAK,CAACA,SAAS,GAAGC,MAAM,CAAC,CAAmB;AAC5C,KAAK,CAACC,SAAS,GAAG,GAAG,CAACC,GAAG,CAAC,CAAC;AAAA,OAAG;AAAE,OAAG;AAAE,OAAG;AAAE,OAAG;AAAE,OAAG;AAAA,CAAC;MAEtCC,YAAY,SAASC,QAAQ;gBAM5BC,IAAsB,EAAEC,IAAkB,GAAG,CAAC,CAAC,CAAE,CAAC;YAY1CA,GAAe,EACnBA,IAAe,EACNA,IAAe;QAbtC,KAAK,CAACD,IAAI,EAAEC,IAAI;QAEhB,KAAK,CAACC,YAAY,OAAS,CAAC;YAC1B,KAAK,CAACC,KAAK,GAAG,IAAI,CAACC,OAAO,CAACC,GAAG,CAAC,CAAQ;YACvC,MAAM,CAACF,KAAK,GAjBC,OAA2B,SAiBlBG,KAAK,CAACH,KAAK,IAAI,CAAC,CAAC;QACzC,CAAC;QAED,IAAI,CAACT,SAAS,IAAI,CAAC;YACjBQ,YAAY;YACZK,GAAG,EAAEN,IAAI,CAACM,GAAG,GACT,GAAG,CAzBW,QAAa,SAyBfN,IAAI,CAACM,GAAG,EAAE,CAAC;gBACrBC,QAAQ,GAAEP,GAAe,GAAfA,IAAI,CAACQ,UAAU,cAAfR,GAAe,KAAfA,IAAI,CAAJA,CAAyB,GAAzBA,IAAI,CAAJA,CAAyB,GAAzBA,GAAe,CAAEO,QAAQ;gBACnCE,IAAI,GAAET,IAAe,GAAfA,IAAI,CAACQ,UAAU,cAAfR,IAAe,KAAfA,IAAI,CAAJA,CAAqB,GAArBA,IAAI,CAAJA,CAAqB,GAArBA,IAAe,CAAES,IAAI;gBAC3BC,aAAa,GAAEV,IAAe,GAAfA,IAAI,CAACQ,UAAU,cAAfR,IAAe,KAAfA,IAAI,CAAJA,CAA8B,GAA9BA,IAAI,CAAJA,CAA8B,GAA9BA,IAAe,CAAEU,aAAa;gBAC7CP,OAAO,MA5BwB,MAAU,gBA4BlB,IAAI,CAACA,OAAO;YACrC,CAAC,IACDQ,SAAS;QACf,CAAC;IACH,CAAC;QAEUC,OAAO,GAAG,CAAC;QACpB,MAAM,CAAC,IAAI,CAACnB,SAAS,EAAEQ,YAAY;IACrC,CAAC;IAEMY,MAAM,CACXC,IAAY,EACZZ,KAAsC,EACtCa,IAA4B,GAAG,CAAC,CAAC,EACjC,CAAC;QACD,KAAK,CAACC,GAAG,GACP,MAAM,CAACd,KAAK,KAAK,CAAQ,UAAG,CAAI,MAAGe,IAAI,CAACC,SAAS,CAAChB,KAAK,IAAIiB,MAAM,CAACjB,KAAK;QAEzE,KAAK,CAACkB,OAAO,GAAG,CAAC;eAAIL,IAAI;QAAC,CAAC;QAC3B,EAAE,EAAEK,OAAO,CAACC,MAAM,EAAE,CAAC;YACnBD,OAAO,CAACE,OAAO,GAAG,GAAG,CAACC,IAAI,CAACA,IAAI,CAACC,GAAG,KAAKJ,OAAO,CAACC,MAAM;YACtDD,OAAO,CAACC,MAAM,IAAI,IAAI;QACxB,CAAC;QAED,EAAE,EAAED,OAAO,CAACK,IAAI,IAAI,IAAI,EAAE,CAAC;YACzBL,OAAO,CAACK,IAAI,GAAG,CAAG;QACpB,CAAC;QAED,IAAI,CAACtB,OAAO,CAACuB,MAAM,CACjB,CAAY,aAxDC,OAA2B,SAyDjCC,SAAS,CAACb,IAAI,EAAEK,MAAM,CAACH,GAAG,GAAGI,OAAO;QAE7C,MAAM,CAAC,IAAI;IACb,CAAC;IAEMQ,WAAW,CAACd,IAAY,EAAEC,IAA4B,GAAG,CAAC,CAAC,EAAE,CAAC;QACnE,MAAM,CAAC,IAAI,CAACF,MAAM,CAACC,IAAI,EAAE,CAAE,GAAE,CAAC;YAACQ,OAAO,EAAE,GAAG,CAACC,IAAI,CAAC,CAAC;YAAGE,IAAI,EAAE,CAAG;eAAKV,IAAI;QAAC,CAAC;IAC3E,CAAC;WAEMc,IAAI,CAAC9B,IAAS,EAAE,CAAC;QACtB,MAAM,CAAC,GAAG,CAACF,YAAY,CAACoB,IAAI,CAACC,SAAS,CAACnB,IAAI,GAAG,CAAC;YAC7CI,OAAO,EAAE,CAAC;gBAAC,CAAc,eAAE,CAAkB;YAAC,CAAC;QACjD,CAAC;IACH,CAAC;WAEM2B,QAAQ,CAACxB,GAA2B,EAAEyB,MAAM,GAAG,GAAG,EAAE,CAAC;QAC1D,EAAE,GAAGpC,SAAS,CAACqC,GAAG,CAACD,MAAM,GAAG,CAAC;YAC3B,KAAK,CAAC,GAAG,CAACE,UAAU,CAClB,CAAiE;QAErE,CAAC;QAED,KAAK,CAACC,WAAW,OAhFsB,MAAU,cAgFjB5B,GAAG;QACnC,MAAM,CAAC,GAAG,CAACT,YAAY,CAACqC,WAAW,EAAE,CAAC;YACpC/B,OAAO,EAAE,CAAC;gBAACgC,QAAQ,EAAED,WAAW;YAAC,CAAC;YAClCH,MAAM;QACR,CAAC;IACH,CAAC;WAEMK,OAAO,CAACF,WAA6B,EAAE,CAAC;QAC7C,MAAM,CAAC,GAAG,CAACrC,YAAY,CAAC,IAAI,EAAE,CAAC;YAC7BM,OAAO,EAAE,CAAC;gBACR,CAAsB,2BA1Fa,MAAU,cA0FT+B,WAAW;YACjD,CAAC;QACH,CAAC;IACH,CAAC;WAEMG,IAAI,GAAG,CAAC;QACb,MAAM,CAAC,GAAG,CAACxC,YAAY,CAAC,IAAI,EAAE,CAAC;YAC7BM,OAAO,EAAE,CAAC;gBACR,CAAmB,oBAAE,CAAG;YAC1B,CAAC;QACH,CAAC;IACH,CAAC;;QA9FUN,YAAY,GAAZA,YAAY"}