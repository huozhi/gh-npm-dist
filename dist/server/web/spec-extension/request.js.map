{"version":3,"sources":["../../../../server/web/spec-extension/request.ts"],"sourcesContent":["import type { I18NConfig } from '../../config-shared'\nimport type { RequestData } from '../types'\nimport { NextURL } from '../next-url'\nimport { isBot } from '../../utils'\nimport { toNodeHeaders } from '../utils'\nimport cookie from 'next/dist/compiled/cookie'\nimport parseua from 'next/dist/compiled/ua-parser-js'\n\nexport const INTERNALS = Symbol('internal request')\n\nexport class NextRequest extends Request {\n  [INTERNALS]: {\n    cookieParser(): { [key: string]: string }\n    geo: RequestData['geo']\n    ip?: string\n    page?: { name?: string; params?: { [key: string]: string } }\n    ua?: UserAgent | null\n    url: NextURL\n  }\n\n  constructor(input: Request | string, init: RequestInit = {}) {\n    super(input, init)\n\n    const cookieParser = () => {\n      const value = this.headers.get('cookie')\n      return value ? cookie.parse(value) : {}\n    }\n\n    this[INTERNALS] = {\n      cookieParser,\n      geo: init.geo || {},\n      ip: init.ip,\n      page: init.page,\n      url: new NextURL(typeof input === 'string' ? input : input.url, {\n        basePath: init.nextConfig?.basePath,\n        headers: toNodeHeaders(this.headers),\n        i18n: init.nextConfig?.i18n,\n        trailingSlash: init.nextConfig?.trailingSlash,\n      }),\n    }\n  }\n\n  public get cookies() {\n    return this[INTERNALS].cookieParser()\n  }\n\n  public get geo() {\n    return this[INTERNALS].geo\n  }\n\n  public get ip() {\n    return this[INTERNALS].ip\n  }\n\n  public get preflight() {\n    return this.headers.get('x-middleware-preflight')\n  }\n\n  public get nextUrl() {\n    return this[INTERNALS].url\n  }\n\n  public get page() {\n    return {\n      name: this[INTERNALS].page?.name,\n      params: this[INTERNALS].page?.params,\n    }\n  }\n\n  public get ua() {\n    if (typeof this[INTERNALS].ua !== 'undefined') {\n      return this[INTERNALS].ua || undefined\n    }\n\n    const uaString = this.headers.get('user-agent')\n    if (!uaString) {\n      this[INTERNALS].ua = null\n      return this[INTERNALS].ua || undefined\n    }\n\n    this[INTERNALS].ua = {\n      ...parseua(uaString),\n      isBot: isBot(uaString),\n    }\n\n    return this[INTERNALS].ua\n  }\n\n  public get url() {\n    return this[INTERNALS].url.toString()\n  }\n}\n\nexport interface RequestInit extends globalThis.RequestInit {\n  geo?: {\n    city?: string\n    country?: string\n    region?: string\n  }\n  ip?: string\n  nextConfig?: {\n    basePath?: string\n    i18n?: I18NConfig | null\n    trailingSlash?: boolean\n  }\n  page?: {\n    name?: string\n    params?: { [key: string]: string }\n  }\n}\n\ninterface UserAgent {\n  isBot: boolean\n  ua: string\n  browser: {\n    name?: string\n    version?: string\n  }\n  device: {\n    model?: string\n    type?: string\n    vendor?: string\n  }\n  engine: {\n    name?: string\n    version?: string\n  }\n  os: {\n    name?: string\n    version?: string\n  }\n  cpu: {\n    architecture?: string\n  }\n}\n"],"names":["INTERNALS","Symbol","NextRequest","Request","input","init","cookieParser","value","headers","get","parse","geo","ip","page","url","basePath","nextConfig","i18n","trailingSlash","cookies","preflight","nextUrl","name","params","ua","undefined","uaString","isBot","toString"],"mappings":"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"}