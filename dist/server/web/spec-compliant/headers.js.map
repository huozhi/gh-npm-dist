{"version":3,"sources":["../../../../server/web/spec-compliant/headers.ts"],"sourcesContent":["import { isIterable } from '../is'\n\nexport type HeadersInit = Headers | string[][] | { [key: string]: string }\n\nconst MAP = Symbol('map')\nconst INTERNAL = Symbol('internal')\nconst INVALID_TOKEN_REGEX = /[^^_`a-zA-Z\\-0-9!#$%&'*+.|~]/\nconst INVALID_HEADER_CHAR_REGEX = /[^\\t\\x20-\\x7e\\x80-\\xff]/\n\nclass BaseHeaders implements Headers {\n  [MAP]: { [k: string]: string[] } = {}\n\n  constructor(init?: HeadersInit) {\n    if (init instanceof BaseHeaders) {\n      const rawHeaders = init.raw()\n      for (const headerName of Object.keys(rawHeaders)) {\n        for (const value of rawHeaders[headerName]) {\n          this.append(headerName, value)\n        }\n      }\n    } else if (isIterable(init)) {\n      const pairs = []\n      for (const pair of init) {\n        if (!isIterable(pair)) {\n          throw new TypeError('Each header pair must be iterable')\n        }\n        pairs.push(Array.from(pair))\n      }\n\n      for (const pair of pairs) {\n        if (pair.length !== 2) {\n          throw new TypeError('Each header pair must be a name/value tuple')\n        }\n        this.append(pair[0], pair[1])\n      }\n    } else if (typeof init === 'object') {\n      for (const key of Object.keys(init)) {\n        this.append(key, init[key])\n      }\n    } else if (init) {\n      throw new TypeError('Provided initializer must be an object')\n    }\n  }\n\n  get(name: string) {\n    const _name = `${name}`\n    validateName(_name)\n    const key = find(this[MAP], _name)\n    if (key === undefined) {\n      return null\n    }\n\n    return this[MAP][key].join(', ')\n  }\n\n  forEach(\n    callback: (value: string, name: string, parent: BaseHeaders) => void,\n    thisArg: any = undefined\n  ): void {\n    let pairs = getHeaders(this)\n    let i = 0\n    while (i < pairs.length) {\n      const [name, value] = pairs[i]\n      callback.call(thisArg, value, name, this)\n      pairs = getHeaders(this)\n      i++\n    }\n  }\n\n  set(name: string, value: string) {\n    name = `${name}`\n    value = `${value}`\n    validateName(name)\n    validateValue(value)\n    const key = find(this[MAP], name)\n    this[MAP][key !== undefined ? key : name] = [value]\n  }\n\n  append(name: string, value: string) {\n    name = `${name}`\n    value = `${value}`\n    validateName(name)\n    validateValue(value)\n    const key = find(this[MAP], name)\n    if (key !== undefined) {\n      this[MAP][key].push(value)\n    } else {\n      this[MAP][name] = [value]\n    }\n  }\n\n  has(name: string) {\n    name = `${name}`\n    validateName(name)\n    return find(this[MAP], name) !== undefined\n  }\n\n  delete(name: string) {\n    name = `${name}`\n    validateName(name)\n    const key = find(this[MAP], name)\n    if (key !== undefined) {\n      delete this[MAP][key]\n    }\n  }\n\n  raw() {\n    return this[MAP]\n  }\n\n  keys() {\n    return createHeadersIterator(this, 'key')\n  }\n\n  values() {\n    return createHeadersIterator(this, 'value')\n  }\n\n  entries() {\n    return createHeadersIterator(this, 'key+value')\n  }\n\n  [Symbol.iterator]() {\n    return createHeadersIterator(this, 'key+value')\n  }\n}\n\nfunction createHeadersIterator(\n  target: BaseHeaders,\n  kind: 'key' | 'value' | 'key+value'\n) {\n  const iterator = Object.create(HeadersIteratorPrototype)\n  iterator[INTERNAL] = {\n    target,\n    kind,\n    index: 0,\n  }\n  return iterator\n}\n\nfunction validateName(name: string) {\n  name = `${name}`\n  if (INVALID_TOKEN_REGEX.test(name)) {\n    throw new TypeError(`${name} is not a legal HTTP header name`)\n  }\n}\n\nfunction validateValue(value: string) {\n  value = `${value}`\n  if (INVALID_HEADER_CHAR_REGEX.test(value)) {\n    throw new TypeError(`${value} is not a legal HTTP header value`)\n  }\n}\n\nfunction find(\n  map: { [k: string]: string[] },\n  name: string\n): string | undefined {\n  name = name.toLowerCase()\n  for (const key in map) {\n    if (key.toLowerCase() === name) {\n      return key\n    }\n  }\n  return undefined\n}\n\nObject.defineProperty(BaseHeaders.prototype, Symbol.toStringTag, {\n  value: 'Headers',\n  writable: false,\n  enumerable: false,\n  configurable: true,\n})\n\nObject.defineProperties(BaseHeaders.prototype, {\n  append: { enumerable: true },\n  delete: { enumerable: true },\n  entries: { enumerable: true },\n  forEach: { enumerable: true },\n  get: { enumerable: true },\n  has: { enumerable: true },\n  keys: { enumerable: true },\n  raw: { enumerable: false },\n  set: { enumerable: true },\n  values: { enumerable: true },\n})\n\nfunction getHeaders(\n  headers: BaseHeaders,\n  kind: 'key' | 'value' | 'key+value' = 'key+value'\n) {\n  const fn =\n    kind === 'key'\n      ? (key: string) => key.toLowerCase()\n      : kind === 'value'\n      ? (key: string) => headers[MAP][key].join(', ')\n      : (key: string) => [key.toLowerCase(), headers[MAP][key].join(', ')]\n\n  return Object.keys(headers[MAP])\n    .sort()\n    .map((key) => fn(key))\n}\n\nconst HeadersIteratorPrototype = Object.setPrototypeOf(\n  {\n    next() {\n      if (!this || Object.getPrototypeOf(this) !== HeadersIteratorPrototype) {\n        throw new TypeError('Value of `this` is not a HeadersIterator')\n      }\n\n      const { target, kind, index } = this[INTERNAL]\n      const values = getHeaders(target, kind)\n      const len = values.length\n      if (index >= len) {\n        return {\n          value: undefined,\n          done: true,\n        }\n      }\n\n      this[INTERNAL].index = index + 1\n\n      return {\n        value: values[index],\n        done: false,\n      }\n    },\n  },\n  Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]()))\n)\n\nObject.defineProperty(HeadersIteratorPrototype, Symbol.toStringTag, {\n  value: 'HeadersIterator',\n  writable: false,\n  enumerable: false,\n  configurable: true,\n})\n\nexport { BaseHeaders as Headers }\n"],"names":["MAP","Symbol","INTERNAL","INVALID_TOKEN_REGEX","INVALID_HEADER_CHAR_REGEX","BaseHeaders","init","rawHeaders","raw","headerName","Object","keys","value","append","pairs","pair","TypeError","push","Array","from","length","key","get","name","_name","validateName","find","undefined","join","forEach","callback","thisArg","getHeaders","i","call","set","validateValue","has","delete","createHeadersIterator","values","entries","iterator","target","kind","create","HeadersIteratorPrototype","index","test","map","toLowerCase","defineProperty","prototype","toStringTag","writable","enumerable","configurable","defineProperties","headers","fn","sort","setPrototypeOf","next","getPrototypeOf","len","done","Headers"],"mappings":"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"}