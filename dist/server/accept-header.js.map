{"version":3,"sources":["../../server/accept-header.ts"],"sourcesContent":["export function acceptLanguage(header = '', preferences?: string[]) {\n  return (\n    parse(header, preferences, {\n      type: 'accept-language',\n      prefixMatch: true,\n    })[0] || ''\n  )\n}\n\ninterface Selection {\n  pos: number\n  pref?: number\n  q: number\n  token: string\n}\n\ninterface Options {\n  prefixMatch?: boolean\n  type: 'accept-language'\n}\n\nfunction parse(\n  raw: string,\n  preferences: string[] | undefined,\n  options: Options\n) {\n  const lowers = new Map<string, { orig: string; pos: number }>()\n  const header = raw.replace(/[ \\t]/g, '')\n\n  if (preferences) {\n    let pos = 0\n    for (const preference of preferences) {\n      const lower = preference.toLowerCase()\n      lowers.set(lower, { orig: preference, pos: pos++ })\n      if (options.prefixMatch) {\n        const parts = lower.split('-')\n        while ((parts.pop(), parts.length > 0)) {\n          const joined = parts.join('-')\n          if (!lowers.has(joined)) {\n            lowers.set(joined, { orig: preference, pos: pos++ })\n          }\n        }\n      }\n    }\n  }\n\n  const parts = header.split(',')\n  const selections: Selection[] = []\n  const map = new Set<string>()\n\n  for (let i = 0; i < parts.length; ++i) {\n    const part = parts[i]\n    if (!part) {\n      continue\n    }\n\n    const params = part.split(';')\n    if (params.length > 2) {\n      throw new Error(`Invalid ${options.type} header`)\n    }\n\n    let token = params[0].toLowerCase()\n    if (!token) {\n      throw new Error(`Invalid ${options.type} header`)\n    }\n\n    const selection: Selection = { token, pos: i, q: 1 }\n    if (preferences && lowers.has(token)) {\n      selection.pref = lowers.get(token)!.pos\n    }\n\n    map.add(selection.token)\n\n    if (params.length === 2) {\n      const q = params[1]\n      const [key, value] = q.split('=')\n\n      if (!value || (key !== 'q' && key !== 'Q')) {\n        throw new Error(`Invalid ${options.type} header`)\n      }\n\n      const score = parseFloat(value)\n      if (score === 0) {\n        continue\n      }\n\n      if (Number.isFinite(score) && score <= 1 && score >= 0.001) {\n        selection.q = score\n      }\n    }\n\n    selections.push(selection)\n  }\n\n  selections.sort((a, b) => {\n    if (b.q !== a.q) {\n      return b.q - a.q\n    }\n\n    if (b.pref !== a.pref) {\n      if (a.pref === undefined) {\n        return 1\n      }\n\n      if (b.pref === undefined) {\n        return -1\n      }\n\n      return a.pref - b.pref\n    }\n\n    return a.pos - b.pos\n  })\n\n  const values = selections.map((selection) => selection.token)\n  if (!preferences || !preferences.length) {\n    return values\n  }\n\n  const preferred: string[] = []\n  for (const selection of values) {\n    if (selection === '*') {\n      for (const [preference, value] of lowers) {\n        if (!map.has(preference)) {\n          preferred.push(value.orig)\n        }\n      }\n    } else {\n      const lower = selection.toLowerCase()\n      if (lowers.has(lower)) {\n        preferred.push(lowers.get(lower)!.orig)\n      }\n    }\n  }\n\n  return preferred\n}\n"],"names":["acceptLanguage","header","preferences","parse","type","prefixMatch","raw","options","lowers","Map","replace","pos","preference","lower","toLowerCase","set","orig","parts","split","pop","length","joined","join","has","selections","map","Set","i","part","params","Error","token","selection","q","pref","get","add","key","value","score","parseFloat","Number","isFinite","push","sort","a","b","undefined","values","preferred"],"mappings":"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"}