{"version":3,"sources":["../../../../shared/lib/i18n/get-locale-metadata.ts"],"sourcesContent":["import { acceptLanguage } from '../../../server/accept-header'\nimport { denormalizePagePath } from '../../../server/denormalize-page-path'\nimport { detectDomainLocale } from './detect-domain-locale'\nimport { formatUrl } from '../router/utils/format-url'\nimport { normalizeLocalePath } from './normalize-locale-path'\nimport type { I18NConfig, DomainLocale } from '../../../server/config-shared'\n\ninterface Params {\n  cookies(): { [key: string]: string }\n  headers?: { [key: string]: string | string[] | undefined }\n  nextConfig: { basePath?: string; i18n: I18NConfig; trailingSlash?: boolean }\n  url: { hostname?: string | null; pathname: string }\n}\n\nexport function getLocaleMetadata(params: Params) {\n  const { i18n } = params.nextConfig\n  const { cookies, headers, nextConfig, url } = params\n  const path = normalizeLocalePath(url.pathname, i18n.locales)\n  const domain = detectDomainLocale(i18n.domains, getHostname(url, headers))\n  const defaultLocale = domain?.defaultLocale || i18n.defaultLocale\n  const preferredLocale = getAcceptPreferredLocale(i18n, headers)\n  return {\n    path,\n    domain,\n    defaultLocale,\n    locale: path?.detectedLocale || defaultLocale,\n    redirect: getRedirect({\n      locale: {\n        preferred: preferredLocale,\n        default: defaultLocale,\n        detected:\n          path?.detectedLocale ||\n          domain?.defaultLocale ||\n          getLocaleFromCookie(i18n, cookies) ||\n          preferredLocale ||\n          i18n.defaultLocale,\n      },\n      domain,\n      nextConfig,\n      url,\n    }),\n    trailingSlash:\n      url.pathname !== '/'\n        ? url.pathname.endsWith('/')\n        : nextConfig.trailingSlash,\n  }\n}\n\nfunction getLocaleFromCookie(\n  i18n: I18NConfig,\n  cookies: () => { [key: string]: string }\n) {\n  const nextLocale = cookies()?.NEXT_LOCALE?.toLowerCase()\n  return nextLocale\n    ? i18n.locales.find((locale) => nextLocale === locale.toLowerCase())\n    : undefined\n}\n\nfunction getAcceptPreferredLocale(\n  i18n: I18NConfig,\n  headers?: { [key: string]: string | string[] | undefined }\n) {\n  const value = headers?.['accept-language']\n  if (i18n.localeDetection !== false && value && !Array.isArray(value)) {\n    try {\n      return acceptLanguage(value, i18n.locales)\n    } catch (err) {}\n  }\n}\n\nfunction getHostname(\n  parsed: { hostname?: string | null },\n  headers?: { [key: string]: string | string[] | undefined }\n) {\n  return ((!Array.isArray(headers?.host) && headers?.host) || parsed.hostname)\n    ?.split(':')[0]\n    .toLowerCase()\n}\n\nfunction getRedirect({\n  domain,\n  locale,\n  nextConfig,\n  url,\n}: {\n  domain?: DomainLocale\n  locale: { default: string; detected: string; preferred?: string }\n  nextConfig: { basePath?: string; i18n: I18NConfig; trailingSlash?: boolean }\n  url: { hostname?: string | null; pathname: string }\n}) {\n  const isRootPath = denormalizePagePath(url.pathname) === '/'\n  if (nextConfig.i18n.localeDetection !== false && isRootPath) {\n    const preferredDomain = detectDomainLocale(\n      nextConfig.i18n.domains,\n      undefined,\n      locale.preferred\n    )\n\n    if (domain && preferredDomain) {\n      const isPDomain = preferredDomain.domain === domain.domain\n      const isPLocale = preferredDomain.defaultLocale === locale.preferred\n      if (!isPDomain || !isPLocale) {\n        const scheme = `http${preferredDomain.http ? '' : 's'}`\n        const rlocale = isPLocale ? '' : locale.preferred\n        return `${scheme}://${preferredDomain.domain}/${rlocale}`\n      }\n    }\n\n    if (locale.detected.toLowerCase() !== locale.default.toLowerCase()) {\n      return formatUrl({\n        ...url,\n        pathname: `${nextConfig.basePath || ''}/${locale.detected}`,\n      })\n    }\n  }\n}\n"],"names":["getLocaleMetadata","params","i18n","nextConfig","cookies","headers","url","path","pathname","locales","domain","domains","getHostname","defaultLocale","preferredLocale","getAcceptPreferredLocale","locale","detectedLocale","redirect","getRedirect","preferred","default","detected","getLocaleFromCookie","trailingSlash","endsWith","nextLocale","NEXT_LOCALE","toLowerCase","find","undefined","value","localeDetection","Array","isArray","err","parsed","host","hostname","split","isRootPath","preferredDomain","isPDomain","isPLocale","scheme","http","rlocale","basePath"],"mappings":"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"}